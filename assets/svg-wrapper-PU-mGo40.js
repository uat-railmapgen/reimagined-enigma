import{j as M}from"./chakra-C3T8NphC.js";import{l as G,o as V,an as Et,ao as Pt,e as St,a as et,ap as R,aq as Z,ar as st,a9 as Q,as as ht,at as pt,au as F,t as ut,v as it,S as It,av as gt,n as tt,m as Ct,p as xt,r as nt,E as ot,w as ct,y as at,aa as U,aw as Nt,ax as Dt,D as Mt,X as _t,A as rt,z as mt,a2 as H,af as jt,ah as Tt}from"./index-3YJdDK1u.js";import{b as D}from"./react-DV6nCJb6.js";import{u as z,e as Kt,i as Lt}from"./clipboard-kkM5fu_B.js";import{s as ft,u as Wt,f as Bt,F as $t,l as zt,b as Ot,c as Yt}from"./stations-BvwdsnXi.js";import{m as yt}from"./misc-nodes-OGd04Ye2.js";const wt=(t,s,x,f,n,u,y)=>{if(!("offsetFrom"in y)||!("offsetTo"in y)||Number.isNaN(y.offsetFrom)||Number.isNaN(y.offsetTo))return;if(y.offsetFrom===y.offsetTo)return vt(s,x,f,n,u)?{x1:x,y1:f,x2:n,y2:u,offset:y.offsetFrom}:void 0;const[m,o]=[y.offsetFrom,y.offsetTo];for(let l=0;l<Math.PI;l+=Math.PI/8)for(let r=l,h=0;h<2;h++,r+=Math.PI){const[b,v,p,P]=[Math.sin(l)*m,Math.cos(l)*m,Math.sin(r)*o,Math.cos(r)*o];if(vt(s,x+b,f+v,n+p,u+P))return{x1:x+b,y1:f+v,x2:n+p,y2:u+P,offset:0}}},vt=(t,s,x,f,n)=>!!((s===f||x===n)&&[G.Diagonal,G.Perpendicular].includes(t)||Math.abs((n-x)/(f-s))===1&&[G.Diagonal,G.RotatePerpendicular].includes(t)),Xt=(t,s)=>{const x=[],f=[];return Object.values(s).forEach(n=>{var O;if(n.length===1){f.push(...n.map(c=>c.edge));return}const u=t.getEdgeAttribute(n.at(0),"type");if(!n.every(c=>t.getEdgeAttribute(c,"type")===u)){f.push(...n.map(c=>c.edge));return}const y=t.getEdgeAttribute(n.at(0),"style");if(!n.every(c=>t.getEdgeAttribute(c,"style")===y)){f.push(...n.map(c=>c.edge));return}const m={},o=new Set,l=new Set,r=Object.fromEntries(n.map(c=>{var J,q;const[I,K]=t.extremities(c);return m[I]=((J=m[I])!=null?J:0)+1,m[K]=((q=m[K])!=null?q:0)+1,o.add(I),l.add(K),[I,[c.edge,K]]})),h=Array.from(o).filter(c=>m[c]===1),b=Array.from(l).filter(c=>m[c]===1);if(h.length!==1||b.length!==1){f.push(...n.map(c=>c.edge));return}const v=h[0],p=b[0];if(v===p){f.push(...n.map(c=>c.edge));return}const P=[r[v][0]];let A=r[v][1];for(let c=1;c<n.length;c=c+1){const I=(O=r[A])==null?void 0:O.at(1);if(!I){f.push(...n.map(K=>K.edge));return}P.push(r[A][0]),A=I}if(A!==p||P.length!==n.length){f.push(...n.map(c=>c.edge));return}x.push(P)}),{allReconciledLines:x,danglingLines:f}},Vt=(t,s)=>{if(!s.every(n=>t.hasEdge(n)))return;const x=s.map(n=>{var b,v,p;const[u,y]=t.extremities(n),m=t.getNodeAttributes(u),o=t.getNodeAttributes(y),l=t.getEdgeAttribute(n,"type"),r=(b=t.getEdgeAttribute(n,l))!=null?b:V[l].defaultAttrs,h=wt(n,l,m.x,m.y,o.x,o.y,r);if(h){const{x1:P,y1:A,x2:O,y2:c,offset:I}=h;return V[G.Simple].generatePath(P,O,A,c,{offset:I})}return(p=(v=V[l])==null?void 0:v.generatePath(m.x,o.x,m.y,o.y,r))!=null?p:"M ".concat(m.x," ").concat(m.y," L ").concat(o.x," ").concat(o.y)});let f="".concat(x[0]," ");for(let n=1;n<s.length;n=n+1)f+=x[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return f},Ft=t=>[...t.nodeEntries()].map(s=>s.node.startsWith("stn")?{id:s.node,type:"station",station:s.attributes}:{id:s.node,type:"misc-node",miscNode:s.attributes}),Ut=t=>{const s={},x=[],f={},n=[];for(const o of t.edgeEntries()){const[l,r,h,b]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],v=wt(o.edge,o.attributes.type,l,r,h,b,o.attributes[o.attributes.type]);if(!v){if(o.attributes.parallelIndex>=0){x.push(o);continue}}if(o.attributes.reconcileId!==""){const p=o.attributes.reconcileId;p in f?f[p].push(o):f[p]=[o];continue}if(v){const p=o.edge,P=o.attributes,{x1:A,y1:O,x2:c,y2:I,offset:K}=v;s[p]={id:p,attr:P,path:V[G.Simple].generatePath(A,c,O,I,{offset:K})};continue}n.push(o)}const u=new Set;for(;x.length;){const o=x.pop();if(u.has(o.edge))continue;const{normal:l,parallel:r}=Et(t,o);if(!r.length)continue;r.forEach(b=>u.add(b.edge)),n.push(...l);const h=Pt(r);for(const b of r){const v=b.edge;s[v]={id:b.edge,attr:b.attributes,path:h[v]}}}const{allReconciledLines:y,danglingLines:m}=Xt(t,f);for(const o of y){const l=Vt(t,o);if(!l)continue;const r=o[0];s[r]={id:r,attr:t.getEdgeAttributes(r),path:l}}for(const o of m){const l=t.getEdgeAttributes(o),[r,h]=t.extremities(o),b=t.getNodeAttributes(r),v=t.getNodeAttributes(h);s[o]={id:o,attr:l,path:V[G.Simple].generatePath(b.x,v.x,b.y,v.y,V[G.Simple].defaultAttrs)}}for(const o of n){const l=o.edge,r=o.attributes.type,h=o.attributes,[b,v,p,P]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(r in V)){s[l]={id:l,attr:h,path:"M ".concat(b," ").concat(v," L ").concat(p," ").concat(P)};continue}s[l]={id:l,attr:h,path:V[r].generatePath(b,p,v,P,h[r])}}return Object.values(s).map(o=>({id:o.id,type:"line",line:o}))},bt=t=>{switch(t.type){case"line":return t.line.attr.zIndex;case"station":return t.station.zIndex;case"misc-node":return t.miscNode.zIndex}},At=t=>{const{id:s,x,y:f,handlePointerDown:n,handlePointerMove:u,handlePointerUp:y}=t,m=D.useCallback(r=>n(s,r),[s,n]),o=D.useCallback(r=>u(s,r),[s,u]),l=D.useCallback(r=>y(s,r),[s,y]);return M.jsx("g",{id:s,transform:"translate(".concat(x-6.4," ").concat(f-6.4,")scale(0.025)"),onPointerDown:m,onPointerMove:o,onPointerUp:l,style:{cursor:"move"},children:M.jsx("path",{id:"stn_core_".concat(s),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Rt=t=>{const{id:s,path:x,handlePointerDown:f}=t,n=D.useCallback(u=>f(s,u),[s,f]);return M.jsx("path",{id:s,d:x,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:n})},Zt=()=>{const t=St(),s=D.useRef(window.graph),x=()=>{t(ut()),t(it()),t(ct(s.current.export()))},{telemetry:{project:f},preference:{autoParallel:n}}=et(a=>a.app),{svgViewBoxZoom:u,svgViewBoxMin:y}=et(a=>a.param),{selected:m,refresh:{nodes:o,edges:l},mode:r,active:h,keepLastPath:b,theme:v}=et(a=>a.runtime),[p,P]=D.useState({x:0,y:0}),[A,O]=D.useState({x:0,y:0}),c=z((a,S)=>{S.stopPropagation(),r==="select"&&t(R("free"));const _=S.currentTarget,{x:j,y:L}=Z(S);_.setPointerCapture(S.pointerId),P({x:j,y:L}),t(st(a)),S.shiftKey?m.has(a)?t(ht(a)):t(pt(a)):m.has(a)||t(Q(new Set([a])))}),I=z((a,S)=>{const{x:_,y:j}=Z(S);r==="free"&&h===a?(m.forEach(L=>{s.current.hasNode(L)&&s.current.updateNodeAttributes(L,C=>({...C,x:F(C.x-(p.x-_)*u/100,S.altKey?1:5),y:F(C.y-(p.y-j)*u/100,S.altKey?1:5)}))}),t(ut()),t(it())):r.startsWith("line")&&O({x:(p.x-_)*u/100,y:(p.y-j)*u/100})}),K=z((a,S)=>{if(r.startsWith("line")){b||t(R("free"));const _=[...Object.values(It),gt.Virtual,gt.Master],j=s.current.hasNode(h)&&_.includes(s.current.getNodeAttribute(h,"type"));["stn_core_","virtual_circle_"].forEach(C=>{var $,T;const k=(T=($=document.elementsFromPoint(S.clientX,S.clientY)[0].attributes)==null?void 0:$.getNamedItem("id"))==null?void 0:T.value,W=k==null?void 0:k.startsWith(C);if(j&&W){const Y=r.slice(5),e="line_".concat(tt(10)),[i,d]=[h,k.slice(C.length)],E=n?Ct(s.current,Y,i,d,"from"):-1;s.current.addDirectedEdgeWithKey(e,i,d,{visible:!0,zIndex:0,type:Y,[Y]:structuredClone(V[Y].defaultAttrs),style:xt.SingleColor,[xt.SingleColor]:{color:v},reconcileId:"",parallelIndex:E}),f&&nt.event(ot.ADD_LINE,{type:Y})}}),t(it()),t(ct(s.current.export()))}else if(r==="free"&&h){const{x:_,y:j}=Z(S);p.x-_===0&&p.y-j===0||t(ct(s.current.export()))}t(st(void 0))}),J=z((a,S)=>{if(S.stopPropagation(),S.shiftKey||t(at()),S.shiftKey&&m.has(a)?t(ht(a)):t(pt(a)),r.startsWith("station")||r.startsWith("misc-node-virtual")||r.startsWith("misc-node-master")){const _=S.clientX-document.getElementById("canvas").getBoundingClientRect().left,j=S.clientY-document.getElementById("canvas").getBoundingClientRect().top,L=r.startsWith("station"),C=tt(10),B=L?"stn_".concat(C):"misc_node_".concat(C),k=L?r.slice(8):r.slice(10),{x:W,y:$}=U(_,j,u,y),T=L?structuredClone(ft[k].defaultAttrs):structuredClone(yt[k].defaultAttrs);"color"in T&&(T.color=v),s.current.addNode(B,{visible:!0,zIndex:0,x:F(W,5),y:F($,5),type:k,[k]:T});const Y=s.current.getEdgeAttributes(a),{zIndex:e,type:i,style:d}=Y,E=Y[i],w=Y[d],[g,N]=s.current.extremities(a),X=n?0:-1;s.current.addDirectedEdgeWithKey("line_".concat(tt(10)),g,B,{visible:!0,zIndex:e,type:i,[i]:structuredClone(E),style:d,[d]:structuredClone(w),reconcileId:"",parallelIndex:X}),s.current.addDirectedEdgeWithKey("line_".concat(tt(10)),B,N,{visible:!0,zIndex:e,type:i,[i]:structuredClone(E),style:d,[d]:structuredClone(w),reconcileId:"",parallelIndex:X}),s.current.dropEdge(a),x(),f&&(nt.event(ot.ADD_STATION,{type:k}),nt.event(ot.ADD_LINE,{type:i})),t(R("free")),t(Q(new Set([B])))}}),q=D.useMemo(()=>[...Ut(s.current),...Ft(s.current)].sort((a,S)=>bt(a)-bt(S)),[l,o]),dt=Dt.component;return M.jsxs(M.Fragment,{children:[q.map(a=>{var S,_,j,L,C,B;if(a.type==="line"){const k=a.line.attr.type,W=a.line.attr.style,$=a.line.attr[W],T=(_=(S=Nt[W])==null?void 0:S.component)!=null?_:Rt;return M.jsx(T,{id:a.id,type:k,path:a.line.path,styleAttrs:$,newLine:!1,handlePointerDown:J},a.id)}else if(a.type==="station"){const k=a.station,W=k.type,$=(L=(j=ft[W])==null?void 0:j.component)!=null?L:At;return M.jsx($,{id:a.id,x:k.x,y:k.y,attrs:k,handlePointerDown:c,handlePointerMove:I,handlePointerUp:K},a.id)}else if(a.type==="misc-node"){const k=a.miscNode,W=k.type,$=(B=(C=yt[W])==null?void 0:C.component)!=null?B:At;return M.jsx($,{id:a.id,x:k.x,y:k.y,attrs:k[W],handlePointerDown:c,handlePointerMove:I,handlePointerUp:K},a.id)}}),r.startsWith("line")&&h&&h!=="background"&&M.jsx(dt,{id:"line_create_in_progress___no_use",type:r.slice(5),path:V[r.slice(5)].generatePath(s.current.getNodeAttribute(h,"x"),s.current.getNodeAttribute(h,"x")-A.x,s.current.getNodeAttribute(h,"y"),s.current.getNodeAttribute(h,"y")-A.y,V[r.slice(5)].defaultAttrs),styleAttrs:{color:v},newLine:!0,handlePointerDown:()=>{}})]})},ee=()=>{const t=St(),s=D.useRef(window.graph),x=()=>{t(ut()),t(it()),t(ct(s.current.export()))},{telemetry:{project:f}}=et(e=>e.app),{svgViewBoxZoom:n,svgViewBoxMin:u}=et(e=>e.param),{mode:y,lastTool:m,active:o,selected:l,keepLastPath:r,theme:h,refresh:{nodes:b}}=et(e=>e.runtime),v=Wt(),{height:p,width:P}=Mt(v);D.useEffect(()=>{const e=Bt(s.current);Object.entries(e).filter(([i,d])=>d&&i in $t).forEach(([i])=>zt(i))},[b]);const[A,O]=D.useState({x:0,y:0}),[c,I]=D.useState({x:0,y:0}),[K,J]=D.useState({x:0,y:0}),[q,dt]=D.useState({x:0,y:0}),a=z(e=>{const{x:i,y:d}=Z(e);if(y.startsWith("station")){t(R("free"));const E=tt(10),w="stn_".concat(E),g=y.slice(8),N=structuredClone(ft[g].defaultAttrs);"color"in N&&(N.color=h);const{x:X,y:lt}=U(i,d,n,u);s.current.addNode(w,{visible:!0,zIndex:0,x:F(X,5),y:F(lt,5),type:g,[g]:N}),x(),f&&nt.event(ot.ADD_STATION,{type:g}),t(Q(new Set([w])))}else if(y.startsWith("misc-node")){t(R("free"));const E=tt(10),w="misc_node_".concat(E),g=y.slice(10),{x:N,y:X}=U(i,d,n,u);s.current.addNode(w,{visible:!0,zIndex:0,x:F(N,5),y:F(X,5),type:g,[g]:structuredClone(yt[g].defaultAttrs)}),x(),f&&nt.event(ot.ADD_STATION,{type:g}),t(Q(new Set([w])))}else y==="free"||y.startsWith("line")?(y.startsWith("line")&&(t(R("free")),r&&t(_t(!1))),J({x:i,y:d}),dt(u),e.shiftKey||(t(st("background")),t(at()))):y==="select"&&(O(U(i,d,n,u)),I(U(i,d,n,u)))}),S=z(e=>{if(y==="select"){if(A.x!=0&&A.y!=0){const{x:i,y:d}=Z(e);I(U(i,d,n,u))}}else if(o==="background"){const{x:i,y:d}=Z(e);t(rt({x:q.x+(K.x-i)*n/100,y:q.y+(K.y-d)*n/100}))}}),_=z(e=>{if(y==="select"){const{x:i,y:d}=Z(e),{x:E,y:w}=U(i,d,n,u),g=Ot(s.current,A.x,A.y,E,w),N=Yt(s.current,new Set(g));t(Q(new Set([...e.shiftKey?l:[],...g,...N]))),t(R("free")),O({x:0,y:0}),I({x:0,y:0})}o==="background"&&!e.shiftKey&&t(st(void 0))}),j=z(e=>{let i=n;e.deltaY>0&&n+10<400?i=n+10:e.deltaY<0&&n-10>0&&(i=n-10),t(mt(i));const{x:d,y:E}=Z(e),w=e.currentTarget.getBoundingClientRect(),[g,N]=[d/w.width,E/w.height];t(rt({x:u.x+d*n/100-P*i/100*g,y:u.y+E*n/100-p*i/100*N}))}),L=z(async e=>{if(H?e.key==="Backspace":e.key==="Delete")l.size>0&&(l.forEach(i=>{s.current.hasNode(i)?s.current.dropNode(i):s.current.hasEdge(i)&&s.current.dropEdge(i)}),t(at()),x());else if(e.key.startsWith("Arrow")){const d=e.key.endsWith("Left")?-1:e.key.endsWith("Right")?1:0,E=e.key.endsWith("Up")?-1:e.key.endsWith("Down")?1:0;t(rt(U(100*d,100*E,n,u)))}else if(e.key==="i"||e.key==="j"||e.key==="k"||e.key==="l"){const d=(e.key==="j"?-1:e.key==="l"?1:0)*10,E=(e.key==="i"?-1:e.key==="k"?1:0)*10;l.size>0&&l.forEach(w=>{s.current.hasNode(w)&&(s.current.updateNodeAttribute(w,"x",g=>(g!=null?g:0)+d),s.current.updateNodeAttribute(w,"y",g=>(g!=null?g:0)+E),x())})}else if(e.key==="f"&&m)t(R(m));else if(e.key==="z"&&(H?e.metaKey&&!e.shiftKey:e.ctrlKey))H&&e.preventDefault(),t(jt());else if(e.key==="s")t(R("select"));else if((e.key==="c"||e.key==="x")&&(H?e.metaKey&&!e.shiftKey:e.ctrlKey)){const i=Kt(s.current,l);navigator.clipboard.writeText(i),e.key==="x"&&(t(at()),l.forEach(d=>{s.current.hasNode(d)?s.current.dropNode(d):s.current.hasEdge(d)&&s.current.dropEdge(d)}),x())}else if(e.key==="v"&&(H?e.metaKey&&!e.shiftKey:e.ctrlKey)){const i=await navigator.clipboard.readText(),{x:d,y:E}=U(P/2,p/2,n,u),{nodes:w,edges:g}=Lt(i,s.current,F(d,5),F(E,5));x();const N=structuredClone(w);g.forEach(X=>N.add(X)),t(Q(N))}else(H&&e.key==="z"&&e.metaKey&&e.shiftKey||!H&&e.key==="y"&&e.ctrlKey)&&t(Tt())}),[C,B]=D.useState(0),k=z(e=>{if(e.touches.length===2){t(st(void 0));const[i,d]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY];B(i*i+d*d)}}),W=z(e=>{if(C!==0&&e.touches.length===2){const[i,d]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY],E=i*i+d*d;let w=n;E-C<0&&n+10<=390?w=n+10:E-C>0&&n-10>=10&&(w=n-10),t(mt(w)),B(E);const g=e.currentTarget.getBoundingClientRect(),[N,X]=[(e.touches[0].clientX+e.touches[1].clientX)/2-g.left,(e.touches[0].clientY+e.touches[1].clientY)/2-g.top],[lt,kt]=[N/g.width,X/g.height];t(rt({x:u.x+N*n/100-P*w/100*lt,y:u.y+X*n/100-p*w/100*kt}))}}),$=z(e=>{C!==0&&B(0)}),[T,Y]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{Y({sx:A.x<=c.x?A.x:c.x,ex:A.x>c.x?A.x:c.x,sy:A.y<=c.y?A.y:c.y,ey:A.y>c.y?A.y:c.y})},[c.x,c.y]),M.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:p,width:P,viewBox:"".concat(u.x," ").concat(u.y," ").concat(P*n/100," ").concat(p*n/100),onPointerDown:a,onPointerMove:S,onPointerUp:_,onTouchStart:k,onTouchMove:W,onTouchEnd:$,onWheel:j,tabIndex:0,onKeyDown:L,children:[M.jsx(Zt,{}),y==="select"&&A.x!=0&&A.y!=0&&M.jsx("rect",{x:T.sx,y:T.sy,width:T.ex-T.sx,height:T.ey-T.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),M.jsx("defs",{children:M.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[M.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),M.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{ee as default};
