import{j as w}from"./chakra-h-ATOMu2.js";import{m as L,H as ie,l as O,f as me,a as R,ab as W,ac as H,ad as U,ae as ue,af as fe,q as be,t as ce,S as we,b as Ee,n as ae,o as X,r as Z,E as le,v as de,x as q,K as Ne,F as re,D as Ce,a0 as Pe,a2 as Ie}from"./index--YGnfCzu.js";import{b as v}from"./react-hBmrxY6U.js";import{u as j,e as Me,i as je}from"./clipboard-xiBEtUXb.js";import{s as ve,u as Le,F as G}from"./stations-53YVjD6o.js";import{a as T,r as z,g as _e,f as Ke,p as D,b as De,d as We,i as B}from"./helpers-i8VqbHBm.js";import{m as Ae}from"./misc-nodes-PUbSXEIv.js";const ye=t=>t.filterNodes((e,r)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),xe=t=>t.filterDirectedEdges((e,r,c,n,u,f,y)=>e.startsWith("line")&&r.visible&&r.reconcileId==="").sort((e,r)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(r,"zIndex")).map(e=>{const r=t.getEdgeAttribute(e,"type"),c=t.getEdgeAttribute(e,r),n=t.getEdgeAttribute(e,"style"),u=t.getEdgeAttribute(e,n),[f,y]=t.extremities(e),g=t.getNodeAttributes(f),h=t.getNodeAttributes(y);return{edge:e,x1:g.x,y1:g.y,x2:h.x,y2:h.y,type:r,attr:c,style:n,styleAttr:u}}),ge=t=>t.filterNodes((e,r)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),ze=t=>{const e=t.filterDirectedEdges((c,n,u,f,y,g,h)=>c.startsWith("line")&&n.reconcileId!==""),r={};for(const c of e){const n=t.getEdgeAttribute(c,"reconcileId");n in r?r[n].push(c):r[n]=[c]}return r},Te=t=>{const e=ze(t),r=[],c=[];return Object.values(e).forEach(n=>{var _;if(n.length===1){c.push(...n);return}const u=t.getEdgeAttribute(n.at(0),"type");if(!n.every(m=>t.getEdgeAttribute(m,"type")===u)){c.push(...n);return}const f=t.getEdgeAttribute(n.at(0),"style");if(!n.every(m=>t.getEdgeAttribute(m,"style")===f)){c.push(...n);return}const y={},g=new Set,h=new Set,b=Object.fromEntries(n.map(m=>{var F,$;const[I,M]=t.extremities(m);return y[I]=((F=y[I])!=null?F:0)+1,y[M]=(($=y[M])!=null?$:0)+1,g.add(I),h.add(M),[I,[m,M]]})),A=Array.from(g).filter(m=>y[m]===1),N=Array.from(h).filter(m=>y[m]===1);if(A.length!==1||N.length!==1){c.push(...n);return}const C=A[0],P=N[0];if(C===P){c.push(...n);return}const E=[b[C][0]];let S=b[C][1];for(let m=1;m<n.length;m=m+1){const I=(_=b[S])==null?void 0:_.at(1);if(!I){c.push(...n);return}E.push(b[S][0]),S=I}if(S!==P||E.length!==n.length){c.push(...n);return}r.push(E)}),{allReconciledLines:r,danglingLines:c}},$e=(t,e)=>{if(!e.every(n=>t.hasEdge(n)))return;const r=e.map(n=>{var A,N,C;const[u,f]=t.extremities(n),y=t.getNodeAttributes(u),g=t.getNodeAttributes(f),h=t.getEdgeAttribute(n,"type"),b=(A=t.getEdgeAttribute(n,h))!=null?A:L[h].defaultAttrs;return(C=(N=L[h])==null?void 0:N.generatePath(y.x,g.x,y.y,g.y,b))!=null?C:"M ".concat(y.x," ").concat(y.y," L ").concat(g.x," ").concat(g.y)});let c="".concat(r[0]," ");for(let n=1;n<e.length;n=n+1)c+=r[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},he=t=>{const{id:e,x:r,y:c,handlePointerDown:n,handlePointerMove:u,handlePointerUp:f}=t,y=v.useCallback(b=>n(e,b),[e,n]),g=v.useCallback(b=>u(e,b),[e,u]),h=v.useCallback(b=>f(e,b),[e,f]);return w.jsx("g",{id:e,transform:"translate(".concat(r-6.4," ").concat(c-6.4,")scale(0.025)"),onPointerDown:y,onPointerMove:g,onPointerUp:h,style:{cursor:"move"},children:w.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Se=t=>{const{id:e,path:r,handleClick:c}=t,n=v.useCallback(u=>c(e,u),[e,c]);return w.jsx("path",{id:e,d:r,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:n})},oe=t=>{var P,E;const{id:e,type:r,attrs:c=L[r].defaultAttrs,styleType:n,styleAttrs:u=ie[n].defaultAttrs,newLine:f,handleClick:y}=t,{x1:g,y1:h,x2:b,y2:A}=t,N=v.useMemo(()=>Be(e,r,g,h,b,A,c),[r,JSON.stringify(c),g,b,h,A]),C=(E=(P=ie[n])==null?void 0:P.component)!=null?E:Se;return w.jsx(C,{id:e,type:r,path:N,styleAttrs:u,newLine:f,handleClick:y})},Be=(t,e,r,c,n,u,f)=>{if(!(e in L))return"M ".concat(r," ").concat(c," L ").concat(n," ").concat(u);const y=Oe(t,e,r,c,n,u,f);if(y){const{x1:g,y1:h,x2:b,y2:A,offset:N}=y;return L[O.Simple].generatePath(g,b,h,A,{offset:N})}return L[e].generatePath(r,n,c,u,f)},Oe=(t,e,r,c,n,u,f)=>{if(!("offsetFrom"in f)||!("offsetTo"in f)||Number.isNaN(f.offsetFrom)||Number.isNaN(f.offsetTo))return;if(f.offsetFrom===f.offsetTo)return pe(e,r,c,n,u)?{x1:r,y1:c,x2:n,y2:u,offset:f.offsetFrom}:void 0;const[y,g]=[f.offsetFrom,f.offsetTo];for(let h=0;h<Math.PI;h+=Math.PI/8)for(let b=h,A=0;A<2;A++,b+=Math.PI){const[N,C,P,E]=[Math.sin(h)*y,Math.cos(h)*y,Math.sin(b)*g,Math.cos(b)*g];if(pe(e,r+N,c+C,n+P,u+E))return{x1:r+N,y1:c+C,x2:n+P,y2:u+E,offset:0}}},pe=(t,e,r,c,n)=>!!((e===c||r===n)&&[O.Diagonal,O.Perpendicular].includes(t)||Math.abs((n-r)/(c-e))===1&&[O.Diagonal,O.RotatePerpendicular].includes(t)),Fe=()=>{const t=me(),e=v.useRef(window.graph),{telemetry:{project:r}}=R(l=>l.app),{svgViewBoxZoom:c}=R(l=>l.param),{selected:n,refresh:{nodes:u,edges:f},mode:y,active:g,keepLastPath:h,theme:b}=R(l=>l.runtime),[A,N]=v.useState({x:0,y:0}),[C,P]=v.useState({x:0,y:0}),E=j((l,p)=>{p.stopPropagation(),y==="select"&&t(W("free"));const s=p.currentTarget,{x:o,y:a}=T(p);s.setPointerCapture(p.pointerId),N({x:o,y:a}),t(H(l)),p.shiftKey?n.has(l)?t(ue(l)):t(fe(l)):n.has(l)||t(U(new Set([l])))}),S=j((l,p)=>{const{x:s,y:o}=T(p);y==="free"&&g===l?(n.forEach(a=>{e.current.hasNode(a)&&e.current.updateNodeAttributes(a,i=>({...i,x:z(i.x-(A.x-s)*c/100,p.altKey?1:5),y:z(i.y-(A.y-o)*c/100,p.altKey?1:5)}))}),t(be()),t(ce())):y.startsWith("line")&&P({x:(A.x-s)*c/100,y:(A.y-o)*c/100})}),_=j((l,p)=>{if(y.startsWith("line")){h||t(W("free"));const s=[...Object.values(we),Ee.Virtual],o=e.current.hasNode(g)&&s.includes(e.current.getNodeAttribute(g,"type"));["stn_core_","virtual_circle_"].forEach(i=>{var K,V;const d=(V=(K=document.elementsFromPoint(p.clientX,p.clientY)[0].attributes)==null?void 0:K.getNamedItem("id"))==null?void 0:V.value,k=d==null?void 0:d.startsWith(i);if(o&&k){const Y=y.slice(5),ke="line_".concat(ae(10));e.current.addDirectedEdgeWithKey(ke,g,d.slice(i.length),{visible:!0,zIndex:0,type:Y,[Y]:structuredClone(L[Y].defaultAttrs),style:X.SingleColor,[X.SingleColor]:{color:b},reconcileId:""}),r&&Z.event(le.ADD_LINE,{type:Y})}}),t(ce()),t(de(e.current.export()))}else if(y==="free"&&g){const{x:s,y:o}=T(p);A.x-s===0&&A.y-o===0||t(de(e.current.export()))}t(H(void 0))}),m=j((l,p)=>{p.shiftKey||t(q()),p.shiftKey&&n.has(l)?t(ue(l)):t(fe(l))}),[I,M]=v.useState(ye(e.current)),[F,$]=v.useState(ge(e.current)),[J,Q]=v.useState(xe(e.current)),[ee,te]=v.useState([]),[se,ne]=v.useState([]);return v.useEffect(()=>{M(ye(e.current)),$(ge(e.current))},[u]),v.useEffect(()=>{Q(xe(e.current));const{allReconciledLines:l,danglingLines:p}=Te(e.current);te(l),ne(p)},[f]),w.jsxs(w.Fragment,{children:[se.map(l=>{const[p,s]=e.current.extremities(l),o=e.current.getNodeAttributes(p),a=e.current.getNodeAttributes(s);return w.jsx(oe,{id:l,x1:o.x,y1:o.y,x2:a.x,y2:a.y,newLine:!1,type:O.Simple,attrs:L[O.Simple].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:m},l)}),ee.map(l=>{var d,k;const p=$e(e.current,l);if(!p)return w.jsx(w.Fragment,{});const s=l.at(0),o=e.current.getEdgeAttribute(s,"type"),a=e.current.getEdgeAttribute(s,"style"),i=e.current.getEdgeAttribute(s,a),x=(k=(d=ie[a])==null?void 0:d.component)!=null?k:Se;return w.jsx(x,{id:s,type:o,path:p,styleAttrs:i,newLine:!1,handleClick:m},s)}),J.map(({edge:l,x1:p,y1:s,x2:o,y2:a,type:i,attr:x,style:d,styleAttr:k})=>w.jsx(oe,{id:l,x1:p,y1:s,x2:o,y2:a,newLine:!1,type:i,attrs:x,styleType:d,styleAttrs:k,handleClick:m},l)),F.map(l=>{var x,d;const{node:p,x:s,y:o,type:a}=l,i=(d=(x=Ae[a])==null?void 0:x.component)!=null?d:he;return w.jsx(i,{id:p,x:s,y:o,attrs:l[a],handlePointerDown:E,handlePointerMove:S,handlePointerUp:_},p)}),I.map(l=>{var x,d;const{node:p,x:s,y:o,type:a}=l,i=(d=(x=ve[a])==null?void 0:x.component)!=null?d:he;return w.jsx(i,{id:p,x:s,y:o,attrs:{[a]:l[a]},handlePointerDown:E,handlePointerMove:S,handlePointerUp:_},p)}),y.startsWith("line")&&g&&w.jsx(oe,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(g,"x"),y1:e.current.getNodeAttribute(g,"y"),x2:e.current.getNodeAttribute(g,"x")-C.x,y2:e.current.getNodeAttribute(g,"y")-C.y,newLine:!0,type:y.slice(5),attrs:L[y.slice(5)].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:b}})]})},qe=()=>{const t=me(),e=v.useRef(window.graph),r=()=>{t(be()),t(ce()),t(de(e.current.export()))},{telemetry:{project:c}}=R(s=>s.app),{svgViewBoxZoom:n,svgViewBoxMin:u}=R(s=>s.param),{mode:f,lastTool:y,active:g,selected:h,keepLastPath:b,theme:A,refresh:{nodes:N}}=R(s=>s.runtime),C=Le(),{height:P,width:E}=_e(C);v.useEffect(()=>{const s=Ke(e.current),o=Object.entries(s).filter(([i,x])=>x&&i in G).map(([i,x])=>i).filter(i=>G[i]&&document.getElementById(G[i].cssName)===null).map(i=>G[i]),a=o.map(i=>i.cssName).filter((i,x,d)=>x===d.findIndex(k=>k===i)).map(i=>{const x=document.createElement("link");return x.rel="stylesheet",x.id=i,x.href="/rmp/styles/".concat(i,".css"),x});Promise.all(o.filter(i=>i.useRuntime).flatMap(i=>i.cssFont).map(i=>Z.loadFont(i))).then(()=>{document.head.append(...a)})},[N]);const[S,_]=v.useState({x:0,y:0}),[m,I]=v.useState({x:0,y:0}),[M,F]=v.useState({x:0,y:0}),[$,J]=v.useState({x:0,y:0}),Q=j(s=>{const{x:o,y:a}=T(s);if(f.startsWith("station")){t(W("free"));const i=ae(10),x="stn_".concat(i),d=f.slice(8),k=structuredClone(ve[d].defaultAttrs);"color"in k&&(k.color=A);const{x:K,y:V}=D(o,a,n,u);e.current.addNode(x,{visible:!0,zIndex:0,x:z(K,5),y:z(V,5),type:d,[d]:k}),r(),c&&Z.event(le.ADD_STATION,{type:d}),t(U(new Set([x])))}else if(f.startsWith("misc-node")){t(W("free"));const i=ae(10),x="misc_node_".concat(i),d=f.slice(10),{x:k,y:K}=D(o,a,n,u);e.current.addNode(x,{visible:!0,zIndex:0,x:z(k,5),y:z(K,5),type:d,[d]:structuredClone(Ae[d].defaultAttrs)}),r(),c&&Z.event(le.ADD_STATION,{type:d}),t(U(new Set([x])))}else f==="free"||f.startsWith("line")?(f.startsWith("line")&&(t(W("free")),b&&t(Ne(!1))),F({x:o,y:a}),J(u),s.shiftKey||(t(H("background")),t(q()))):f==="select"&&(_(D(o,a,n,u)),I(D(o,a,n,u)))}),ee=j(s=>{if(f==="select"){if(S.x!=0&&S.y!=0){const{x:o,y:a}=T(s);I(D(o,a,n,u))}}else if(g==="background"){const{x:o,y:a}=T(s);t(re({x:$.x+(M.x-o)*n/100,y:$.y+(M.y-a)*n/100}))}}),te=j(s=>{if(f==="select"){const{x:o,y:a}=T(s),{x:i,y:x}=D(o,a,n,u),d=De(e.current,S.x,S.y,i,x),k=We(e.current,new Set(d));t(U(new Set([...s.shiftKey?h:[],...d,...k]))),t(W("free")),_({x:0,y:0}),I({x:0,y:0})}g==="background"&&!s.shiftKey&&t(H(void 0))}),se=j(s=>{let o=n;s.deltaY>0&&n+10<400?o=n+10:s.deltaY<0&&n-10>0&&(o=n-10),t(Ce(o));const{x:a,y:i}=T(s),x=s.currentTarget.getBoundingClientRect(),[d,k]=[a/x.width,i/x.height];t(re({x:u.x+a*n/100-E*o/100*d,y:u.y+i*n/100-P*o/100*k}))}),ne=j(async s=>{if(B?s.key==="Backspace":s.key==="Delete")h.size>0&&(h.forEach(o=>{e.current.hasNode(o)?e.current.dropNode(o):e.current.hasEdge(o)&&e.current.dropEdge(o)}),t(q()),r());else if(s.key.startsWith("Arrow")){const a=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,i=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;t(re(D(100*a,100*i,n,u)))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const a=(s.key==="j"?-1:s.key==="l"?1:0)*10,i=(s.key==="i"?-1:s.key==="k"?1:0)*10;h.size>0&&h.forEach(x=>{e.current.hasNode(x)&&(e.current.updateNodeAttribute(x,"x",d=>(d!=null?d:0)+a),e.current.updateNodeAttribute(x,"y",d=>(d!=null?d:0)+i),r())})}else if(s.key==="f"&&y)t(W(y));else if(s.key==="z"&&(B?s.metaKey&&!s.shiftKey:s.ctrlKey))B&&s.preventDefault(),t(Pe());else if(s.key==="s")t(W("select"));else if((s.key==="c"||s.key==="x")&&(B?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=Me(e.current,h);navigator.clipboard.writeText(o),s.key==="x"&&(t(q()),h.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),r())}else if(s.key==="v"&&(B?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=await navigator.clipboard.readText(),{x:a,y:i}=D(E/2,P/2,n,u),{nodes:x,edges:d}=je(o,e.current,z(a,5),z(i,5));r();const k=structuredClone(x);d.forEach(K=>k.add(K)),t(U(k))}else(B&&s.key==="z"&&s.metaKey&&s.shiftKey||!B&&s.key==="y"&&s.ctrlKey)&&t(Ie())}),[l,p]=v.useState({sx:0,sy:0,ex:0,ey:0});return v.useEffect(()=>{p({sx:S.x<=m.x?S.x:m.x,ex:S.x>m.x?S.x:m.x,sy:S.y<=m.y?S.y:m.y,ey:S.y>m.y?S.y:m.y})},[m.x,m.y]),w.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:P,width:E,viewBox:"".concat(u.x," ").concat(u.y," ").concat(E*n/100," ").concat(P*n/100),onPointerDown:Q,onPointerMove:ee,onPointerUp:te,onWheel:se,tabIndex:0,onKeyDown:ne,children:[w.jsx(Fe,{}),f==="select"&&S.x!=0&&S.y!=0&&w.jsx("rect",{x:l.sx,y:l.sy,width:l.ex-l.sx,height:l.ey-l.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),w.jsx("defs",{children:w.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[w.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),w.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{qe as default};
