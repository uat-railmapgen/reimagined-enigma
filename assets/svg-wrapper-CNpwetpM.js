import{j as E}from"./chakra-xNcrfRXW.js";import{a3 as Et,ap as Ct,aq as Ht,N as Tt,k as tt,l as R,ar as Wt,as as Kt,at as Rt,au as Pt,S as Ot,av as wt,c as It,d as st,aw as Q,ax as J,ay as lt,T as rt,az as kt,aA as Nt,aB as Y,q as dt,t as ct,n as at,m as Xt,o as zt,r as ut,E as ht,v as bt,y as St,U as V,aC as Yt,p as Ft,aD as Ut,a0 as Vt,a1 as Qt,A as xt,z as Dt,a9 as nt,am as Zt,an as qt}from"./index-ey5UU-Ti.js";import{f as Bt,b as j}from"./react-D-_si4LB.js";import{u as H,e as Gt,i as Jt}from"./clipboard-DRJy7wLK.js";import{s as ft,u as te,f as ee,F as ne,l as se,b as oe,c as ie}from"./master-manager-Cs1SAGrH.js";import{m as yt}from"./misc-nodes-DIFgGvKo.js";const re={[Et.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Et.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ae=t=>{const e=re[t];return e.at(Math.floor(Math.random()*e.length))},Mt=Bt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:d,rejectWithValue:c})=>{const{token:s}=e().account;if(!s){d(Ct({cityName:t,names:[]}));return}const l=await fetch("".concat(Ht,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(s)}});if(!l.ok)return Tt.warn("Failed to fetch random station names",l.statusText),c(l.statusText);const r=await l.json();d(Ct({cityName:t,names:r}))}),_t=Bt("runtime/getOneStationName",async(t,{getState:e,dispatch:d})=>{var h;const{stationNames:c}=e().runtime,s=c[t];if(((h=s==null?void 0:s.length)!=null?h:0)==0)return Tt.debug("No random station names in cache, using fallback"),d(Mt({cityName:t})),Object.values(ae(t));const l=structuredClone(s),r=l.shift();return d(Ct({cityName:t,names:l})),l.length<3&&d(Mt({cityName:t})),Object.values(r)}),$t=(t,e,d,c,s,l)=>{if(!("offsetFrom"in l)||!("offsetTo"in l)||Number.isNaN(l.offsetFrom)||Number.isNaN(l.offsetTo))return;if(l.offsetFrom===l.offsetTo)return jt(t,e,d,c,s)?{x1:e,y1:d,x2:c,y2:s,offset:l.offsetFrom}:void 0;const[r,h]=[l.offsetFrom,l.offsetTo];for(let g=0;g<Math.PI;g+=Math.PI/8)for(let o=g,i=0;i<2;i++,o+=Math.PI){const[u,m,b,A]=[Math.sin(g)*r,Math.cos(g)*r,Math.sin(o)*h,Math.cos(o)*h];if(jt(t,e+u,d+m,c+b,s+A))return{x1:e+u,y1:d+m,x2:c+b,y2:s+A,offset:0}}},ce=(t,e,d,c,s,l)=>t===d?{x1:t+5*l,y1:e,x2:d+5*l,y2:c,offset:s}:e===c?{x1:t,y1:e+5*l,x2:d,y2:c+5*l,offset:s}:{x1:t+5*Math.SQRT1_2*l,y1:e+5*Math.SQRT1_2*l,x2:d+5*Math.SQRT1_2*l,y2:c+5*Math.SQRT1_2*l,offset:s},jt=(t,e,d,c,s)=>!!((e===c||d===s)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((s-d)/(c-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),le=(t,e)=>{const d=[],c=[];return Object.values(e).forEach(s=>{var T;if(s.length===1){c.push(...s.map(f=>f.edge));return}const l=t.getEdgeAttribute(s.at(0),"type");if(!s.every(f=>t.getEdgeAttribute(f,"type")===l)){c.push(...s.map(f=>f.edge));return}const r=t.getEdgeAttribute(s.at(0),"style");if(!s.every(f=>t.getEdgeAttribute(f,"style")===r)){c.push(...s.map(f=>f.edge));return}const h={},g=new Set,o=new Set,i=Object.fromEntries(s.map(f=>{var x,C;const[M,a]=t.extremities(f);return h[M]=((x=h[M])!=null?x:0)+1,h[a]=((C=h[a])!=null?C:0)+1,g.add(M),o.add(a),[M,[f.edge,a]]})),u=Array.from(g).filter(f=>h[f]===1),m=Array.from(o).filter(f=>h[f]===1);if(u.length!==1||m.length!==1){c.push(...s.map(f=>f.edge));return}const b=u[0],A=m[0];if(b===A){c.push(...s.map(f=>f.edge));return}const N=[i[b][0]];let z=i[b][1];for(let f=1;f<s.length;f=f+1){const M=(T=i[z])==null?void 0:T.at(1);if(!M){c.push(...s.map(a=>a.edge));return}N.push(i[z][0]),z=M}if(z!==A||N.length!==s.length){c.push(...s.map(f=>f.edge));return}d.push(N)}),{allReconciledLines:d,danglingLines:c}},de=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const d=e.map(s=>{var m,b,A;const[l,r]=t.extremities(s),h=t.getNodeAttributes(l),g=t.getNodeAttributes(r),{type:o}=t.getEdgeAttributes(s),i=(m=t.getEdgeAttribute(s,o))!=null?m:R[o].defaultAttrs,u=$t(o,h.x,h.y,g.x,g.y,i);if(u){const{x1:N,y1:z,x2:T,y2:f,offset:M}=u;return R[tt.Simple].generatePath(N,T,z,f,{offset:M})}return(A=(b=R[o])==null?void 0:b.generatePath(h.x,g.x,h.y,g.y,i))!=null?A:"M ".concat(h.x," ").concat(h.y," L ").concat(g.x," ").concat(g.y)});let c="".concat(d[0]," ");for(let s=1;s<e.length;s=s+1)c+=d[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},ue=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),he=t=>{const e={},d={},c=[],s={},l=[];for(const o of t.edgeEntries()){const[i,u,m,b]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],A=o.attributes[o.attributes.type],N=$t(o.attributes.type,i,u,m,b,A);d[o.edge]=N}for(const o of t.edgeEntries()){let i=d[o.edge];const{parallelIndex:u}=o.attributes;if(u>=0){const m=Wt(t,o.attributes.type,o.edge),b=d[m];if(!b){c.push(o);continue}if(u>0){const{x1:A,y1:N,x2:z,y2:T,offset:f}=b;i=ce(A,N,z,T,f,u)}}if(o.attributes.reconcileId!==""){const m=o.attributes.reconcileId;m in s?s[m].push(o):s[m]=[o];continue}if(i){const m=o.edge,b=o.attributes,{x1:A,y1:N,x2:z,y2:T,offset:f}=i;e[m]={attr:b,path:R[tt.Simple].generatePath(A,z,N,T,{offset:f})};continue}l.push(o)}const r=new Set;for(;c.length;){const o=c.pop();if(r.has(o.edge))continue;const{parallel:i}=Kt(t,o);if(!i.length)continue;i.forEach(m=>r.add(m.edge));const u=Rt(i);for(const m of i){const b=m.edge;e[b]={attr:m.attributes,path:u[b]}}}const{allReconciledLines:h,danglingLines:g}=le(t,s);for(const o of h){const i=de(t,o);if(!i)continue;const u=o[0];e[u]={attr:t.getEdgeAttributes(u),path:i}}for(const o of g){const i=t.getEdgeAttributes(o),[u,m]=t.extremities(o),b=t.getNodeAttributes(u),A=t.getNodeAttributes(m);e[o]={attr:i,path:R[tt.Simple].generatePath(b.x,A.x,b.y,A.y,R[tt.Simple].defaultAttrs)}}for(const o of l){const i=o.edge,u=o.attributes.type,m=o.attributes,[b,A,N,z]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(u in R)){e[i]={attr:m,path:"M ".concat(b," ").concat(A," L ").concat(N," ").concat(z)};continue}e[i]={attr:m,path:R[u].generatePath(b,N,A,z,m[u])}}return Object.entries(e).map(([o,i])=>({id:o,type:"line",line:i}))},Lt=t=>{const{id:e,x:d,y:c,handlePointerDown:s,handlePointerMove:l,handlePointerUp:r}=t,h=j.useCallback(i=>s(e,i),[e,s]),g=j.useCallback(i=>l(e,i),[e,l]),o=j.useCallback(i=>r(e,i),[e,r]);return E.jsx("g",{id:e,transform:"translate(".concat(d-6.4," ").concat(c-6.4,")scale(0.025)"),onPointerDown:h,onPointerMove:g,onPointerUp:o,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},fe=t=>{const{id:e,path:d,handlePointerDown:c}=t,s=j.useCallback(l=>c(e,l),[e,c]);return E.jsx("path",{id:e,d,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},ye=j.memo(t=>{var g,o,i,u,m,b,A,N,z,T,f,M;const{elements:e,handlePointerDown:d,handlePointerMove:c,handlePointerUp:s,handleEdgePointerDown:l}=t,r=Object.fromEntries(Array.from({length:21},(a,x)=>[x-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const x=a.line.attr.type,C=a.line.attr.style,w=a.line.attr[C],v=(g=Pt[C])==null?void 0:g.preComponent;v&&r[a.line.attr.zIndex].pre.push(E.jsx(v,{id:a.id,type:x,path:a.line.path,styleAttrs:w,newLine:!1,handlePointerDown:l},"".concat(a.id,".pre")));const y=(i=(o=Pt[C])==null?void 0:o.component)!=null?i:fe;r[a.line.attr.zIndex].main.push(E.jsx(y,{id:a.id,type:x,path:a.line.path,styleAttrs:w,newLine:!1,handlePointerDown:l},a.id));const L=(u=Pt[C])==null?void 0:u.postComponent;L&&r[a.line.attr.zIndex].post.push(E.jsx(L,{id:a.id,type:x,path:a.line.path,styleAttrs:w,newLine:!1,handlePointerDown:l},"".concat(a.id,".post")))}else if(a.type==="station"){const x=a.station,C=x.type,w=(m=ft[C])==null?void 0:m.preComponent;w&&r[a.station.zIndex].pre.push(E.jsx(w,{id:a.id,x:x.x,y:x.y,attrs:x,handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},"".concat(a.id,".pre")));const v=(A=(b=ft[C])==null?void 0:b.component)!=null?A:Lt;r[a.station.zIndex].main.push(E.jsx(v,{id:a.id,x:x.x,y:x.y,attrs:x,handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},a.id));const y=(N=ft[C])==null?void 0:N.postComponent;y&&r[a.station.zIndex].post.push(E.jsx(y,{id:a.id,x:x.x,y:x.y,attrs:x,handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const x=a.miscNode,C=x.type,w=(z=yt[C])==null?void 0:z.preComponent;w&&r[a.miscNode.zIndex].pre.push(E.jsx(w,{id:a.id,x:x.x,y:x.y,attrs:x[C],handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},"".concat(a.id,".pre")));const v=(f=(T=yt[C])==null?void 0:T.component)!=null?f:Lt;r[a.miscNode.zIndex].main.push(E.jsx(v,{id:a.id,x:x.x,y:x.y,attrs:x[C],handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},a.id));const y=(M=yt[C])==null?void 0:M.postComponent;y&&r[a.miscNode.zIndex].post.push(E.jsx(y,{id:a.id,x:x.x,y:x.y,attrs:x[C],handlePointerDown:d,handlePointerMove:c,handlePointerUp:s},"".concat(a.id,".post")))}return Array.from({length:21},(a,x)=>(x-10).toString()).map(a=>[...r[a].pre,...r[a].main,...r[a].post]).flat()},(t,e)=>t.elements===e.elements),pe=[...Object.values(Ot),wt.Virtual,wt.Master,wt.LondonArrow],ge=()=>{const t=It(),e=j.useRef(window.graph),d=()=>{t(dt()),t(ct()),t(bt(e.current.export()))},{telemetry:{project:c},preference:{autoParallel:s}}=st(v=>v.app),{svgViewBoxZoom:l,svgViewBoxMin:r}=st(v=>v.param),{selected:h,refresh:{nodes:g,edges:o},mode:i,active:u,keepLastPath:m,theme:b}=st(v=>v.runtime),[A,N]=j.useState({x:0,y:0}),[z,T]=j.useState({x:0,y:0}),f=H((v,y)=>{y.stopPropagation(),i==="select"&&t(Q("free"));const L=y.currentTarget,{x:$,y:I}=J(y);L.setPointerCapture(y.pointerId),N({x:$,y:I}),t(lt(v)),y.shiftKey?h.has(v)?t(kt(v)):t(Nt(v)):h.has(v)||t(rt(new Set([v])))}),M=H((v,y)=>{const{x:L,y:$}=J(y);i==="free"&&u===v?(h.forEach(I=>{e.current.hasNode(I)&&e.current.updateNodeAttributes(I,O=>({...O,x:Y(O.x-(A.x-L)*l/100,y.altKey?1:5),y:Y(O.y-(A.y-$)*l/100,y.altKey?1:5)}))}),t(dt()),t(ct())):i.startsWith("line")&&T({x:(A.x-L)*l/100,y:(A.y-$)*l/100})}),a=H((v,y)=>{if(i.startsWith("line")){m||t(Q("free"));const L=e.current.hasNode(u)&&pe.includes(e.current.getNodeAttribute(u,"type"));["stn_core_","virtual_circle_"].forEach(I=>{var ot,it;const W=(it=(ot=document.elementsFromPoint(y.clientX,y.clientY)[0].attributes)==null?void 0:ot.getNamedItem("id"))==null?void 0:it.value,F=W==null?void 0:W.startsWith(I);if(L&&F){const K=i.slice(5),et="line_".concat(at(10)),[X,B]=[u,W.slice(I.length)],U=s?Xt(e.current,K,X,B,"from"):-1;e.current.addDirectedEdgeWithKey(et,X,B,{visible:!0,zIndex:0,type:K,[K]:structuredClone(R[K].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:b},reconcileId:"",parallelIndex:U}),c&&ut.event(ht.ADD_LINE,{type:K})}}),t(ct()),t(bt(e.current.export()))}else if(i==="free"&&u){const{x:L,y:$}=J(y);A.x-L===0&&A.y-$===0||t(bt(e.current.export()))}t(lt(void 0))}),x=H((v,y)=>{if(y.stopPropagation(),y.shiftKey||t(St()),y.shiftKey&&h.has(v)?t(kt(v)):t(Nt(v)),i.startsWith("station")||i.startsWith("misc-node-virtual")||i.startsWith("misc-node-master")){const L=y.clientX-document.getElementById("canvas").getBoundingClientRect().left,$=y.clientY-document.getElementById("canvas").getBoundingClientRect().top,I=i.startsWith("station"),O=at(10),W=I?"stn_".concat(O):"misc_node_".concat(O),F=I?i.slice(8):i.slice(10),{x:ot,y:it}=V(L,$,l,r),K=I?structuredClone(ft[F].defaultAttrs):structuredClone(yt[F].defaultAttrs);"color"in K&&(K.color=b),e.current.addNode(W,{visible:!0,zIndex:0,x:Y(ot,5),y:Y(it,5),type:F,[F]:K});const et=e.current.getEdgeAttributes(v),{zIndex:X,type:B,style:U}=et,pt=et[B],gt=et[U],[Z,At]=e.current.extremities(v),n=s?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),Z,W,{visible:!0,zIndex:X,type:B,[B]:structuredClone(pt),style:U,[U]:structuredClone(gt),reconcileId:"",parallelIndex:n}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),W,At,{visible:!0,zIndex:X,type:B,[B]:structuredClone(pt),style:U,[U]:structuredClone(gt),reconcileId:"",parallelIndex:n}),e.current.dropEdge(v),d(),c&&(ut.event(ht.ADD_STATION,{type:F}),ut.event(ht.ADD_LINE,{type:B})),t(Q("free")),t(rt(new Set([W])))}}),C=j.useMemo(()=>[...he(e.current),...ue(e.current)],[o,g]),w=Yt.component;return E.jsxs(E.Fragment,{children:[E.jsx(ye,{elements:C,handlePointerDown:f,handlePointerMove:M,handlePointerUp:a,handleEdgePointerDown:x}),i.startsWith("line")&&u&&u!=="background"&&E.jsx(w,{id:"line_create_in_progress___no_use",type:i.slice(5),path:R[i.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-z.x,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-z.y,R[i.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}})]})},Pe=()=>{const t=It(),e=j.useRef(window.graph),d=()=>{t(dt()),t(ct()),t(bt(e.current.export()))},{activeSubscriptions:c}=st(n=>n.account),{telemetry:{project:s},preference:{randomStationsNames:l}}=st(n=>n.app),{svgViewBoxZoom:r,svgViewBoxMin:h}=st(n=>n.param),{mode:g,lastTool:o,active:i,selected:u,keepLastPath:m,theme:b,refresh:{nodes:A},masterNodesCount:N,parallelLinesCount:z}=st(n=>n.runtime),T=te(),{height:f,width:M}=Ft(T),a=!c.RMP_CLOUD&&N+1>Ut,x=!c.RMP_CLOUD&&z+1>Vt,C=!c.RMP_CLOUD||l==="none";j.useEffect(()=>{const n=ee(e.current);Object.entries(n).filter(([p,S])=>S&&p in ne).forEach(([p])=>se(p))},[A]);const[w,v]=j.useState({x:0,y:0}),[y,L]=j.useState({x:0,y:0}),[$,I]=j.useState({x:0,y:0}),[O,W]=j.useState({x:0,y:0}),F=H(async n=>{const{x:p,y:S}=J(n);if(g.startsWith("station")){t(Q("free"));const _=at(10),k="stn_".concat(_),P=g.slice(8),D=structuredClone(ft[P].defaultAttrs);if("color"in D&&(D.color=b),!C){const mt=await t(_t(Et.Shmetro));if(_t.fulfilled.match(mt)){const G=mt.payload;D.names.length>G.length?G.push(...Array(D.names.length-G.length).fill(G.at(-1))):D.names.length<G.length&&G.splice(D.names.length,G.length-D.names.length),D.names=G}}const{x:q,y:vt}=V(p,S,r,h);e.current.addNode(k,{visible:!0,zIndex:0,x:Y(q,5),y:Y(vt,5),type:P,[P]:D}),d(),s&&ut.event(ht.ADD_STATION,{type:P}),t(rt(new Set([k])))}else if(g.startsWith("misc-node")){t(Q("free"));const _=at(10),k="misc_node_".concat(_),P=g.slice(10),{x:D,y:q}=V(p,S,r,h);e.current.addNode(k,{visible:!0,zIndex:0,x:Y(D,5),y:Y(q,5),type:P,[P]:structuredClone(yt[P].defaultAttrs)}),d(),s&&ut.event(ht.ADD_STATION,{type:P}),t(rt(new Set([k])))}else g==="free"||g.startsWith("line")?(g.startsWith("line")&&(t(Q("free")),m&&t(Qt(!1))),I({x:p,y:S}),W(h),n.shiftKey||(t(lt("background")),t(St()))):g==="select"&&(v(V(p,S,r,h)),L(V(p,S,r,h)))}),ot=H(n=>{if(g==="select"){if(w.x!=0&&w.y!=0){const{x:p,y:S}=J(n);L(V(p,S,r,h))}}else if(i==="background"){const{x:p,y:S}=J(n);t(xt({x:O.x+($.x-p)*r/100,y:O.y+($.y-S)*r/100}))}}),it=H(n=>{if(g==="select"){const{x:p,y:S}=J(n),{x:_,y:k}=V(p,S,r,h),P=oe(e.current,w.x,w.y,_,k),D=ie(e.current,new Set(P));t(rt(new Set([...n.shiftKey?u:[],...P,...D]))),t(Q("free")),v({x:0,y:0}),L({x:0,y:0})}i==="background"&&!n.shiftKey&&t(lt(void 0))}),K=H(n=>{let p=r;n.deltaY>0&&r+10<400?p=r+10:n.deltaY<0&&r-10>0&&(p=r-10),t(Dt(p));const{x:S,y:_}=J(n),k=n.currentTarget.getBoundingClientRect(),[P,D]=[S/k.width,_/k.height];t(xt({x:h.x+S*r/100-M*p/100*P,y:h.y+_*r/100-f*p/100*D}))}),et=H(async n=>{if(nt?n.key==="Backspace":n.key==="Delete")u.size>0&&(u.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(St()),d());else if(n.key.startsWith("Arrow")){const S=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,_=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(xt(V(100*S,100*_,r,h)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const S=(n.key==="j"?-1:n.key==="l"?1:0)*10,_=(n.key==="i"?-1:n.key==="k"?1:0)*10;u.size>0&&u.forEach(k=>{e.current.hasNode(k)&&(e.current.updateNodeAttribute(k,"x",P=>(P!=null?P:0)+S),e.current.updateNodeAttribute(k,"y",P=>(P!=null?P:0)+_),d())})}else if(n.key==="f"&&o)t(Q(o));else if(n.key==="z"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey))nt&&n.preventDefault(),t(Zt()),t(dt()),t(ct());else if(n.key==="s")t(Q("select"));else if((n.key==="c"||n.key==="x")&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=Gt(e.current,u);navigator.clipboard.writeText(p),n.key==="x"&&(t(St()),u.forEach(S=>{e.current.hasNode(S)?e.current.dropNode(S):e.current.hasEdge(S)&&e.current.dropEdge(S)}),d())}else if(n.key==="v"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x:S,y:_}=V(M/2,f/2,r,h),{nodes:k,edges:P}=Jt(p,e.current,a,x,Y(S,5),Y(_,5));d();const D=structuredClone(k);P.forEach(q=>D.add(q)),t(rt(D))}else(nt&&n.key==="z"&&n.metaKey&&n.shiftKey||!nt&&n.key==="y"&&n.ctrlKey)&&(t(qt()),t(dt()),t(ct()))}),[X,B]=j.useState(0),U=H(n=>{if(n.touches.length===2){t(lt(void 0));const[p,S]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];B(p*p+S*S)}}),pt=H(n=>{if(X!==0&&n.touches.length===2){const[p,S]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],_=p*p+S*S;let k=r;_-X<0&&r+10<=390?k=r+10:_-X>0&&r-10>=10&&(k=r-10),t(Dt(k)),B(_);const P=n.currentTarget.getBoundingClientRect(),[D,q]=[(n.touches[0].clientX+n.touches[1].clientX)/2-P.left,(n.touches[0].clientY+n.touches[1].clientY)/2-P.top],[vt,mt]=[D/P.width,q/P.height];t(xt({x:h.x+D*r/100-M*k/100*vt,y:h.y+q*r/100-f*k/100*mt}))}}),gt=H(n=>{X!==0&&B(0)}),[Z,At]=j.useState({sx:0,sy:0,ex:0,ey:0});return j.useEffect(()=>{At({sx:w.x<=y.x?w.x:y.x,ex:w.x>y.x?w.x:y.x,sy:w.y<=y.y?w.y:y.y,ey:w.y>y.y?w.y:y.y})},[y.x,y.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:f,width:M,viewBox:"".concat(h.x," ").concat(h.y," ").concat(M*r/100," ").concat(f*r/100),onPointerDown:F,onPointerMove:ot,onPointerUp:it,onTouchStart:U,onTouchMove:pt,onTouchEnd:gt,onWheel:K,tabIndex:0,onKeyDown:et,children:[E.jsx(ge,{}),g==="select"&&w.x!=0&&w.y!=0&&E.jsx("rect",{x:Z.sx,y:Z.sy,width:Z.ex-Z.sx,height:Z.ey-Z.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Pe as default};
