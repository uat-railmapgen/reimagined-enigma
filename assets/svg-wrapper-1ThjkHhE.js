import{j as S}from"./chakra-sjIlidOs.js";import{m as D,ac as ht,l as F,f as Ct,a as U,x as et,ad as bt,ae as At,o as tt,af as W,ag as st,q as Mt,t as gt,S as Lt,b as _t,n as pt,r as xt,E as mt,v as vt,$ as Z,D as St,F as ft,a4 as Kt,a6 as Wt,K as zt}from"./index-_y_9Gu6i.js";import{b}from"./react-hBmrxY6U.js";import{u as M,e as $t,i as Bt}from"./clipboard-u2BVzoq8.js";import{e as T,f as G,h as nt,s as It,r as z,u as Ot,g as Ft,F as Rt,l as Ut,d as B,p as O}from"./stations-tsA2u1pR.js";import{f as Vt,a as Yt,b as Xt}from"./graph-JdVb3q7J.js";import{m as Tt}from"./misc-nodes-_dqnodr1.js";const kt=s=>s.filterNodes((t,o)=>t.startsWith("stn")).map(t=>[t,s.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),wt=s=>s.filterDirectedEdges((t,o,a,n,u,d,f)=>t.startsWith("line")&&o.visible&&o.reconcileId==="").sort((t,o)=>s.getEdgeAttribute(t,"zIndex")-s.getEdgeAttribute(o,"zIndex")).map(t=>{const o=s.getEdgeAttribute(t,"type"),a=s.getEdgeAttribute(t,o),n=s.getEdgeAttribute(t,"style"),u=s.getEdgeAttribute(t,n),[d,f]=s.extremities(t),y=s.getNodeAttributes(d),g=s.getNodeAttributes(f);return{edge:t,x1:y.x,y1:y.y,x2:g.x,y2:g.y,type:o,attr:a,style:n,styleAttr:u}}),Et=s=>s.filterNodes((t,o)=>t.startsWith("misc_node")).map(t=>[t,s.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),Zt=s=>{const t=s.filterDirectedEdges((a,n,u,d,f,y,g)=>a.startsWith("line")&&n.reconcileId!==""),o={};for(const a of t){const n=s.getEdgeAttribute(a,"reconcileId");n in o?o[n].push(a):o[n]=[a]}return o},Gt=s=>{const t=Zt(s),o=[],a=[];return Object.values(t).forEach(n=>{var L;if(n.length===1){a.push(...n);return}const u=s.getEdgeAttribute(n.at(0),"type");if(!n.every(p=>s.getEdgeAttribute(p,"type")===u)){a.push(...n);return}const d=s.getEdgeAttribute(n.at(0),"style");if(!n.every(p=>s.getEdgeAttribute(p,"style")===d)){a.push(...n);return}const f={},y=new Set,g=new Set,v=Object.fromEntries(n.map(p=>{var $,_;const[I,j]=s.extremities(p);return f[I]=(($=f[I])!=null?$:0)+1,f[j]=((_=f[j])!=null?_:0)+1,y.add(I),g.add(j),[I,[p,j]]})),k=Array.from(y).filter(p=>f[p]===1),N=Array.from(g).filter(p=>f[p]===1);if(k.length!==1||N.length!==1){a.push(...n);return}const w=k[0],C=N[0];if(w===C){a.push(...n);return}const E=[v[w][0]];let A=v[w][1];for(let p=1;p<n.length;p=p+1){const I=(L=v[A])==null?void 0:L.at(1);if(!I){a.push(...n);return}E.push(v[A][0]),A=I}if(A!==C||E.length!==n.length){a.push(...n);return}o.push(E)}),{allReconciledLines:o,danglingLines:a}},qt=(s,t)=>{if(!t.every(n=>s.hasEdge(n)))return;const o=t.map(n=>{var k,N,w;const[u,d]=s.extremities(n),f=s.getNodeAttributes(u),y=s.getNodeAttributes(d),g=s.getEdgeAttribute(n,"type"),v=(k=s.getEdgeAttribute(n,g))!=null?k:D[g].defaultAttrs;return(w=(N=D[g])==null?void 0:N.generatePath(f.x,y.x,f.y,y.y,v))!=null?w:"M ".concat(f.x," ").concat(f.y," L ").concat(y.x," ").concat(y.y)});let a="".concat(o[0]," ");for(let n=1;n<t.length;n=n+1)a+=o[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return a},Pt=s=>{const{id:t,x:o,y:a,handlePointerDown:n,handlePointerMove:u,handlePointerUp:d}=s,f=b.useCallback(v=>n(t,v),[t,n]),y=b.useCallback(v=>u(t,v),[t,u]),g=b.useCallback(v=>d(t,v),[t,d]);return S.jsx("g",{id:t,transform:"translate(".concat(o-6.4," ").concat(a-6.4,")scale(0.025)"),onPointerDown:f,onPointerMove:y,onPointerUp:g,style:{cursor:"move"},children:S.jsx("path",{id:"stn_core_".concat(t),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},jt=s=>{const{id:t,path:o,handleClick:a}=s,n=b.useCallback(u=>a(t,u),[t,a]);return S.jsx("path",{id:t,d:o,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:n})},yt=s=>{var C,E;const{id:t,type:o,attrs:a=D[o].defaultAttrs,styleType:n,styleAttrs:u=ht[n].defaultAttrs,newLine:d,handleClick:f}=s,{x1:y,y1:g,x2:v,y2:k}=s,N=b.useMemo(()=>Jt(t,o,y,g,v,k,a),[o,JSON.stringify(a),y,v,g,k]),w=(E=(C=ht[n])==null?void 0:C.component)!=null?E:jt;return S.jsx(w,{id:t,type:o,path:N,styleAttrs:u,newLine:d,handleClick:f})},Jt=(s,t,o,a,n,u,d)=>{if(!(t in D))return"M ".concat(o," ").concat(a," L ").concat(n," ").concat(u);const f=Ht(s,t,o,a,n,u,d);if(f){const{x1:y,y1:g,x2:v,y2:k,offset:N}=f;return D[F.Simple].generatePath(y,v,g,k,{offset:N})}return D[t].generatePath(o,n,a,u,d)},Ht=(s,t,o,a,n,u,d)=>{if(!("offsetFrom"in d)||!("offsetTo"in d)||Number.isNaN(d.offsetFrom)||Number.isNaN(d.offsetTo))return;if(d.offsetFrom===d.offsetTo)return Nt(t,o,a,n,u)?{x1:o,y1:a,x2:n,y2:u,offset:d.offsetFrom}:void 0;const[f,y]=[d.offsetFrom,d.offsetTo];for(let g=0;g<Math.PI;g+=Math.PI/8)for(let v=g,k=0;k<2;k++,v+=Math.PI){const[N,w,C,E]=[Math.sin(g)*f,Math.cos(g)*f,Math.sin(v)*y,Math.cos(v)*y];if(Nt(t,o+N,a+w,n+C,u+E))return{x1:o+N,y1:a+w,x2:n+C,y2:u+E,offset:0}}},Nt=(s,t,o,a,n)=>!!((t===a||o===n)&&[F.Diagonal,F.Perpendicular].includes(s)||Math.abs((n-o)/(a-t))===1&&[F.Diagonal,F.RotatePerpendicular].includes(s)),Qt=()=>{const s=Ct(),t=b.useRef(window.graph),{telemetry:{project:o}}=U(r=>r.app),{svgViewBoxZoom:a}=U(r=>r.param),{selected:n,refresh:{nodes:u,edges:d},mode:f,active:y,keepLastPath:g,theme:v}=U(r=>r.runtime),[k,N]=b.useState({x:0,y:0}),[w,C]=b.useState({x:0,y:0}),[E,A]=b.useState({x:0,y:0}),L=(r,{x:i,y:e})=>{f==="select"&&s(W("free")),s(st(r)),N({x:i,y:e}),C({x:0,y:0})},p=(r,{x:i,y:e},c)=>{C({x:(k.x-i)*a/100,y:(k.y-e)*a/100}),f==="free"&&y===r&&([...n.has(y)?[void 0]:[y],...n].filter(l=>t.current.hasNode(l)).forEach(l=>{t.current.updateNodeAttributes(l,x=>({...x,x:z(x.x-(k.x-i)*a/100,c?1:5),y:z(x.y-(k.y-e)*a/100,c?1:5)}))}),s(Mt()),s(gt()))},I=(r,i)=>{if(f.startsWith("line")){g||s(W("free"));const e=[...Object.values(Lt),_t.Virtual],c=t.current.hasNode(y)&&e.includes(t.current.getNodeAttribute(y,"type"));["stn_core_","virtual_circle_"].forEach(x=>{var K,H;const h=(H=(K=document.elementsFromPoint(E.x,E.y)[0].attributes)==null?void 0:K.getNamedItem("id"))==null?void 0:H.value,P=h==null?void 0:h.startsWith(x);if(c&&P){const Q=f.slice(5),Dt="line_".concat(pt(10));t.current.addDirectedEdgeWithKey(Dt,y,h.slice(x.length),{visible:!0,zIndex:0,type:Q,[Q]:structuredClone(D[Q].defaultAttrs),style:tt.SingleColor,[tt.SingleColor]:{color:v},reconcileId:""}),o&&xt.event(mt.ADD_LINE,{type:Q})}}),s(gt()),s(vt(t.current.export()))}else f==="free"&&y&&(w.x===0&&w.y===0?f.startsWith("line")||(i?n.has(r)?s(bt(r)):s(At(r)):n.has(r)||s(Z(new Set([r])))):s(vt(t.current.export())));s(st(void 0))},j=M((r,i)=>{i.shiftKey||s(et()),i.shiftKey&&n.has(r)?s(bt(r)):s(At(r))}),$=M((r,i)=>{T||(i.stopPropagation(),i.currentTarget.setPointerCapture(i.pointerId),L(r,G(i)))}),_=M((r,i)=>{T||(i.stopPropagation(),i.currentTarget.setPointerCapture(i.pointerId),A({x:i.clientX,y:i.clientY}),p(r,G(i),i.altKey))}),q=M((r,i)=>{T||(i.stopPropagation(),i.currentTarget.setPointerCapture(i.pointerId),I(r,i.shiftKey))}),V=M((r,i)=>{T&&(i.stopPropagation(),L(r,nt(i)))}),Y=M((r,i)=>{T&&(i.stopPropagation(),A({x:i.touches[0].clientX,y:i.touches[0].clientY}),p(r,nt(i),i.altKey))}),X=M((r,i)=>{T&&(i.stopPropagation(),I(r,i.shiftKey))}),[ot,rt]=b.useState(kt(t.current)),[R,J]=b.useState(Et(t.current)),[it,ct]=b.useState(wt(t.current)),[at,lt]=b.useState([]),[dt,ut]=b.useState([]);return b.useEffect(()=>{rt(kt(t.current)),J(Et(t.current))},[u]),b.useEffect(()=>{ct(wt(t.current));const{allReconciledLines:r,danglingLines:i}=Gt(t.current);lt(r),ut(i)},[d]),S.jsxs(S.Fragment,{children:[dt.map(r=>{const[i,e]=t.current.extremities(r),c=t.current.getNodeAttributes(i),l=t.current.getNodeAttributes(e);return S.jsx(yt,{id:r,x1:c.x,y1:c.y,x2:l.x,y2:l.y,newLine:!1,type:F.Simple,attrs:D[F.Simple].defaultAttrs,styleType:tt.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:j},r)}),at.map(r=>{var h,P;const i=qt(t.current,r);if(!i)return S.jsx(S.Fragment,{});const e=r.at(0),c=t.current.getEdgeAttribute(e,"type"),l=t.current.getEdgeAttribute(e,"style"),x=t.current.getEdgeAttribute(e,l),m=(P=(h=ht[l])==null?void 0:h.component)!=null?P:jt;return S.jsx(m,{id:e,type:c,path:i,styleAttrs:x,newLine:!1,handleClick:j},e)}),it.map(({edge:r,x1:i,y1:e,x2:c,y2:l,type:x,attr:m,style:h,styleAttr:P})=>S.jsx(yt,{id:r,x1:i,y1:e,x2:c,y2:l,newLine:!1,type:x,attrs:m,styleType:h,styleAttrs:P,handleClick:j},r)),R.map(r=>{var m,h;const{node:i,x:e,y:c,type:l}=r,x=(h=(m=Tt[l])==null?void 0:m.component)!=null?h:Pt;return S.jsx(x,{id:i,x:e,y:c,attrs:r[l],handlePointerDown:$,handlePointerMove:_,handlePointerUp:q,handleTouchStart:V,handleTouchMove:Y,handleTouchEnd:X},i)}),ot.map(r=>{var m,h;const{node:i,x:e,y:c,type:l}=r,x=(h=(m=It[l])==null?void 0:m.component)!=null?h:Pt;return S.jsx(x,{id:i,x:e,y:c,attrs:{[l]:r[l]},handlePointerDown:$,handlePointerMove:_,handlePointerUp:q,handleTouchStart:V,handleTouchMove:Y,handleTouchEnd:X},i)}),f.startsWith("line")&&y&&y!=="background"&&S.jsx(yt,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(y,"x"),y1:t.current.getNodeAttribute(y,"y"),x2:t.current.getNodeAttribute(y,"x")-w.x,y2:t.current.getNodeAttribute(y,"y")-w.y,newLine:!0,type:f.slice(5),attrs:D[f.slice(5)].defaultAttrs,styleType:tt.SingleColor,styleAttrs:{color:v}})]})},ce=()=>{const s=Ct(),t=b.useRef(window.graph),o=()=>{s(Mt()),s(gt()),s(vt(t.current.export()))},{telemetry:{project:a}}=U(e=>e.app),{svgViewBoxZoom:n,svgViewBoxMin:u}=U(e=>e.param),{mode:d,lastTool:f,active:y,selected:g,keepLastPath:v,theme:k,refresh:{nodes:N}}=U(e=>e.runtime),w=Ot(),{height:C,width:E}=Ft(w);b.useEffect(()=>{const e=Vt(t.current);Object.entries(e).filter(([c,l])=>l&&c in Rt).forEach(([c])=>Ut(c))},[N]);const[A,L]=b.useState({x:0,y:0}),[p,I]=b.useState({x:0,y:0}),[j,$]=b.useState({x:0,y:0}),[_,q]=b.useState({x:0,y:0}),V=({x:e,y:c},l)=>{if(d.startsWith("station")){s(W("free"));const x=pt(10),m="stn_".concat(x),h=d.slice(8),P=structuredClone(It[h].defaultAttrs);"color"in P&&(P.color=k);const{x:K,y:H}=O(e,c,n,u);t.current.addNode(m,{visible:!0,zIndex:0,x:z(K,5),y:z(H,5),type:h,[h]:P}),o(),a&&xt.event(mt.ADD_STATION,{type:h}),s(Z(new Set([m])))}else if(d.startsWith("misc-node")){s(W("free"));const x=pt(10),m="misc_node_".concat(x),h=d.slice(10),{x:P,y:K}=O(e,c,n,u);t.current.addNode(m,{visible:!0,zIndex:0,x:z(P,5),y:z(K,5),type:h,[h]:structuredClone(Tt[h].defaultAttrs)}),o(),a&&xt.event(mt.ADD_STATION,{type:h}),s(Z(new Set([m])))}else d==="free"||d.startsWith("line")?(d.startsWith("line")&&(s(W("free")),v&&s(zt(!1))),$({x:e,y:c}),q(u),l||(s(st("background")),s(et()))):d==="select"&&(L(O(e,c,n,u)),I(O(e,c,n,u)))},Y=({x:e,y:c})=>{d==="select"?A.x!=0&&A.y!=0&&I(O(e,c,n,u)):y==="background"&&s(ft({x:_.x+(j.x-e)*n/100,y:_.y+(j.y-c)*n/100}))},X=e=>{if(d==="select"){const c=Yt(t.current,A.x,A.y,p.x,p.y),l=Xt(t.current,new Set(c));s(Z(new Set([...e?g:[],...c,...l]))),s(W("free")),L({x:0,y:0}),I({x:0,y:0})}y==="background"&&!e&&s(st(void 0))},ot=M(e=>{let c=n;e.deltaY>0&&n+10<=390?c=n+10:e.deltaY<0&&n-10>=10&&(c=n-10),s(St(c));const{x:l,y:x}=G(e),m=e.currentTarget.getBoundingClientRect(),[h,P]=[l/m.width,x/m.height];s(ft({x:u.x+l*n/100-E*c/100*h,y:u.y+x*n/100-C*c/100*P}))}),rt=M(async e=>{if(B?e.key==="Backspace":e.key==="Delete")g.size>0&&(g.forEach(c=>{t.current.hasNode(c)?t.current.dropNode(c):t.current.hasEdge(c)&&t.current.dropEdge(c)}),s(et()),o());else if(e.key.startsWith("Arrow")){const l=e.key.endsWith("Left")?-1:e.key.endsWith("Right")?1:0,x=e.key.endsWith("Up")?-1:e.key.endsWith("Down")?1:0;s(ft(O(100*l,100*x,n,u)))}else if(e.key==="i"||e.key==="j"||e.key==="k"||e.key==="l"){const l=(e.key==="j"?-1:e.key==="l"?1:0)*10,x=(e.key==="i"?-1:e.key==="k"?1:0)*10;g.size>0&&g.forEach(m=>{t.current.hasNode(m)&&(t.current.updateNodeAttribute(m,"x",h=>(h!=null?h:0)+l),t.current.updateNodeAttribute(m,"y",h=>(h!=null?h:0)+x),o())})}else if(e.key==="f"&&f)s(W(f));else if(e.key==="z"&&(B?e.metaKey&&!e.shiftKey:e.ctrlKey))B&&e.preventDefault(),s(Kt());else if(e.key==="s")s(W("select"));else if((e.key==="c"||e.key==="x")&&(B?e.metaKey&&!e.shiftKey:e.ctrlKey)){const c=$t(t.current,g);navigator.clipboard.writeText(c),e.key==="x"&&(s(et()),g.forEach(l=>{t.current.hasNode(l)?t.current.dropNode(l):t.current.hasEdge(l)&&t.current.dropEdge(l)}),o())}else if(e.key==="v"&&(B?e.metaKey&&!e.shiftKey:e.ctrlKey)){const c=await navigator.clipboard.readText(),{x:l,y:x}=O(E/2,C/2,n,u),{nodes:m,edges:h}=Bt(c,t.current,z(l,5),z(x,5));o();const P=structuredClone(m);h.forEach(K=>P.add(K)),s(Z(P))}else(B&&e.key==="z"&&e.metaKey&&e.shiftKey||!B&&e.key==="y"&&e.ctrlKey)&&s(Wt())}),[R,J]=b.useState(-1),it=M(e=>!T&&V(G(e),e.shiftKey)),ct=M(e=>!T&&Y(G(e))),at=M(e=>!T&&X(e.shiftKey)),lt=M(e=>{if(T){if(e.touches.length===1)V(nt(e),e.shiftKey);else if(e.touches.length===2){const[c,l]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY];J(c*c+l*l)}}}),dt=M(e=>{if(T){if(R===-1)Y(nt(e));else if(e.touches.length===2){const[c,l]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY],x=c*c+l*l;let m=n;x-R<0&&n+10<=390?m=n+10:x-R>0&&n-10>=10&&(m=n-10),s(St(m))}}}),ut=M(e=>{T&&(R===-1?X(e.shiftKey):J(-1))}),[r,i]=b.useState({sx:0,sy:0,ex:0,ey:0});return b.useEffect(()=>{i({sx:A.x<=p.x?A.x:p.x,ex:A.x>p.x?A.x:p.x,sy:A.y<=p.y?A.y:p.y,ey:A.y>p.y?A.y:p.y})},[p.x,p.y]),S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:C,width:E,viewBox:"".concat(u.x," ").concat(u.y," ").concat(E*n/100," ").concat(C*n/100),onPointerDown:it,onPointerMove:ct,onPointerUp:at,onTouchStart:lt,onTouchMove:dt,onTouchEnd:ut,onWheel:ot,tabIndex:0,onKeyDown:rt,children:[S.jsx(Qt,{}),d==="select"&&A.x!=0&&A.y!=0&&S.jsx("rect",{x:r.sx,y:r.sy,width:r.ex-r.sx,height:r.ey-r.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),S.jsx("defs",{children:S.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[S.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),S.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{ce as default};
