import{j as P}from"./chakra-xNcrfRXW.js";import{a3 as Et,ap as kt,aq as Wt,N as Lt,k as J,l as O,ar as Rt,as as Ot,at as Pt,S as Xt,au as Ct,c as Bt,d as st,av as V,aw as q,ax as lt,T as it,ay as Nt,az as _t,aA as X,q as dt,t as ct,n as at,m as Ft,o as zt,r as ut,E as ft,v as St,y as bt,U as Y,aB as Ut,p as Yt,aC as Vt,a0 as Qt,a1 as Gt,A as vt,z as Mt,a9 as nt,am as Zt,an as qt}from"./index-78E8Baze.js";import{S as $t,s as ht,u as Jt,f as te,F as ee,l as ne,b as se,c as oe}from"./master-manager-_OL7eZjs.js";import{r as re,f as Ht,b as M}from"./react-D-_si4LB.js";import{u as K,e as ie,i as ae}from"./clipboard-Bar1F82B.js";import{m as yt}from"./misc-nodes-NsOqMeLv.js";var ce=function(t,e){var c=typeof Symbol=="function"&&t[Symbol.iterator];if(!c)return t;var a=c.call(t),s,d=[],r;try{for(;(e===void 0||e-- >0)&&!(s=a.next()).done;)d.push(s.value)}catch(u){r={error:u}}finally{try{s&&!s.done&&(c=a.return)&&c.call(a)}finally{if(r)throw r.error}}return d};function le(t){var e=t.children,c=ce(re.useState(Math.random()),2),a=c[0],s=c[1];return P.jsx($t.Provider,{value:{updateId:a,update:function(){return s(Math.random())}},children:e})}const de={[Et.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Et.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ue=t=>{const e=de[t];return e.at(Math.floor(Math.random()*e.length))},Dt=Ht("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:c,rejectWithValue:a})=>{const{token:s}=e().account;if(!s){c(kt({cityName:t,names:[]}));return}const d=await fetch("".concat(Wt,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(s)}});if(!d.ok)return Lt.warn("Failed to fetch random station names",d.statusText),a(d.statusText);const r=await d.json();c(kt({cityName:t,names:r}))}),jt=Ht("runtime/getOneStationName",async(t,{getState:e,dispatch:c})=>{var u;const{stationNames:a}=e().runtime,s=a[t];if(((u=s==null?void 0:s.length)!=null?u:0)==0)return Lt.debug("No random station names in cache, using fallback"),c(Dt({cityName:t})),Object.values(ue(t));const d=structuredClone(s),r=d.shift();return c(kt({cityName:t,names:d})),d.length<3&&c(Dt({cityName:t})),Object.values(r)}),Kt=(t,e,c,a,s,d,r)=>{if(!("offsetFrom"in d)||!("offsetTo"in d)||Number.isNaN(d.offsetFrom)||Number.isNaN(d.offsetTo))return;if(d.offsetFrom===d.offsetTo)return Tt(t,e,c,a,s)?r<0?{x1:e,y1:c,x2:a,y2:s,offset:d.offsetFrom}:e===a?{x1:e+5*r,y1:c,x2:a+5*r,y2:s,offset:d.offsetFrom}:c===s?{x1:e,y1:c+5*r,x2:a,y2:s+5*r,offset:d.offsetFrom}:{x1:e+5*Math.SQRT1_2*r,y1:c+5*Math.SQRT1_2*r,x2:a+5*Math.SQRT1_2*r,y2:s+5*Math.SQRT1_2*r,offset:d.offsetFrom}:void 0;const[u,o]=[d.offsetFrom,d.offsetTo];for(let g=0;g<Math.PI;g+=Math.PI/8)for(let l=g,h=0;h<2;h++,l+=Math.PI){const[A,v,S,_]=[Math.sin(g)*u,Math.cos(g)*u,Math.sin(l)*o,Math.cos(l)*o];if(Tt(t,e+A,c+v,a+S,s+_))return{x1:e+A,y1:c+v,x2:a+S,y2:s+_,offset:0}}},Tt=(t,e,c,a,s)=>!!((e===a||c===s)&&[J.Diagonal,J.Perpendicular].includes(t)||Math.abs((s-c)/(a-e))===1&&[J.Diagonal,J.RotatePerpendicular].includes(t)),fe=(t,e)=>{const c=[],a=[];return Object.values(e).forEach(s=>{var L;if(s.length===1){a.push(...s.map(y=>y.edge));return}const d=t.getEdgeAttribute(s.at(0),"type");if(!s.every(y=>t.getEdgeAttribute(y,"type")===d)){a.push(...s.map(y=>y.edge));return}const r=t.getEdgeAttribute(s.at(0),"style");if(!s.every(y=>t.getEdgeAttribute(y,"style")===r)){a.push(...s.map(y=>y.edge));return}const u={},o=new Set,g=new Set,l=Object.fromEntries(s.map(y=>{var m,k;const[E,i]=t.extremities(y);return u[E]=((m=u[E])!=null?m:0)+1,u[i]=((k=u[i])!=null?k:0)+1,o.add(E),g.add(i),[E,[y.edge,i]]})),h=Array.from(o).filter(y=>u[y]===1),A=Array.from(g).filter(y=>u[y]===1);if(h.length!==1||A.length!==1){a.push(...s.map(y=>y.edge));return}const v=h[0],S=A[0];if(v===S){a.push(...s.map(y=>y.edge));return}const _=[l[v][0]];let j=l[v][1];for(let y=1;y<s.length;y=y+1){const E=(L=l[j])==null?void 0:L.at(1);if(!E){a.push(...s.map(i=>i.edge));return}_.push(l[j][0]),j=E}if(j!==S||_.length!==s.length){a.push(...s.map(y=>y.edge));return}c.push(_)}),{allReconciledLines:c,danglingLines:a}},he=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const c=e.map(s=>{var v,S,_;const[d,r]=t.extremities(s),u=t.getNodeAttributes(d),o=t.getNodeAttributes(r),{type:g,parallelIndex:l}=t.getEdgeAttributes(s),h=(v=t.getEdgeAttribute(s,g))!=null?v:O[g].defaultAttrs,A=Kt(g,u.x,u.y,o.x,o.y,h,l);if(A){const{x1:j,y1:L,x2:y,y2:E,offset:i}=A;return O[J.Simple].generatePath(j,y,L,E,{offset:i})}return(_=(S=O[g])==null?void 0:S.generatePath(u.x,o.x,u.y,o.y,h))!=null?_:"M ".concat(u.x," ").concat(u.y," L ").concat(o.x," ").concat(o.y)});let a="".concat(c[0]," ");for(let s=1;s<e.length;s=s+1)a+=c[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return a},ye=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),pe=t=>{const e={},c=[],a={},s=[];for(const o of t.edgeEntries()){const[g,l,h,A]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],v=Kt(o.attributes.type,g,l,h,A,o.attributes[o.attributes.type],o.attributes.parallelIndex);if(!v){if(o.attributes.parallelIndex>=0){c.push(o);continue}}if(o.attributes.reconcileId!==""){const S=o.attributes.reconcileId;S in a?a[S].push(o):a[S]=[o];continue}if(v){const S=o.edge,_=o.attributes,{x1:j,y1:L,x2:y,y2:E,offset:i}=v;e[S]={id:S,attr:_,path:O[J.Simple].generatePath(j,y,L,E,{offset:i})};continue}s.push(o)}const d=new Set;for(;c.length;){const o=c.pop();if(d.has(o.edge))continue;const{normal:g,parallel:l}=Rt(t,o);if(!l.length)continue;l.forEach(A=>d.add(A.edge)),s.push(...g);const h=Ot(l);for(const A of l){const v=A.edge;e[v]={id:A.edge,attr:A.attributes,path:h[v]}}}const{allReconciledLines:r,danglingLines:u}=fe(t,a);for(const o of r){const g=he(t,o);if(!g)continue;const l=o[0];e[l]={id:l,attr:t.getEdgeAttributes(l),path:g}}for(const o of u){const g=t.getEdgeAttributes(o),[l,h]=t.extremities(o),A=t.getNodeAttributes(l),v=t.getNodeAttributes(h);e[o]={id:o,attr:g,path:O[J.Simple].generatePath(A.x,v.x,A.y,v.y,O[J.Simple].defaultAttrs)}}for(const o of s){const g=o.edge,l=o.attributes.type,h=o.attributes,[A,v,S,_]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(l in O)){e[g]={id:g,attr:h,path:"M ".concat(A," ").concat(v," L ").concat(S," ").concat(_)};continue}e[g]={id:g,attr:h,path:O[l].generatePath(A,S,v,_,h[l])}}return Object.values(e).map(o=>({id:o.id,type:"line",line:o}))},It=t=>{const{id:e,x:c,y:a,handlePointerDown:s,handlePointerMove:d,handlePointerUp:r}=t,u=M.useCallback(l=>s(e,l),[e,s]),o=M.useCallback(l=>d(e,l),[e,d]),g=M.useCallback(l=>r(e,l),[e,r]);return P.jsx("g",{id:e,transform:"translate(".concat(c-6.4," ").concat(a-6.4,")scale(0.025)"),onPointerDown:u,onPointerMove:o,onPointerUp:g,style:{cursor:"move"},children:P.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ge=t=>{const{id:e,path:c,handlePointerDown:a}=t,s=M.useCallback(d=>a(e,d),[e,a]);return P.jsx("path",{id:e,d:c,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},me=M.memo(t=>{var o,g,l,h,A,v,S,_,j,L,y,E;const{elements:e,handlePointerDown:c,handlePointerMove:a,handlePointerUp:s,handleEdgePointerDown:d}=t,r=Object.fromEntries(Array.from({length:21},(i,m)=>[m-10,{pre:[],main:[],post:[]}]));for(const i of e)if(i.type==="line"){const m=i.line.attr.type,k=i.line.attr.style,B=i.line.attr[k],f=(o=Pt[k])==null?void 0:o.preComponent;f&&r[i.line.attr.zIndex].pre.push(P.jsx(f,{id:i.id,type:m,path:i.line.path,styleAttrs:B,newLine:!1,handlePointerDown:d},"".concat(i.id,".pre")));const b=(l=(g=Pt[k])==null?void 0:g.component)!=null?l:ge;r[i.line.attr.zIndex].main.push(P.jsx(b,{id:i.id,type:m,path:i.line.path,styleAttrs:B,newLine:!1,handlePointerDown:d},i.id));const C=(h=Pt[k])==null?void 0:h.postComponent;C&&r[i.line.attr.zIndex].post.push(P.jsx(C,{id:i.id,type:m,path:i.line.path,styleAttrs:B,newLine:!1,handlePointerDown:d},"".concat(i.id,".post")))}else if(i.type==="station"){const m=i.station,k=m.type,B=(A=ht[k])==null?void 0:A.preComponent;B&&r[i.station.zIndex].pre.push(P.jsx(B,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},"".concat(i.id,".pre")));const f=(S=(v=ht[k])==null?void 0:v.component)!=null?S:It;r[i.station.zIndex].main.push(P.jsx(f,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},i.id));const b=(_=ht[k])==null?void 0:_.postComponent;b&&r[i.station.zIndex].post.push(P.jsx(b,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},"".concat(i.id,".post")))}else if(i.type==="misc-node"){const m=i.miscNode,k=m.type,B=(j=yt[k])==null?void 0:j.preComponent;B&&r[i.miscNode.zIndex].pre.push(P.jsx(B,{id:i.id,x:m.x,y:m.y,attrs:m[k],handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},"".concat(i.id,".pre")));const f=(y=(L=yt[k])==null?void 0:L.component)!=null?y:It;r[i.miscNode.zIndex].main.push(P.jsx(f,{id:i.id,x:m.x,y:m.y,attrs:m[k],handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},i.id));const b=(E=yt[k])==null?void 0:E.postComponent;b&&r[i.miscNode.zIndex].post.push(P.jsx(b,{id:i.id,x:m.x,y:m.y,attrs:m[k],handlePointerDown:c,handlePointerMove:a,handlePointerUp:s},"".concat(i.id,".post")))}return Array.from({length:21},(i,m)=>(m-10).toString()).map(i=>[...r[i].pre,...r[i].main,...r[i].post]).flat()},(t,e)=>t.elements===e.elements),xe=[...Object.values(Xt),Ct.Virtual,Ct.Master,Ct.LondonArrow],ve=()=>{const t=Bt(),e=M.useRef(window.graph),c=()=>{t(dt()),t(ct()),t(St(e.current.export()))},{telemetry:{project:a},preference:{autoParallel:s}}=st(f=>f.app),{svgViewBoxZoom:d,svgViewBoxMin:r}=st(f=>f.param),{selected:u,refresh:{nodes:o,edges:g},mode:l,active:h,keepLastPath:A,theme:v}=st(f=>f.runtime),[S,_]=M.useState({x:0,y:0}),[j,L]=M.useState({x:0,y:0}),y=K((f,b)=>{b.stopPropagation(),l==="select"&&t(V("free"));const C=b.currentTarget,{x:$,y:T}=q(b);C.setPointerCapture(b.pointerId),_({x:$,y:T}),t(lt(f)),b.shiftKey?u.has(f)?t(Nt(f)):t(_t(f)):u.has(f)||t(it(new Set([f])))}),E=K((f,b)=>{const{x:C,y:$}=q(b);l==="free"&&h===f?(u.forEach(T=>{e.current.hasNode(T)&&e.current.updateNodeAttributes(T,F=>({...F,x:X(F.x-(S.x-C)*d/100,b.altKey?1:5),y:X(F.y-(S.y-$)*d/100,b.altKey?1:5)}))}),t(dt()),t(ct())):l.startsWith("line")&&L({x:(S.x-C)*d/100,y:(S.y-$)*d/100})}),i=K((f,b)=>{if(l.startsWith("line")){A||t(V("free"));const C=e.current.hasNode(h)&&xe.includes(e.current.getNodeAttribute(h,"type"));["stn_core_","virtual_circle_"].forEach(T=>{var ot,rt;const H=(rt=(ot=document.elementsFromPoint(b.clientX,b.clientY)[0].attributes)==null?void 0:ot.getNamedItem("id"))==null?void 0:rt.value,U=H==null?void 0:H.startsWith(T);if(C&&U){const W=l.slice(5),tt="line_".concat(at(10)),[et,I]=[h,H.slice(T.length)],R=s?Ft(e.current,W,et,I,"from"):-1;e.current.addDirectedEdgeWithKey(tt,et,I,{visible:!0,zIndex:0,type:W,[W]:structuredClone(O[W].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:v},reconcileId:"",parallelIndex:R}),a&&ut.event(ft.ADD_LINE,{type:W})}}),t(ct()),t(St(e.current.export()))}else if(l==="free"&&h){const{x:C,y:$}=q(b);S.x-C===0&&S.y-$===0||t(St(e.current.export()))}t(lt(void 0))}),m=K((f,b)=>{if(b.stopPropagation(),b.shiftKey||t(bt()),b.shiftKey&&u.has(f)?t(Nt(f)):t(_t(f)),l.startsWith("station")||l.startsWith("misc-node-virtual")||l.startsWith("misc-node-master")){const C=b.clientX-document.getElementById("canvas").getBoundingClientRect().left,$=b.clientY-document.getElementById("canvas").getBoundingClientRect().top,T=l.startsWith("station"),F=at(10),H=T?"stn_".concat(F):"misc_node_".concat(F),U=T?l.slice(8):l.slice(10),{x:ot,y:rt}=Y(C,$,d,r),W=T?structuredClone(ht[U].defaultAttrs):structuredClone(yt[U].defaultAttrs);"color"in W&&(W.color=v),e.current.addNode(H,{visible:!0,zIndex:0,x:X(ot,5),y:X(rt,5),type:U,[U]:W});const tt=e.current.getEdgeAttributes(f),{zIndex:et,type:I,style:R}=tt,pt=tt[I],gt=tt[R],[At,Q]=e.current.extremities(f),mt=s?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),At,H,{visible:!0,zIndex:et,type:I,[I]:structuredClone(pt),style:R,[R]:structuredClone(gt),reconcileId:"",parallelIndex:mt}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),H,Q,{visible:!0,zIndex:et,type:I,[I]:structuredClone(pt),style:R,[R]:structuredClone(gt),reconcileId:"",parallelIndex:mt}),e.current.dropEdge(f),c(),a&&(ut.event(ft.ADD_STATION,{type:U}),ut.event(ft.ADD_LINE,{type:I})),t(V("free")),t(it(new Set([H])))}}),k=M.useMemo(()=>[...pe(e.current),...ye(e.current)],[g,o]),B=Ut.component;return P.jsxs(P.Fragment,{children:[P.jsx(me,{elements:k,handlePointerDown:y,handlePointerMove:E,handlePointerUp:i,handleEdgePointerDown:m}),l.startsWith("line")&&h&&h!=="background"&&P.jsx(B,{id:"line_create_in_progress___no_use",type:l.slice(5),path:O[l.slice(5)].generatePath(e.current.getNodeAttribute(h,"x"),e.current.getNodeAttribute(h,"x")-j.x,e.current.getNodeAttribute(h,"y"),e.current.getNodeAttribute(h,"y")-j.y,O[l.slice(5)].defaultAttrs),styleAttrs:{color:v},newLine:!0,handlePointerDown:()=>{}})]})},Ee=()=>{const t=Bt(),e=M.useRef(window.graph),c=()=>{t(dt()),t(ct()),t(St(e.current.export()))},{activeSubscriptions:a}=st(n=>n.account),{telemetry:{project:s},preference:{randomStationsNames:d}}=st(n=>n.app),{svgViewBoxZoom:r,svgViewBoxMin:u}=st(n=>n.param),{mode:o,lastTool:g,active:l,selected:h,keepLastPath:A,theme:v,refresh:{nodes:S},masterNodesCount:_,parallelLinesCount:j}=st(n=>n.runtime),L=Jt(),{height:y,width:E}=Yt(L),i=!a.RMP_CLOUD&&_+1>Vt,m=!a.RMP_CLOUD&&j+1>Qt,k=!a.RMP_CLOUD||d==="none";M.useEffect(()=>{const n=te(e.current);Object.entries(n).filter(([p,x])=>x&&p in ee).forEach(([p])=>ne(p))},[S]);const{update:B}=M.useContext($t);M.useEffect(()=>{document.fonts.load("12px Arial","ABCDEFG123456").finally(()=>setTimeout(B,100))},[]);const[f,b]=M.useState({x:0,y:0}),[C,$]=M.useState({x:0,y:0}),[T,F]=M.useState({x:0,y:0}),[H,U]=M.useState({x:0,y:0}),ot=K(async n=>{const{x:p,y:x}=q(n);if(o.startsWith("station")){t(V("free"));const D=at(10),N="stn_".concat(D),w=o.slice(8),z=structuredClone(ht[w].defaultAttrs);if("color"in z&&(z.color=v),!k){const xt=await t(jt(Et.Shmetro));if(jt.fulfilled.match(xt)){const Z=xt.payload;z.names.length>Z.length?Z.push(...Array(z.names.length-Z.length).fill(Z.at(-1))):z.names.length<Z.length&&Z.splice(z.names.length,Z.length-z.names.length),z.names=Z}}const{x:G,y:wt}=Y(p,x,r,u);e.current.addNode(N,{visible:!0,zIndex:0,x:X(G,5),y:X(wt,5),type:w,[w]:z}),c(),s&&ut.event(ft.ADD_STATION,{type:w}),t(it(new Set([N])))}else if(o.startsWith("misc-node")){t(V("free"));const D=at(10),N="misc_node_".concat(D),w=o.slice(10),{x:z,y:G}=Y(p,x,r,u);e.current.addNode(N,{visible:!0,zIndex:0,x:X(z,5),y:X(G,5),type:w,[w]:structuredClone(yt[w].defaultAttrs)}),c(),s&&ut.event(ft.ADD_STATION,{type:w}),t(it(new Set([N])))}else o==="free"||o.startsWith("line")?(o.startsWith("line")&&(t(V("free")),A&&t(Gt(!1))),F({x:p,y:x}),U(u),n.shiftKey||(t(lt("background")),t(bt()))):o==="select"&&(b(Y(p,x,r,u)),$(Y(p,x,r,u)))}),rt=K(n=>{if(o==="select"){if(f.x!=0&&f.y!=0){const{x:p,y:x}=q(n);$(Y(p,x,r,u))}}else if(l==="background"){const{x:p,y:x}=q(n);t(vt({x:H.x+(T.x-p)*r/100,y:H.y+(T.y-x)*r/100}))}}),W=K(n=>{if(o==="select"){const{x:p,y:x}=q(n),{x:D,y:N}=Y(p,x,r,u),w=se(e.current,f.x,f.y,D,N),z=oe(e.current,new Set(w));t(it(new Set([...n.shiftKey?h:[],...w,...z]))),t(V("free")),b({x:0,y:0}),$({x:0,y:0})}l==="background"&&!n.shiftKey&&t(lt(void 0))}),tt=K(n=>{let p=r;n.deltaY>0&&r+10<400?p=r+10:n.deltaY<0&&r-10>0&&(p=r-10),t(Mt(p));const{x,y:D}=q(n),N=n.currentTarget.getBoundingClientRect(),[w,z]=[x/N.width,D/N.height];t(vt({x:u.x+x*r/100-E*p/100*w,y:u.y+D*r/100-y*p/100*z}))}),et=K(async n=>{if(nt?n.key==="Backspace":n.key==="Delete")h.size>0&&(h.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(bt()),c());else if(n.key.startsWith("Arrow")){const x=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,D=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(vt(Y(100*x,100*D,r,u)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const x=(n.key==="j"?-1:n.key==="l"?1:0)*10,D=(n.key==="i"?-1:n.key==="k"?1:0)*10;h.size>0&&h.forEach(N=>{e.current.hasNode(N)&&(e.current.updateNodeAttribute(N,"x",w=>(w!=null?w:0)+x),e.current.updateNodeAttribute(N,"y",w=>(w!=null?w:0)+D),c())})}else if(n.key==="f"&&g)t(V(g));else if(n.key==="z"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey))nt&&n.preventDefault(),t(Zt()),t(dt()),t(ct());else if(n.key==="s")t(V("select"));else if((n.key==="c"||n.key==="x")&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=ie(e.current,h);navigator.clipboard.writeText(p),n.key==="x"&&(t(bt()),h.forEach(x=>{e.current.hasNode(x)?e.current.dropNode(x):e.current.hasEdge(x)&&e.current.dropEdge(x)}),c())}else if(n.key==="v"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x,y:D}=Y(E/2,y/2,r,u),{nodes:N,edges:w}=ae(p,e.current,i,m,X(x,5),X(D,5));c();const z=structuredClone(N);w.forEach(G=>z.add(G)),t(it(z))}else(nt&&n.key==="z"&&n.metaKey&&n.shiftKey||!nt&&n.key==="y"&&n.ctrlKey)&&(t(qt()),t(dt()),t(ct()))}),[I,R]=M.useState(0),pt=K(n=>{if(n.touches.length===2){t(lt(void 0));const[p,x]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];R(p*p+x*x)}}),gt=K(n=>{if(I!==0&&n.touches.length===2){const[p,x]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],D=p*p+x*x;let N=r;D-I<0&&r+10<=390?N=r+10:D-I>0&&r-10>=10&&(N=r-10),t(Mt(N)),R(D);const w=n.currentTarget.getBoundingClientRect(),[z,G]=[(n.touches[0].clientX+n.touches[1].clientX)/2-w.left,(n.touches[0].clientY+n.touches[1].clientY)/2-w.top],[wt,xt]=[z/w.width,G/w.height];t(vt({x:u.x+z*r/100-E*N/100*wt,y:u.y+G*r/100-y*N/100*xt}))}}),At=K(n=>{I!==0&&R(0)}),[Q,mt]=M.useState({sx:0,sy:0,ex:0,ey:0});return M.useEffect(()=>{mt({sx:f.x<=C.x?f.x:C.x,ex:f.x>C.x?f.x:C.x,sy:f.y<=C.y?f.y:C.y,ey:f.y>C.y?f.y:C.y})},[C.x,C.y]),P.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:y,width:E,viewBox:"".concat(u.x," ").concat(u.y," ").concat(E*r/100," ").concat(y*r/100),onPointerDown:ot,onPointerMove:rt,onPointerUp:W,onTouchStart:pt,onTouchMove:gt,onTouchEnd:At,onWheel:tt,tabIndex:0,onKeyDown:et,children:[P.jsx(le,{children:P.jsx(ve,{})}),o==="select"&&f.x!=0&&f.y!=0&&P.jsx("rect",{x:Q.sx,y:Q.sy,width:Q.ex-Q.sx,height:Q.ey-Q.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),P.jsx("defs",{children:P.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[P.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),P.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ee as default};
