import{j as E}from"./chakra-t2DzLzXq.js";import{k as q,l as O,ao as Mt,ap as _t,aq as bt,S as jt,ar as vt,c as Ct,d as st,as as J,at as tt,au as ct,T as ot,av as At,aw as St,ax as It,ay as U,q as at,t as it,n as rt,m as Lt,o as Pt,r as lt,E as dt,v as pt,y as gt,U as H,az as Tt,p as $t,aA as Wt,a0 as Kt,a1 as Bt,A as ht,z as wt,a9 as et,al as zt,am as Ot}from"./index-FwaIs908.js";import{b as _}from"./react-DmTIgZys.js";import{u as F,e as Xt,i as Yt}from"./clipboard-BZtuEOlM.js";import{s as ut,g as Rt,b as Ft,c as Ut,e as Vt,u as Zt,f as Qt,F as qt,l as Gt,h as Ht,j as Jt}from"./master-manager-CcOdAp8F.js";import{m as ft}from"./misc-nodes-Dcj_gRl8.js";const Nt=(s,e,p,u,i,c,a)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return Et(s,e,p,u,i)?a<0?{x1:e,y1:p,x2:u,y2:i,offset:c.offsetFrom}:e===u?{x1:e+5*a,y1:p,x2:u+5*a,y2:i,offset:c.offsetFrom}:p===i?{x1:e,y1:p+5*a,x2:u,y2:i+5*a,offset:c.offsetFrom}:{x1:e+5*Math.SQRT1_2*a,y1:p+5*Math.SQRT1_2*a,x2:u+5*Math.SQRT1_2*a,y2:i+5*Math.SQRT1_2*a,offset:c.offsetFrom}:void 0;const[b,o]=[c.offsetFrom,c.offsetTo];for(let m=0;m<Math.PI;m+=Math.PI/8)for(let f=m,g=0;g<2;g++,f+=Math.PI){const[x,S,P,M]=[Math.sin(m)*b,Math.cos(m)*b,Math.sin(f)*o,Math.cos(f)*o];if(Et(s,e+x,p+S,u+P,i+M))return{x1:e+x,y1:p+S,x2:u+P,y2:i+M,offset:0}}},Et=(s,e,p,u,i)=>!!((e===u||p===i)&&[q.Diagonal,q.Perpendicular].includes(s)||Math.abs((i-p)/(u-e))===1&&[q.Diagonal,q.RotatePerpendicular].includes(s)),te=(s,e)=>{const p=[],u=[];return Object.values(e).forEach(i=>{var L;if(i.length===1){u.push(...i.map(h=>h.edge));return}const c=s.getEdgeAttribute(i.at(0),"type");if(!i.every(h=>s.getEdgeAttribute(h,"type")===c)){u.push(...i.map(h=>h.edge));return}const a=s.getEdgeAttribute(i.at(0),"style");if(!i.every(h=>s.getEdgeAttribute(h,"style")===a)){u.push(...i.map(h=>h.edge));return}const b={},o=new Set,m=new Set,f=Object.fromEntries(i.map(h=>{var l,k;const[j,n]=s.extremities(h);return b[j]=((l=b[j])!=null?l:0)+1,b[n]=((k=b[n])!=null?k:0)+1,o.add(j),m.add(n),[j,[h.edge,n]]})),g=Array.from(o).filter(h=>b[h]===1),x=Array.from(m).filter(h=>b[h]===1);if(g.length!==1||x.length!==1){u.push(...i.map(h=>h.edge));return}const S=g[0],P=x[0];if(S===P){u.push(...i.map(h=>h.edge));return}const M=[f[S][0]];let N=f[S][1];for(let h=1;h<i.length;h=h+1){const j=(L=f[N])==null?void 0:L.at(1);if(!j){u.push(...i.map(n=>n.edge));return}M.push(f[N][0]),N=j}if(N!==P||M.length!==i.length){u.push(...i.map(h=>h.edge));return}p.push(M)}),{allReconciledLines:p,danglingLines:u}},ee=(s,e)=>{if(!e.every(i=>s.hasEdge(i)))return;const p=e.map(i=>{var S,P,M;const[c,a]=s.extremities(i),b=s.getNodeAttributes(c),o=s.getNodeAttributes(a),{type:m,parallelIndex:f}=s.getEdgeAttributes(i),g=(S=s.getEdgeAttribute(i,m))!=null?S:O[m].defaultAttrs,x=Nt(m,b.x,b.y,o.x,o.y,g,f);if(x){const{x1:N,y1:L,x2:h,y2:j,offset:n}=x;return O[q.Simple].generatePath(N,h,L,j,{offset:n})}return(M=(P=O[m])==null?void 0:P.generatePath(b.x,o.x,b.y,o.y,g))!=null?M:"M ".concat(b.x," ").concat(b.y," L ").concat(o.x," ").concat(o.y)});let u="".concat(p[0]," ");for(let i=1;i<e.length;i=i+1)u+=p[i].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return u},se=s=>[...s.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ne=s=>{const e={},p=[],u={},i=[];for(const o of s.edgeEntries()){const[m,f,g,x]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],S=Nt(o.attributes.type,m,f,g,x,o.attributes[o.attributes.type],o.attributes.parallelIndex);if(!S){if(o.attributes.parallelIndex>=0){p.push(o);continue}}if(o.attributes.reconcileId!==""){const P=o.attributes.reconcileId;P in u?u[P].push(o):u[P]=[o];continue}if(S){const P=o.edge,M=o.attributes,{x1:N,y1:L,x2:h,y2:j,offset:n}=S;e[P]={id:P,attr:M,path:O[q.Simple].generatePath(N,h,L,j,{offset:n})};continue}i.push(o)}const c=new Set;for(;p.length;){const o=p.pop();if(c.has(o.edge))continue;const{normal:m,parallel:f}=Mt(s,o);if(!f.length)continue;f.forEach(x=>c.add(x.edge)),i.push(...m);const g=_t(f);for(const x of f){const S=x.edge;e[S]={id:x.edge,attr:x.attributes,path:g[S]}}}const{allReconciledLines:a,danglingLines:b}=te(s,u);for(const o of a){const m=ee(s,o);if(!m)continue;const f=o[0];e[f]={id:f,attr:s.getEdgeAttributes(f),path:m}}for(const o of b){const m=s.getEdgeAttributes(o),[f,g]=s.extremities(o),x=s.getNodeAttributes(f),S=s.getNodeAttributes(g);e[o]={id:o,attr:m,path:O[q.Simple].generatePath(x.x,S.x,x.y,S.y,O[q.Simple].defaultAttrs)}}for(const o of i){const m=o.edge,f=o.attributes.type,g=o.attributes,[x,S,P,M]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(f in O)){e[m]={id:m,attr:g,path:"M ".concat(x," ").concat(S," L ").concat(P," ").concat(M)};continue}e[m]={id:m,attr:g,path:O[f].generatePath(x,P,S,M,g[f])}}return Object.values(e).map(o=>({id:o.id,type:"line",line:o}))},kt=s=>{const{id:e,x:p,y:u,handlePointerDown:i,handlePointerMove:c,handlePointerUp:a}=s,b=_.useCallback(f=>i(e,f),[e,i]),o=_.useCallback(f=>c(e,f),[e,c]),m=_.useCallback(f=>a(e,f),[e,a]);return E.jsx("g",{id:e,transform:"translate(".concat(p-6.4," ").concat(u-6.4,")scale(0.025)"),onPointerDown:b,onPointerMove:o,onPointerUp:m,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},oe=s=>{const{id:e,path:p,handlePointerDown:u}=s,i=_.useCallback(c=>u(e,c),[e,u]);return E.jsx("path",{id:e,d:p,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},re=_.memo(s=>{var o,m,f,g,x,S,P,M,N,L,h,j;const{elements:e,handlePointerDown:p,handlePointerMove:u,handlePointerUp:i,handleEdgePointerDown:c}=s,a=Object.fromEntries(Array.from({length:21},(n,l)=>[l-10,{pre:[],main:[],post:[]}]));for(const n of e)if(n.type==="line"){const l=n.line.attr.type,k=n.line.attr.style,D=n.line.attr[k],X=(o=bt[k])==null?void 0:o.preComponent;X&&a[n.line.attr.zIndex].pre.push(E.jsx(X,{id:n.id,type:l,path:n.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},"".concat(n.id,".pre")));const Y=(f=(m=bt[k])==null?void 0:m.component)!=null?f:oe;a[n.line.attr.zIndex].main.push(E.jsx(Y,{id:n.id,type:l,path:n.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},n.id));const nt=(g=bt[k])==null?void 0:g.postComponent;nt&&a[n.line.attr.zIndex].post.push(E.jsx(nt,{id:n.id,type:l,path:n.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},"".concat(n.id,".post")))}else if(n.type==="station"){const l=n.station,k=l.type,D=(x=ut[k])==null?void 0:x.preComponent;D&&a[n.station.zIndex].pre.push(E.jsx(D,{id:n.id,x:l.x,y:l.y,attrs:l,handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},"".concat(n.id,".pre")));const X=(P=(S=ut[k])==null?void 0:S.component)!=null?P:kt;a[n.station.zIndex].main.push(E.jsx(X,{id:n.id,x:l.x,y:l.y,attrs:l,handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},n.id));const Y=(M=ut[k])==null?void 0:M.postComponent;Y&&a[n.station.zIndex].post.push(E.jsx(Y,{id:n.id,x:l.x,y:l.y,attrs:l,handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},"".concat(n.id,".post")))}else if(n.type==="misc-node"){const l=n.miscNode,k=l.type,D=(N=ft[k])==null?void 0:N.preComponent;D&&a[n.miscNode.zIndex].pre.push(E.jsx(D,{id:n.id,x:l.x,y:l.y,attrs:l[k],handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},"".concat(n.id,".pre")));const X=(h=(L=ft[k])==null?void 0:L.component)!=null?h:kt;a[n.miscNode.zIndex].main.push(E.jsx(X,{id:n.id,x:l.x,y:l.y,attrs:l[k],handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},n.id));const Y=(j=ft[k])==null?void 0:j.postComponent;Y&&a[n.miscNode.zIndex].post.push(E.jsx(Y,{id:n.id,x:l.x,y:l.y,attrs:l[k],handlePointerDown:p,handlePointerMove:u,handlePointerUp:i},"".concat(n.id,".post")))}return Array.from({length:21},(n,l)=>(l-10).toString()).map(n=>[...a[n].pre,...a[n].main,...a[n].post]).flat()},(s,e)=>s.elements===e.elements),ie=[...Object.values(jt),vt.Virtual,vt.Master,vt.LondonArrow],ce=()=>{const s=Ct(),e=_.useRef(window.graph),p=()=>{s(at()),s(it()),s(pt(e.current.export()))},{telemetry:{project:u},preference:{autoParallel:i,usePolyline:c}}=st(y=>y.app),{svgViewBoxZoom:a,svgViewBoxMin:b}=st(y=>y.param),{selected:o,refresh:{nodes:m,edges:f},mode:g,active:x,keepLastPath:S,theme:P,polylines:M}=st(y=>y.runtime),[N,L]=_.useState({x:0,y:0}),[h,j]=_.useState({x:0,y:0}),[n,l]=_.useState([]),k=F((y,w)=>{w.stopPropagation(),g==="select"&&s(J("free"));const W=w.currentTarget,{x:R,y:K}=tt(w);W.setPointerCapture(w.pointerId),l([]),L({x:R,y:K}),s(ct(y)),w.shiftKey?o.has(y)?s(At(y)):s(St(y)):o.has(y)||s(ot(new Set([y]))),s(It(Rt(e.current)))}),D=F((y,w)=>{const{x:W,y:R}=tt(w);if(g==="free"&&x===y){if(c!==w.altKey){const K=e.current.getNodeAttribute(y,"x"),B=e.current.getNodeAttribute(y,"y"),T=K-(N.x-W)*a/100,z=B-(N.y-R)*a/100;let V=T,Z=z;if(Ft(y,e.current)){if(n.length!==0&&Object.values(n).forEach(t=>{Ut(t,T,z)>=5&&l(n.filter(d=>d!==t))}),n.length<2&&Object.values(M).forEach(t=>{const{l:r,d}=Vt(T,z,t,[...o,...n.map(A=>A.node)]),C=n.length===0||!n.some(A=>A.a===r.a&&A.b===r.b);d<3&&n.length<2&&C&&l([...n,r])}),n.length===1){const t=n[0];if(t.a==0)Z=-t.c/t.b;else if(t.b==0)V=-t.c/t.a;else{const r=-t.a/t.b,d=-t.c/t.b;Z=r*V+d}}else if(n.length===2){const t=n[0],r=n[1],d=t.a*r.b-r.a*t.b;d!==0&&(V=-(t.c*r.b-r.c*t.b)/d,Z=-(t.a*r.c-r.a*t.c)/d)}}const I=V-K,G=Z-B;o.forEach(t=>{e.current.hasNode(t)&&e.current.updateNodeAttributes(t,r=>({...r,x:U(r.x+I,.01),y:U(r.y+G,.01)}))})}else l([]),o.forEach(K=>{e.current.hasNode(K)&&e.current.updateNodeAttributes(K,B=>({...B,x:U(B.x-(N.x-W)*a/100,5),y:U(B.y-(N.y-R)*a/100,5)}))});s(at()),s(it())}else g.startsWith("line")&&j({x:(N.x-W)*a/100,y:(N.y-R)*a/100})}),X=F((y,w)=>{if(g.startsWith("line")){S||s(J("free"));const W=e.current.hasNode(x)&&ie.includes(e.current.getNodeAttribute(x,"type"));["stn_core_","virtual_circle_"].forEach(K=>{var V,Z;const T=(Z=(V=document.elementsFromPoint(w.clientX,w.clientY)[0].attributes)==null?void 0:V.getNamedItem("id"))==null?void 0:Z.value,z=T==null?void 0:T.startsWith(K);if(W&&z){const I=g.slice(5),G="line_".concat(rt(10)),[t,r]=[x,T.slice(K.length)],d=i?Lt(e.current,I,t,r,"from"):-1;e.current.addDirectedEdgeWithKey(G,t,r,{visible:!0,zIndex:0,type:I,[I]:structuredClone(O[I].defaultAttrs),style:Pt.SingleColor,[Pt.SingleColor]:{color:P},reconcileId:"",parallelIndex:d}),u&&lt.event(dt.ADD_LINE,{type:I})}}),s(it()),s(pt(e.current.export()))}else if(g==="free"&&x){const{x:W,y:R}=tt(w);N.x-W===0&&N.y-R===0||s(pt(e.current.export()))}l([]),s(ct(void 0))}),Y=F((y,w)=>{if(w.stopPropagation(),w.shiftKey||s(gt()),w.shiftKey&&o.has(y)?s(At(y)):s(St(y)),g.startsWith("station")||g.startsWith("misc-node-virtual")||g.startsWith("misc-node-master")){const W=w.clientX-document.getElementById("canvas").getBoundingClientRect().left,R=w.clientY-document.getElementById("canvas").getBoundingClientRect().top,K=g.startsWith("station"),B=rt(10),T=K?"stn_".concat(B):"misc_node_".concat(B),z=K?g.slice(8):g.slice(10),{x:V,y:Z}=H(W,R,a,b),I=K?structuredClone(ut[z].defaultAttrs):structuredClone(ft[z].defaultAttrs);"color"in I&&(I.color=P),e.current.addNode(T,{visible:!0,zIndex:0,x:U(V,5),y:U(Z,5),type:z,[z]:I});const G=e.current.getEdgeAttributes(y),{zIndex:t,type:r,style:d}=G,C=G[r],A=G[d],[v,$]=e.current.extremities(y),Q=i?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(rt(10)),v,T,{visible:!0,zIndex:t,type:r,[r]:structuredClone(C),style:d,[d]:structuredClone(A),reconcileId:"",parallelIndex:Q}),e.current.addDirectedEdgeWithKey("line_".concat(rt(10)),T,$,{visible:!0,zIndex:t,type:r,[r]:structuredClone(C),style:d,[d]:structuredClone(A),reconcileId:"",parallelIndex:Q}),e.current.dropEdge(y),p(),u&&(lt.event(dt.ADD_STATION,{type:z}),lt.event(dt.ADD_LINE,{type:r})),s(J("free")),s(ot(new Set([T])))}}),nt=_.useMemo(()=>[...ne(e.current),...se(e.current)],[f,m]),yt=Tt.component,xt=y=>{if(y.a===0)return[-1e4,1e4,-y.c/y.b,-y.c/y.b];if(y.b===0)return[-y.c/y.a,-y.c/y.a,-1e4,1e4];{const w=-y.a/y.b,W=-y.c/y.b;return[-1e4,1e4,w*-1e4+W,w*1e4+W]}};return E.jsxs(E.Fragment,{children:[E.jsx(re,{elements:nt,handlePointerDown:k,handlePointerMove:D,handlePointerUp:X,handleEdgePointerDown:Y}),g.startsWith("line")&&x&&x!=="background"&&E.jsx(yt,{id:"line_create_in_progress___no_use",type:g.slice(5),path:O[g.slice(5)].generatePath(e.current.getNodeAttribute(x,"x"),e.current.getNodeAttribute(x,"x")-h.x,e.current.getNodeAttribute(x,"y"),e.current.getNodeAttribute(x,"y")-h.y,O[g.slice(5)].defaultAttrs),styleAttrs:{color:P},newLine:!0,handlePointerDown:()=>{}}),n.length!==0&&n.map((y,w)=>E.jsx("path",{d:O[q.Simple].generatePath(...xt(y),O[q.Simple].defaultAttrs),stroke:"cyan",strokeWidth:a/100},"line_polyline_".concat(w)))]})},he=()=>{const s=Ct(),e=_.useRef(window.graph),p=()=>{s(at()),s(it()),s(pt(e.current.export()))},{activeSubscriptions:u}=st(t=>t.account),{telemetry:{project:i}}=st(t=>t.app),{svgViewBoxZoom:c,svgViewBoxMin:a}=st(t=>t.param),{mode:b,lastTool:o,active:m,selected:f,keepLastPath:g,theme:x,refresh:{nodes:S},masterNodesCount:P,parallelLinesCount:M}=st(t=>t.runtime),N=Zt(),{height:L,width:h}=$t(N),j=!u.RMP_CLOUD&&P+1>Wt,n=!u.RMP_CLOUD&&M+1>Kt;_.useEffect(()=>{const t=Qt(e.current);Object.entries(t).filter(([r,d])=>d&&r in qt).forEach(([r])=>Gt(r))},[S]);const[l,k]=_.useState({x:0,y:0}),[D,X]=_.useState({x:0,y:0}),[Y,nt]=_.useState({x:0,y:0}),[yt,xt]=_.useState({x:0,y:0}),y=F(t=>{const{x:r,y:d}=tt(t);if(b.startsWith("station")){s(J("free"));const C=rt(10),A="stn_".concat(C),v=b.slice(8),$=structuredClone(ut[v].defaultAttrs);"color"in $&&($.color=x);const{x:Q,y:mt}=H(r,d,c,a);e.current.addNode(A,{visible:!0,zIndex:0,x:U(Q,5),y:U(mt,5),type:v,[v]:$}),p(),i&&lt.event(dt.ADD_STATION,{type:v}),s(ot(new Set([A])))}else if(b.startsWith("misc-node")){s(J("free"));const C=rt(10),A="misc_node_".concat(C),v=b.slice(10),{x:$,y:Q}=H(r,d,c,a);e.current.addNode(A,{visible:!0,zIndex:0,x:U($,5),y:U(Q,5),type:v,[v]:structuredClone(ft[v].defaultAttrs)}),p(),i&&lt.event(dt.ADD_STATION,{type:v}),s(ot(new Set([A])))}else b==="free"||b.startsWith("line")?(b.startsWith("line")&&(s(J("free")),g&&s(Bt(!1))),nt({x:r,y:d}),xt(a),t.shiftKey||(s(ct("background")),s(gt()))):b==="select"&&(k(H(r,d,c,a)),X(H(r,d,c,a)))}),w=F(t=>{if(b==="select"){if(l.x!=0&&l.y!=0){const{x:r,y:d}=tt(t);X(H(r,d,c,a))}}else if(m==="background"){const{x:r,y:d}=tt(t);s(ht({x:yt.x+(Y.x-r)*c/100,y:yt.y+(Y.y-d)*c/100}))}}),W=F(t=>{if(b==="select"){const{x:r,y:d}=tt(t),{x:C,y:A}=H(r,d,c,a),v=Ht(e.current,l.x,l.y,C,A),$=Jt(e.current,new Set(v));s(ot(new Set([...t.shiftKey?f:[],...v,...$]))),s(J("free")),k({x:0,y:0}),X({x:0,y:0})}m==="background"&&!t.shiftKey&&s(ct(void 0))}),R=F(t=>{let r=c;t.deltaY>0&&c+10<400?r=c+10:t.deltaY<0&&c-10>0&&(r=c-10),s(wt(r));const{x:d,y:C}=tt(t),A=t.currentTarget.getBoundingClientRect(),[v,$]=[d/A.width,C/A.height];s(ht({x:a.x+d*c/100-h*r/100*v,y:a.y+C*c/100-L*r/100*$}))}),K=F(async t=>{if(et?t.key==="Backspace":t.key==="Delete")f.size>0&&(f.forEach(r=>{e.current.hasNode(r)?e.current.dropNode(r):e.current.hasEdge(r)&&e.current.dropEdge(r)}),s(gt()),p());else if(t.key.startsWith("Arrow")){const d=t.key.endsWith("Left")?-1:t.key.endsWith("Right")?1:0,C=t.key.endsWith("Up")?-1:t.key.endsWith("Down")?1:0;s(ht(H(100*d,100*C,c,a)))}else if(t.key==="i"||t.key==="j"||t.key==="k"||t.key==="l"){const d=(t.key==="j"?-1:t.key==="l"?1:0)*10,C=(t.key==="i"?-1:t.key==="k"?1:0)*10;f.size>0&&f.forEach(A=>{e.current.hasNode(A)&&(e.current.updateNodeAttribute(A,"x",v=>(v!=null?v:0)+d),e.current.updateNodeAttribute(A,"y",v=>(v!=null?v:0)+C),p())})}else if(t.key==="f"&&o)s(J(o));else if(t.key==="z"&&(et?t.metaKey&&!t.shiftKey:t.ctrlKey))et&&t.preventDefault(),s(zt()),s(at()),s(it());else if(t.key==="s")s(J("select"));else if((t.key==="c"||t.key==="x")&&(et?t.metaKey&&!t.shiftKey:t.ctrlKey)){const r=Xt(e.current,f);navigator.clipboard.writeText(r),t.key==="x"&&(s(gt()),f.forEach(d=>{e.current.hasNode(d)?e.current.dropNode(d):e.current.hasEdge(d)&&e.current.dropEdge(d)}),p())}else if(t.key==="v"&&(et?t.metaKey&&!t.shiftKey:t.ctrlKey)){const r=await navigator.clipboard.readText(),{x:d,y:C}=H(h/2,L/2,c,a),{nodes:A,edges:v}=Yt(r,e.current,j,n,U(d,5),U(C,5));p();const $=structuredClone(A);v.forEach(Q=>$.add(Q)),s(ot($))}else(et&&t.key==="z"&&t.metaKey&&t.shiftKey||!et&&t.key==="y"&&t.ctrlKey)&&(s(Ot()),s(at()),s(it()))}),[B,T]=_.useState(0),z=F(t=>{if(t.touches.length===2){s(ct(void 0));const[r,d]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];T(r*r+d*d)}}),V=F(t=>{if(B!==0&&t.touches.length===2){const[r,d]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],C=r*r+d*d;let A=c;C-B<0&&c+10<=390?A=c+10:C-B>0&&c-10>=10&&(A=c-10),s(wt(A)),T(C);const v=t.currentTarget.getBoundingClientRect(),[$,Q]=[(t.touches[0].clientX+t.touches[1].clientX)/2-v.left,(t.touches[0].clientY+t.touches[1].clientY)/2-v.top],[mt,Dt]=[$/v.width,Q/v.height];s(ht({x:a.x+$*c/100-h*A/100*mt,y:a.y+Q*c/100-L*A/100*Dt}))}}),Z=F(t=>{B!==0&&T(0)}),[I,G]=_.useState({sx:0,sy:0,ex:0,ey:0});return _.useEffect(()=>{G({sx:l.x<=D.x?l.x:D.x,ex:l.x>D.x?l.x:D.x,sy:l.y<=D.y?l.y:D.y,ey:l.y>D.y?l.y:D.y})},[D.x,D.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:L,width:h,viewBox:"".concat(a.x," ").concat(a.y," ").concat(h*c/100," ").concat(L*c/100),onPointerDown:y,onPointerMove:w,onPointerUp:W,onTouchStart:z,onTouchMove:V,onTouchEnd:Z,onWheel:R,tabIndex:0,onKeyDown:K,children:[E.jsx(ce,{}),b==="select"&&l.x!=0&&l.y!=0&&E.jsx("rect",{x:I.sx,y:I.sy,width:I.ex-I.sx,height:I.ey-I.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{he as default};
