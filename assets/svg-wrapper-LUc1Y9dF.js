import{j as E}from"./chakra-FbDmbOcg.js";import{t as W,N as ie,q as F,j as Ae,d as V,af as T,ag as q,ah as Y,ai as fe,aj as ye,y as be,z as ce,S as Ee,e as Ne,n as ae,v as X,r as de,E as le,A as ue,D as Z,Q as Ce,K as re,J as Pe,a4 as Ie,a6 as je}from"./index-284n7D1e.js";import{r as he,b}from"./react-5OqMKJZU.js";import{u as z,e as Me,i as Le}from"./clipboard-w9-K8jKV.js";import{b as B,r as $,f as _e,F as G,p as D,d as ze,e as We,a as R}from"./helpers-TGU7izSr.js";import{m as Se}from"./misc-nodes-TQDOlLmh.js";import{s as we}from"./stations-9bjcwpVN.js";const Ke=()=>{const[t,e]=he.useState({width:void 0,height:void 0});return he.useEffect(()=>{function r(){e({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",r),r(),()=>window.removeEventListener("resize",r)},[]),t},ge=t=>t.filterNodes((e,r)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),xe=t=>t.filterDirectedEdges((e,r,i,s,d,l,u)=>e.startsWith("line")&&r.visible&&r.reconcileId==="").sort((e,r)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(r,"zIndex")).map(e=>{const r=t.getEdgeAttribute(e,"type"),i=t.getEdgeAttribute(e,r),s=t.getEdgeAttribute(e,"style"),d=t.getEdgeAttribute(e,s),[l,u]=t.extremities(e),f=t.getNodeAttributes(l),y=t.getNodeAttributes(u);return{edge:e,x1:f.x,y1:f.y,x2:y.x,y2:y.y,type:r,attr:i,style:s,styleAttr:d}}),pe=t=>t.filterNodes((e,r)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),De=t=>{const e=t.filterDirectedEdges((i,s,d,l,u,f,y)=>i.startsWith("line")&&s.reconcileId!==""),r={};for(const i of e){const s=t.getEdgeAttribute(i,"reconcileId");s in r?r[s].push(i):r[s]=[i]}return r},Te=t=>{const e=De(t),r=[],i=[];return Object.values(e).forEach(s=>{var K;if(s.length===1){i.push(...s);return}const d=t.getEdgeAttribute(s.at(0),"type");if(!s.every(x=>t.getEdgeAttribute(x,"type")===d)){i.push(...s);return}const l=t.getEdgeAttribute(s.at(0),"style");if(!s.every(x=>t.getEdgeAttribute(x,"style")===l)){i.push(...s);return}const u={},f=new Set,y=new Set,m=Object.fromEntries(s.map(x=>{var U,O;const[M,_]=t.extremities(x);return u[M]=((U=u[M])!=null?U:0)+1,u[_]=((O=u[_])!=null?O:0)+1,f.add(M),y.add(_),[M,[x,_]]})),S=Array.from(f).filter(x=>u[x]===1),P=Array.from(y).filter(x=>u[x]===1);if(S.length!==1||P.length!==1){i.push(...s);return}const N=S[0],I=P[0];if(N===I){i.push(...s);return}const C=[m[N][0]];let w=m[N][1];for(let x=1;x<s.length;x=x+1){const M=(K=m[w])==null?void 0:K.at(1);if(!M){i.push(...s);return}C.push(m[w][0]),w=M}if(w!==I||C.length!==s.length){i.push(...s);return}r.push(C)}),{allReconciledLines:r,danglingLines:i}},$e=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const r=e.map(s=>{var S,P,N;const[d,l]=t.extremities(s),u=t.getNodeAttributes(d),f=t.getNodeAttributes(l),y=t.getEdgeAttribute(s,"type"),m=(S=t.getEdgeAttribute(s,y))!=null?S:W[y].defaultAttrs;return(N=(P=W[y])==null?void 0:P.generatePath(u.x,f.x,u.y,f.y,m))!=null?N:"M ".concat(u.x," ").concat(u.y," L ").concat(f.x," ").concat(f.y)});let i="".concat(r[0]," ");for(let s=1;s<e.length;s=s+1)i+=r[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return i},me=t=>{const{id:e,x:r,y:i,handlePointerDown:s,handlePointerMove:d,handlePointerUp:l}=t,u=b.useCallback(m=>s(e,m),[e,s]),f=b.useCallback(m=>d(e,m),[e,d]),y=b.useCallback(m=>l(e,m),[e,l]);return E.jsx("g",{id:e,transform:"translate(".concat(r-6.4," ").concat(i-6.4,")scale(0.025)"),onPointerDown:u,onPointerMove:f,onPointerUp:y,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ke=t=>{const{id:e,path:r,handleClick:i}=t,s=b.useCallback(d=>i(e,d),[e,i]);return E.jsx("path",{id:e,d:r,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:s})},oe=t=>{var I,C;const{id:e,type:r,attrs:i=W[r].defaultAttrs,styleType:s,styleAttrs:d=ie[s].defaultAttrs,newLine:l,handleClick:u}=t,{x1:f,y1:y,x2:m,y2:S}=t,P=b.useMemo(()=>Be(e,r,f,y,m,S,i),[r,JSON.stringify(i),f,m,y,S]),N=(C=(I=ie[s])==null?void 0:I.component)!=null?C:ke;return E.jsx(N,{id:e,type:r,path:P,styleAttrs:d,newLine:l,handleClick:u})},Be=(t,e,r,i,s,d,l)=>{if(!(e in W))return"M ".concat(r," ").concat(i," L ").concat(s," ").concat(d);const u=Oe(t,e,r,i,s,d,l);if(u){const{x1:f,y1:y,x2:m,y2:S,offset:P}=u;return W[F.Simple].generatePath(f,m,y,S,{offset:P})}return W[e].generatePath(r,s,i,d,l)},Oe=(t,e,r,i,s,d,l)=>{if(!("offsetFrom"in l)||!("offsetTo"in l)||Number.isNaN(l.offsetFrom)||Number.isNaN(l.offsetTo))return;if(l.offsetFrom===l.offsetTo)return ve(e,r,i,s,d)?{x1:r,y1:i,x2:s,y2:d,offset:l.offsetFrom}:void 0;const[u,f]=[l.offsetFrom,l.offsetTo];for(let y=0;y<Math.PI;y+=Math.PI/8)for(let m=y,S=0;S<2;S++,m+=Math.PI){const[P,N,I,C]=[Math.sin(y)*u,Math.cos(y)*u,Math.sin(m)*f,Math.cos(m)*f];if(ve(e,r+P,i+N,s+I,d+C))return{x1:r+P,y1:i+N,x2:s+I,y2:d+C,offset:0}}},ve=(t,e,r,i,s)=>!!((e===i||r===s)&&[F.Diagonal,F.Perpendicular].includes(t)||Math.abs((s-r)/(i-e))===1&&[F.Diagonal,F.RotatePerpendicular].includes(t)),Re=()=>{const t=Ae(),e=b.useRef(window.graph),{telemetry:{project:r}}=V(a=>a.app),{svgViewBoxZoom:i}=V(a=>a.param),{selected:s,refresh:{nodes:d,edges:l},mode:u,active:f,keepLastPath:y,theme:m}=V(a=>a.runtime),[S,P]=b.useState({x:0,y:0}),[N,I]=b.useState({x:0,y:0}),C=z((a,h)=>{h.stopPropagation(),u==="select"&&t(T("free"));const v=h.currentTarget,{x:k,y:n}=B(h);v.setPointerCapture(h.pointerId),P({x:k,y:n}),t(q(a)),h.shiftKey?s.has(a)?t(fe(a)):t(ye(a)):s.has(a)||t(Y(new Set([a])))}),w=z((a,h)=>{const{x:v,y:k}=B(h);u==="free"&&f===a?(s.forEach(n=>{e.current.hasNode(n)&&e.current.updateNodeAttributes(n,o=>({...o,x:$(o.x-(S.x-v)*i/100,h.altKey?1:5),y:$(o.y-(S.y-k)*i/100,h.altKey?1:5)}))}),t(be()),t(ce())):u.startsWith("line")&&I({x:(S.x-v)*i/100,y:(S.y-k)*i/100})}),K=z((a,h)=>{if(u.startsWith("line")){y||t(T("free"));const v=[...Object.values(Ee),Ne.Virtual],k=e.current.hasNode(f)&&v.includes(e.current.getNodeAttribute(f,"type"));["stn_core_","virtual_circle_"].forEach(o=>{var p,j;const g=(j=(p=document.elementsFromPoint(h.clientX,h.clientY)[0].attributes)==null?void 0:p.getNamedItem("id"))==null?void 0:j.value,A=g==null?void 0:g.startsWith(o);if(k&&A){const L=u.slice(5),ne="line_".concat(ae(10));e.current.addDirectedEdgeWithKey(ne,f,g.slice(o.length),{visible:!0,zIndex:0,type:L,[L]:structuredClone(W[L].defaultAttrs),style:X.SingleColor,[X.SingleColor]:{color:m},reconcileId:""}),r&&de.event(le.ADD_LINE,{type:L})}}),t(ce()),t(ue(e.current.export()))}else if(u==="free"&&f){const{x:v,y:k}=B(h);S.x-v===0&&S.y-k===0||t(ue(e.current.export()))}t(q(void 0))}),x=z((a,h)=>{h.shiftKey||t(Z()),h.shiftKey&&s.has(a)?t(fe(a)):t(ye(a))}),[M,_]=b.useState(ge(e.current)),[U,O]=b.useState(pe(e.current)),[J,H]=b.useState(xe(e.current)),[Q,ee]=b.useState([]),[te,se]=b.useState([]);return b.useEffect(()=>{_(ge(e.current)),O(pe(e.current))},[d]),b.useEffect(()=>{H(xe(e.current));const{allReconciledLines:a,danglingLines:h}=Te(e.current);ee(a),se(h)},[l]),E.jsxs(E.Fragment,{children:[te.map(a=>{const[h,v]=e.current.extremities(a),k=e.current.getNodeAttributes(h),n=e.current.getNodeAttributes(v);return E.jsx(oe,{id:a,x1:k.x,y1:k.y,x2:n.x,y2:n.y,newLine:!1,type:F.Simple,attrs:W[F.Simple].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:x},a)}),Q.map(a=>{var g,A;const h=$e(e.current,a);if(!h)return E.jsx(E.Fragment,{});const v=a.at(0),k=e.current.getEdgeAttribute(v,"type"),n=e.current.getEdgeAttribute(v,"style"),o=e.current.getEdgeAttribute(v,n),c=(A=(g=ie[n])==null?void 0:g.component)!=null?A:ke;return E.jsx(c,{id:v,type:k,path:h,styleAttrs:o,newLine:!1,handleClick:x},v)}),J.map(({edge:a,x1:h,y1:v,x2:k,y2:n,type:o,attr:c,style:g,styleAttr:A})=>E.jsx(oe,{id:a,x1:h,y1:v,x2:k,y2:n,newLine:!1,type:o,attrs:c,styleType:g,styleAttrs:A,handleClick:x},a)),U.map(a=>{var c,g;const{node:h,x:v,y:k,type:n}=a,o=(g=(c=Se[n])==null?void 0:c.component)!=null?g:me;return E.jsx(o,{id:h,x:v,y:k,attrs:a[n],handlePointerDown:C,handlePointerMove:w,handlePointerUp:K},h)}),M.map(a=>{var c,g;const{node:h,x:v,y:k,type:n}=a,o=(g=(c=we[n])==null?void 0:c.component)!=null?g:me;return E.jsx(o,{id:h,x:v,y:k,attrs:{[n]:a[n]},handlePointerDown:C,handlePointerMove:w,handlePointerUp:K},h)}),u.startsWith("line")&&f&&E.jsx(oe,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(f,"x"),y1:e.current.getNodeAttribute(f,"y"),x2:e.current.getNodeAttribute(f,"x")-N.x,y2:e.current.getNodeAttribute(f,"y")-N.y,newLine:!0,type:u.slice(5),attrs:W[u.slice(5)].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:m}})]})},qe=()=>{var v,k;const t=Ae(),e=b.useRef(window.graph),r=()=>{t(be()),t(ce()),t(ue(e.current.export()))},{telemetry:{project:i}}=V(n=>n.app),{svgViewBoxZoom:s,svgViewBoxMin:d}=V(n=>n.param),{mode:l,lastTool:u,active:f,selected:y,keepLastPath:m,theme:S,refresh:{nodes:P}}=V(n=>n.runtime),N=Ke(),I=((v=N.height)!=null?v:1280)-40,C=((k=N.width)!=null?k:720)-40;b.useEffect(()=>{const n=_e(e.current);Object.entries(n).filter(([o,c])=>c&&o in G).map(([o,c])=>o).filter(o=>G[o]&&document.getElementById(G[o].cssName)===null).map(o=>G[o].cssName).filter((o,c,g)=>c===g.findIndex(A=>A===o)).forEach(o=>{const c=document.createElement("link");c.rel="stylesheet",c.id=o,c.href="/rmp/styles/".concat(o,".css"),document.head.append(c)})},[P]);const[w,K]=b.useState({x:0,y:0}),[x,M]=b.useState({x:0,y:0}),[_,U]=b.useState({x:0,y:0}),[O,J]=b.useState({x:0,y:0}),H=z(n=>{const{x:o,y:c}=B(n);if(l.startsWith("station")){t(T("free"));const g=ae(10),A="stn_".concat(g),p=l.slice(8),j=structuredClone(we[p].defaultAttrs);"color"in j&&(j.color=S);const{x:L,y:ne}=D(o,c,s,d);e.current.addNode(A,{visible:!0,zIndex:0,x:$(L,5),y:$(ne,5),type:p,[p]:j}),r(),i&&de.event(le.ADD_STATION,{type:p}),t(Y(new Set([A])))}else if(l.startsWith("misc-node")){t(T("free"));const g=ae(10),A="misc_node_".concat(g),p=l.slice(10),{x:j,y:L}=D(o,c,s,d);e.current.addNode(A,{visible:!0,zIndex:0,x:$(j,5),y:$(L,5),type:p,[p]:structuredClone(Se[p].defaultAttrs)}),r(),i&&de.event(le.ADD_STATION,{type:p}),t(Y(new Set([A])))}else l==="free"||l.startsWith("line")?(l.startsWith("line")&&(t(T("free")),m&&t(Ce(!1))),U({x:o,y:c}),J(d),n.shiftKey||(t(q("background")),t(Z()))):l==="select"&&(K(D(o,c,s,d)),M(D(o,c,s,d)))}),Q=z(n=>{if(l==="select"){if(w.x!=0&&w.y!=0){const{x:o,y:c}=B(n);M(D(o,c,s,d))}}else if(f==="background"){const{x:o,y:c}=B(n);t(re({x:O.x+(_.x-o)*s/100,y:O.y+(_.y-c)*s/100}))}}),ee=z(n=>{if(l==="select"){const{x:o,y:c}=B(n),{x:g,y:A}=D(o,c,s,d),p=ze(e.current,w.x,w.y,g,A),j=We(e.current,new Set(p));t(Y(new Set([...n.shiftKey?y:[],...p,...j]))),t(T("free")),K({x:0,y:0}),M({x:0,y:0})}f==="background"&&!n.shiftKey&&t(q(void 0))}),te=z(n=>{let o=s;n.deltaY>0&&s+10<400?o=s+10:n.deltaY<0&&s-10>0&&(o=s-10),t(Pe(o));const{x:c,y:g}=B(n),A=n.currentTarget.getBoundingClientRect(),[p,j]=[c/A.width,g/A.height];t(re({x:d.x+c*s/100-C*o/100*p,y:d.y+g*s/100-I*o/100*j}))}),se=z(async n=>{if(R?n.key==="Backspace":n.key==="Delete")y.size>0&&(y.forEach(o=>{e.current.hasNode(o)?e.current.dropNode(o):e.current.hasEdge(o)&&e.current.dropEdge(o)}),t(Z()),r());else if(n.key.startsWith("Arrow")){const c=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,g=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(re(D(100*c,100*g,s,d)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const c=(n.key==="j"?-1:n.key==="l"?1:0)*10,g=(n.key==="i"?-1:n.key==="k"?1:0)*10;y.size>0&&y.forEach(A=>{e.current.hasNode(A)&&(e.current.updateNodeAttribute(A,"x",p=>(p!=null?p:0)+c),e.current.updateNodeAttribute(A,"y",p=>(p!=null?p:0)+g),r())})}else if(n.key==="f"&&u)t(T(u));else if(n.key==="z"&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey))R&&n.preventDefault(),t(Ie());else if(n.key==="s")t(T("select"));else if((n.key==="c"||n.key==="x")&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey)){const o=Me(e.current,y);navigator.clipboard.writeText(o),n.key==="x"&&(t(Z()),y.forEach(c=>{e.current.hasNode(c)?e.current.dropNode(c):e.current.hasEdge(c)&&e.current.dropEdge(c)}),r())}else if(n.key==="v"&&(R?n.metaKey&&!n.shiftKey:n.ctrlKey)){const o=await navigator.clipboard.readText(),{x:c,y:g}=D(C/2,I/2,s,d),{nodes:A,edges:p}=Le(o,e.current,$(c,5),$(g,5));r();const j=structuredClone(A);p.forEach(L=>j.add(L)),t(Y(j))}else(R&&n.key==="z"&&n.metaKey&&n.shiftKey||!R&&n.key==="y"&&n.ctrlKey)&&t(je())}),[a,h]=b.useState({sx:0,sy:0,ex:0,ey:0});return b.useEffect(()=>{h({sx:w.x<=x.x?w.x:x.x,ex:w.x>x.x?w.x:x.x,sy:w.y<=x.y?w.y:x.y,ey:w.y>x.y?w.y:x.y})},[x.x,x.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:I,width:C,viewBox:"".concat(d.x," ").concat(d.y," ").concat(C*s/100," ").concat(I*s/100),onPointerDown:H,onPointerMove:Q,onPointerUp:ee,onWheel:te,tabIndex:0,onKeyDown:se,children:[E.jsx(Re,{}),l==="select"&&w.x!=0&&w.y!=0&&E.jsx("rect",{x:a.sx,y:a.sy,width:a.ex-a.sx,height:a.ey-a.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{qe as default};
