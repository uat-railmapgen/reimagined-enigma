import{j as N}from"./chakra-sjIlidOs.js";import{m as W,ac as at,l as X,f as St,a as G,ad as O,ae as q,$ as Z,af as ht,ag as xt,q as kt,t as lt,S as Pt,b as Mt,n as dt,o as J,r as ut,E as ft,v as yt,x as Q,K as It,z as H,y as gt,a4 as jt,a6 as _t}from"./index-6ywEtU-N.js";import{b}from"./react-hBmrxY6U.js";import{u as D,e as Lt,i as Tt}from"./clipboard-tzQtEIcJ.js";import{s as wt,u as Dt,F as Kt,b as Wt}from"./stations-pgsDkiLL.js";import{f as zt,a as $t,b as Bt}from"./graph-V0vJynn9.js";import{a as Y,r as R,g as Ot,p as B,i as V}from"./helpers--8-2mJFL.js";import{m as Et}from"./misc-nodes-fqOPtRM_.js";const pt=s=>s.filterNodes((t,o)=>t.startsWith("stn")).map(t=>[t,s.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),mt=s=>s.filterDirectedEdges((t,o,r,n,a,d,u)=>t.startsWith("line")&&o.visible&&o.reconcileId==="").sort((t,o)=>s.getEdgeAttribute(t,"zIndex")-s.getEdgeAttribute(o,"zIndex")).map(t=>{const o=s.getEdgeAttribute(t,"type"),r=s.getEdgeAttribute(t,o),n=s.getEdgeAttribute(t,"style"),a=s.getEdgeAttribute(t,n),[d,u]=s.extremities(t),l=s.getNodeAttributes(d),h=s.getNodeAttributes(u);return{edge:t,x1:l.x,y1:l.y,x2:h.x,y2:h.y,type:o,attr:r,style:n,styleAttr:a}}),vt=s=>s.filterNodes((t,o)=>t.startsWith("misc_node")).map(t=>[t,s.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),Rt=s=>{const t=s.filterDirectedEdges((r,n,a,d,u,l,h)=>r.startsWith("line")&&n.reconcileId!==""),o={};for(const r of t){const n=s.getEdgeAttribute(r,"reconcileId");n in o?o[n].push(r):o[n]=[r]}return o},Yt=s=>{const t=Rt(s),o=[],r=[];return Object.values(t).forEach(n=>{var z;if(n.length===1){r.push(...n);return}const a=s.getEdgeAttribute(n.at(0),"type");if(!n.every(g=>s.getEdgeAttribute(g,"type")===a)){r.push(...n);return}const d=s.getEdgeAttribute(n.at(0),"style");if(!n.every(g=>s.getEdgeAttribute(g,"style")===d)){r.push(...n);return}const u={},l=new Set,h=new Set,m=Object.fromEntries(n.map(g=>{var U,F;const[L,K]=s.extremities(g);return u[L]=((U=u[L])!=null?U:0)+1,u[K]=((F=u[K])!=null?F:0)+1,l.add(L),h.add(K),[L,[g,K]]})),A=Array.from(l).filter(g=>u[g]===1),M=Array.from(h).filter(g=>u[g]===1);if(A.length!==1||M.length!==1){r.push(...n);return}const I=A[0],j=M[0];if(I===j){r.push(...n);return}const P=[m[I][0]];let S=m[I][1];for(let g=1;g<n.length;g=g+1){const L=(z=m[S])==null?void 0:z.at(1);if(!L){r.push(...n);return}P.push(m[S][0]),S=L}if(S!==j||P.length!==n.length){r.push(...n);return}o.push(P)}),{allReconciledLines:o,danglingLines:r}},Ft=(s,t)=>{if(!t.every(n=>s.hasEdge(n)))return;const o=t.map(n=>{var A,M,I;const[a,d]=s.extremities(n),u=s.getNodeAttributes(a),l=s.getNodeAttributes(d),h=s.getEdgeAttribute(n,"type"),m=(A=s.getEdgeAttribute(n,h))!=null?A:W[h].defaultAttrs;return(I=(M=W[h])==null?void 0:M.generatePath(u.x,l.x,u.y,l.y,m))!=null?I:"M ".concat(u.x," ").concat(u.y," L ").concat(l.x," ").concat(l.y)});let r="".concat(o[0]," ");for(let n=1;n<t.length;n=n+1)r+=o[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},bt=s=>{const{id:t,x:o,y:r,handlePointerDown:n,handlePointerMove:a,handlePointerUp:d}=s,u=b.useCallback(m=>n(t,m),[t,n]),l=b.useCallback(m=>a(t,m),[t,a]),h=b.useCallback(m=>d(t,m),[t,d]);return N.jsx("g",{id:t,transform:"translate(".concat(o-6.4," ").concat(r-6.4,")scale(0.025)"),onPointerDown:u,onPointerMove:l,onPointerUp:h,style:{cursor:"move"},children:N.jsx("path",{id:"stn_core_".concat(t),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Nt=s=>{const{id:t,path:o,handleClick:r}=s,n=b.useCallback(a=>r(t,a),[t,r]);return N.jsx("path",{id:t,d:o,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:n})},ct=s=>{var j,P;const{id:t,type:o,attrs:r=W[o].defaultAttrs,styleType:n,styleAttrs:a=at[n].defaultAttrs,newLine:d,handleClick:u}=s,{x1:l,y1:h,x2:m,y2:A}=s,M=b.useMemo(()=>Vt(t,o,l,h,m,A,r),[o,JSON.stringify(r),l,m,h,A]),I=(P=(j=at[n])==null?void 0:j.component)!=null?P:Nt;return N.jsx(I,{id:t,type:o,path:M,styleAttrs:a,newLine:d,handleClick:u})},Vt=(s,t,o,r,n,a,d)=>{if(!(t in W))return"M ".concat(o," ").concat(r," L ").concat(n," ").concat(a);const u=Xt(s,t,o,r,n,a,d);if(u){const{x1:l,y1:h,x2:m,y2:A,offset:M}=u;return W[X.Simple].generatePath(l,m,h,A,{offset:M})}return W[t].generatePath(o,n,r,a,d)},Xt=(s,t,o,r,n,a,d)=>{if(!("offsetFrom"in d)||!("offsetTo"in d)||Number.isNaN(d.offsetFrom)||Number.isNaN(d.offsetTo))return;if(d.offsetFrom===d.offsetTo)return At(t,o,r,n,a)?{x1:o,y1:r,x2:n,y2:a,offset:d.offsetFrom}:void 0;const[u,l]=[d.offsetFrom,d.offsetTo];for(let h=0;h<Math.PI;h+=Math.PI/8)for(let m=h,A=0;A<2;A++,m+=Math.PI){const[M,I,j,P]=[Math.sin(h)*u,Math.cos(h)*u,Math.sin(m)*l,Math.cos(m)*l];if(At(t,o+M,r+I,n+j,a+P))return{x1:o+M,y1:r+I,x2:n+j,y2:a+P,offset:0}}},At=(s,t,o,r,n)=>!!((t===r||o===n)&&[X.Diagonal,X.Perpendicular].includes(s)||Math.abs((n-o)/(r-t))===1&&[X.Diagonal,X.RotatePerpendicular].includes(s)),Ut=()=>{const s=St(),t=b.useRef(window.graph),{telemetry:{project:o}}=G(c=>c.app),{svgViewBoxZoom:r}=G(c=>c.param),{selected:n,refresh:{nodes:a,edges:d},mode:u,active:l,keepLastPath:h,theme:m}=G(c=>c.runtime),[A,M]=b.useState({x:0,y:0}),[I,j]=b.useState({x:0,y:0}),P=D((c,y)=>{y.stopPropagation(),u==="select"&&s(O("free"));const v=y.currentTarget,{x:w,y:k}=Y(y);v.setPointerCapture(y.pointerId),M({x:w,y:k}),s(q(c)),y.shiftKey?n.has(c)?s(ht(c)):s(xt(c)):n.has(c)||s(Z(new Set([c])))}),S=D((c,y)=>{const{x:v,y:w}=Y(y);l===c&&!n.has(l)&&s(Z(new Set)),u==="free"&&l===c?((n.has(l)?n:[l]).forEach(k=>{t.current.hasNode(k)&&t.current.updateNodeAttributes(k,E=>({...E,x:R(E.x-(A.x-v)*r/100,y.altKey?1:5),y:R(E.y-(A.y-w)*r/100,y.altKey?1:5)}))}),s(kt()),s(lt())):u.startsWith("line")&&j({x:(A.x-v)*r/100,y:(A.y-w)*r/100})}),z=D((c,y)=>{if(u.startsWith("line")){h||s(O("free"));const v=[...Object.values(Pt),Mt.Virtual],w=t.current.hasNode(l)&&v.includes(t.current.getNodeAttribute(l,"type"));["stn_core_","virtual_circle_"].forEach(E=>{var f,C;const e=(C=(f=document.elementsFromPoint(y.clientX,y.clientY)[0].attributes)==null?void 0:f.getNamedItem("id"))==null?void 0:C.value,i=e==null?void 0:e.startsWith(E);if(w&&i){const p=u.slice(5),x="line_".concat(dt(10));t.current.addDirectedEdgeWithKey(x,l,e.slice(E.length),{visible:!0,zIndex:0,type:p,[p]:structuredClone(W[p].defaultAttrs),style:J.SingleColor,[J.SingleColor]:{color:m},reconcileId:""}),o&&ut.event(ft.ADD_LINE,{type:p})}}),s(lt()),s(yt(t.current.export()))}else if(u==="free"&&l){const{x:v,y:w}=Y(y);A.x-v===0&&A.y-w===0||s(yt(t.current.export()))}s(q(void 0))}),g=D((c,y)=>{y.shiftKey||s(Q()),y.shiftKey&&n.has(c)?s(ht(c)):s(xt(c))}),[L,K]=b.useState(pt(t.current)),[U,F]=b.useState(vt(t.current)),[tt,et]=b.useState(mt(t.current)),[st,nt]=b.useState([]),[ot,rt]=b.useState([]);return b.useEffect(()=>{K(pt(t.current)),F(vt(t.current))},[a]),b.useEffect(()=>{et(mt(t.current));const{allReconciledLines:c,danglingLines:y}=Yt(t.current);nt(c),rt(y)},[d]),N.jsxs(N.Fragment,{children:[ot.map(c=>{const[y,v]=t.current.extremities(c),w=t.current.getNodeAttributes(y),k=t.current.getNodeAttributes(v);return N.jsx(ct,{id:c,x1:w.x,y1:w.y,x2:k.x,y2:k.y,newLine:!1,type:X.Simple,attrs:W[X.Simple].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:g},c)}),st.map(c=>{var e,i;const y=Ft(t.current,c);if(!y)return N.jsx(N.Fragment,{});const v=c.at(0),w=t.current.getEdgeAttribute(v,"type"),k=t.current.getEdgeAttribute(v,"style"),E=t.current.getEdgeAttribute(v,k),T=(i=(e=at[k])==null?void 0:e.component)!=null?i:Nt;return N.jsx(T,{id:v,type:w,path:y,styleAttrs:E,newLine:!1,handleClick:g},v)}),tt.map(({edge:c,x1:y,y1:v,x2:w,y2:k,type:E,attr:T,style:e,styleAttr:i})=>N.jsx(ct,{id:c,x1:y,y1:v,x2:w,y2:k,newLine:!1,type:E,attrs:T,styleType:e,styleAttrs:i,handleClick:g},c)),U.map(c=>{var T,e;const{node:y,x:v,y:w,type:k}=c,E=(e=(T=Et[k])==null?void 0:T.component)!=null?e:bt;return N.jsx(E,{id:y,x:v,y:w,attrs:c[k],handlePointerDown:P,handlePointerMove:S,handlePointerUp:z},y)}),L.map(c=>{var T,e;const{node:y,x:v,y:w,type:k}=c,E=(e=(T=wt[k])==null?void 0:T.component)!=null?e:bt;return N.jsx(E,{id:y,x:v,y:w,attrs:{[k]:c[k]},handlePointerDown:P,handlePointerMove:S,handlePointerUp:z},y)}),u.startsWith("line")&&l&&l!=="background"&&N.jsx(ct,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(l,"x"),y1:t.current.getNodeAttribute(l,"y"),x2:t.current.getNodeAttribute(l,"x")-I.x,y2:t.current.getNodeAttribute(l,"y")-I.y,newLine:!0,type:u.slice(5),attrs:W[u.slice(5)].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:m}})]})},se=()=>{const s=St(),t=b.useRef(window.graph),o=()=>{s(kt()),s(lt()),s(yt(t.current.export()))},{telemetry:{project:r}}=G(e=>e.app),{svgViewBoxZoom:n,svgViewBoxMin:a}=G(e=>e.param),{mode:d,lastTool:u,active:l,selected:h,keepLastPath:m,theme:A,refresh:{nodes:M}}=G(e=>e.runtime),I=Dt(),{height:j,width:P}=Ot(I);b.useEffect(()=>{const e=zt(t.current);Object.entries(e).filter(([i,f])=>f&&i in Kt).forEach(([i])=>Wt(i))},[M]);const[S,z]=b.useState({x:0,y:0}),[g,L]=b.useState({x:0,y:0}),[K,U]=b.useState({x:0,y:0}),[F,tt]=b.useState({x:0,y:0}),et=D(e=>{const{x:i,y:f}=Y(e);if(d.startsWith("station")){s(O("free"));const C=dt(10),p="stn_".concat(C),x=d.slice(8),_=structuredClone(wt[x].defaultAttrs);"color"in _&&(_.color=A);const{x:$,y:it}=B(i,f,n,a);t.current.addNode(p,{visible:!0,zIndex:0,x:R($,5),y:R(it,5),type:x,[x]:_}),o(),r&&ut.event(ft.ADD_STATION,{type:x}),s(Z(new Set([p])))}else if(d.startsWith("misc-node")){s(O("free"));const C=dt(10),p="misc_node_".concat(C),x=d.slice(10),{x:_,y:$}=B(i,f,n,a);t.current.addNode(p,{visible:!0,zIndex:0,x:R(_,5),y:R($,5),type:x,[x]:structuredClone(Et[x].defaultAttrs)}),o(),r&&ut.event(ft.ADD_STATION,{type:x}),s(Z(new Set([p])))}else d==="free"||d.startsWith("line")?(d.startsWith("line")&&(s(O("free")),m&&s(It(!1))),U({x:i,y:f}),tt(a),e.shiftKey||(s(q("background")),s(Q()))):d==="select"&&(z(B(i,f,n,a)),L(B(i,f,n,a)))}),st=D(e=>{if(d==="select"){if(S.x!=0&&S.y!=0){const{x:i,y:f}=Y(e);L(B(i,f,n,a))}}else if(l==="background"){const{x:i,y:f}=Y(e);s(H({x:F.x+(K.x-i)*n/100,y:F.y+(K.y-f)*n/100}))}}),nt=D(e=>{if(d==="select"){const{x:i,y:f}=Y(e),{x:C,y:p}=B(i,f,n,a),x=$t(t.current,S.x,S.y,C,p),_=Bt(t.current,new Set(x));s(Z(new Set([...e.shiftKey?h:[],...x,..._]))),s(O("free")),z({x:0,y:0}),L({x:0,y:0})}l==="background"&&!e.shiftKey&&s(q(void 0))}),ot=D(e=>{let i=n;e.deltaY>0&&n+10<400?i=n+10:e.deltaY<0&&n-10>0&&(i=n-10),s(gt(i));const{x:f,y:C}=Y(e),p=e.currentTarget.getBoundingClientRect(),[x,_]=[f/p.width,C/p.height];s(H({x:a.x+f*n/100-P*i/100*x,y:a.y+C*n/100-j*i/100*_}))}),rt=D(async e=>{if(V?e.key==="Backspace":e.key==="Delete")h.size>0&&(h.forEach(i=>{t.current.hasNode(i)?t.current.dropNode(i):t.current.hasEdge(i)&&t.current.dropEdge(i)}),s(Q()),o());else if(e.key.startsWith("Arrow")){const f=e.key.endsWith("Left")?-1:e.key.endsWith("Right")?1:0,C=e.key.endsWith("Up")?-1:e.key.endsWith("Down")?1:0;s(H(B(100*f,100*C,n,a)))}else if(e.key==="i"||e.key==="j"||e.key==="k"||e.key==="l"){const f=(e.key==="j"?-1:e.key==="l"?1:0)*10,C=(e.key==="i"?-1:e.key==="k"?1:0)*10;h.size>0&&h.forEach(p=>{t.current.hasNode(p)&&(t.current.updateNodeAttribute(p,"x",x=>(x!=null?x:0)+f),t.current.updateNodeAttribute(p,"y",x=>(x!=null?x:0)+C),o())})}else if(e.key==="f"&&u)s(O(u));else if(e.key==="z"&&(V?e.metaKey&&!e.shiftKey:e.ctrlKey))V&&e.preventDefault(),s(jt());else if(e.key==="s")s(O("select"));else if((e.key==="c"||e.key==="x")&&(V?e.metaKey&&!e.shiftKey:e.ctrlKey)){const i=Lt(t.current,h);navigator.clipboard.writeText(i),e.key==="x"&&(s(Q()),h.forEach(f=>{t.current.hasNode(f)?t.current.dropNode(f):t.current.hasEdge(f)&&t.current.dropEdge(f)}),o())}else if(e.key==="v"&&(V?e.metaKey&&!e.shiftKey:e.ctrlKey)){const i=await navigator.clipboard.readText(),{x:f,y:C}=B(P/2,j/2,n,a),{nodes:p,edges:x}=Tt(i,t.current,R(f,5),R(C,5));o();const _=structuredClone(p);x.forEach($=>_.add($)),s(Z(_))}else(V&&e.key==="z"&&e.metaKey&&e.shiftKey||!V&&e.key==="y"&&e.ctrlKey)&&s(_t())}),[c,y]=b.useState(0),v=D(e=>{if(e.touches.length===2){s(q(void 0));const[i,f]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY];y(i*i+f*f)}}),w=D(e=>{if(c!==0&&e.touches.length===2){const[i,f]=[e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY],C=i*i+f*f;let p=n;C-c<0&&n+10<=390?p=n+10:C-c>0&&n-10>=10&&(p=n-10),s(gt(p));const x=e.currentTarget.getBoundingClientRect(),[_,$]=[(e.touches[0].clientX+e.touches[1].clientX)/2-x.left,(e.touches[0].clientY+e.touches[1].clientY)/2-x.top],[it,Ct]=[_/x.width,$/x.height];s(H({x:a.x+_*n/100-P*p/100*it,y:a.y+$*n/100-j*p/100*Ct}))}}),k=D(e=>{c!==0&&y(0)}),[E,T]=b.useState({sx:0,sy:0,ex:0,ey:0});return b.useEffect(()=>{T({sx:S.x<=g.x?S.x:g.x,ex:S.x>g.x?S.x:g.x,sy:S.y<=g.y?S.y:g.y,ey:S.y>g.y?S.y:g.y})},[g.x,g.y]),N.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:j,width:P,viewBox:"".concat(a.x," ").concat(a.y," ").concat(P*n/100," ").concat(j*n/100),onPointerDown:et,onPointerMove:st,onPointerUp:nt,onTouchStart:v,onTouchMove:w,onTouchEnd:k,onWheel:ot,tabIndex:0,onKeyDown:rt,children:[N.jsx(Ut,{}),d==="select"&&S.x!=0&&S.y!=0&&N.jsx("rect",{x:E.sx,y:E.sy,width:E.ex-E.sx,height:E.ey-E.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),N.jsx("defs",{children:N.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[N.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),N.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{se as default};
