System.register(["./chakra-legacy-DsJcG_7N.js","./index-legacy-ByTheGth.js","./master-manager-legacy-BIMED0CR.js","./react-legacy-S3BmMPiz.js","./clipboard-legacy-D6lEgzls.js","./misc-nodes-legacy-H3IjqKtv.js"],(function(e,t){"use strict";var n,o,r,i,s,a,l,c,d,u,h,y,p,f,x,g,m,v,b,w,A,P,z,N,k,j,S,C,D,E,I,M,_,$,T,H,W,K,L,R,O,U,B,F,X,Y,Q,V,q,J,G,Z,ee,te,ne,oe;return{setters:[e=>{n=e.j},e=>{o=e.a3,r=e.ap,i=e.aq,s=e.N,a=e.k,l=e.l,c=e.ar,d=e.as,u=e.at,h=e.S,y=e.au,p=e.c,f=e.d,x=e.av,g=e.aw,m=e.ax,v=e.T,b=e.ay,w=e.az,A=e.aA,P=e.q,z=e.t,N=e.n,k=e.m,j=e.o,S=e.r,C=e.E,D=e.v,E=e.y,I=e.U,M=e.aB,_=e.p,$=e.aC,T=e.a0,H=e.a1,W=e.A,K=e.z,L=e.a9,R=e.am,O=e.an},e=>{U=e.S,B=e.s,F=e.u,X=e.f,Y=e.F,Q=e.l,V=e.b,q=e.c},e=>{J=e.r,G=e.f,Z=e.b},e=>{ee=e.u,te=e.e,ne=e.i},e=>{oe=e.m}],execute:function(){var t=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)s.push(o.value)}catch(a){r={error:a}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s};function re(e){var o=e.children,r=t(J.useState(Math.random()),2),i=r[0],s=r[1];return n.jsx(U.Provider,{value:{updateId:i,update:function(){return s(Math.random())}},children:o})}const ie={[o.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[o.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},se=G("runtime/getStationNames",(async({cityName:e},{getState:t,dispatch:n,rejectWithValue:o})=>{const{token:a}=t().account;if(!a)return void n(r({cityName:e,names:[]}));const l=await fetch(`${i}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(!l.ok)return s.warn("Failed to fetch random station names",l.statusText),o(l.statusText);const c=await l.json();n(r({cityName:e,names:c}))})),ae=G("runtime/getOneStationName",(async(e,{getState:t,dispatch:n})=>{var o;const{stationNames:i}=t().runtime,a=i[e];if(0==(null!==(o=null==a?void 0:a.length)&&void 0!==o?o:0))return s.debug("No random station names in cache, using fallback"),n(se({cityName:e})),Object.values((e=>{const t=ie[e];return t.at(Math.floor(Math.random()*t.length))})(e));const l=structuredClone(a),c=l.shift();return n(r({cityName:e,names:l})),l.length<3&&n(se({cityName:e})),Object.values(c)})),le=(e,t,n,o,r,i,s)=>{if(!("offsetFrom"in i)||!("offsetTo"in i))return;if(Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return ce(e,t,n,o,r)?s<0?{x1:t,y1:n,x2:o,y2:r,offset:i.offsetFrom}:t===o?{x1:t+5*s,y1:n,x2:o+5*s,y2:r,offset:i.offsetFrom}:n===r?{x1:t,y1:n+5*s,x2:o,y2:r+5*s,offset:i.offsetFrom}:{x1:t+5*Math.SQRT1_2*s,y1:n+5*Math.SQRT1_2*s,x2:o+5*Math.SQRT1_2*s,y2:r+5*Math.SQRT1_2*s,offset:i.offsetFrom}:void 0;const[a,l]=[i.offsetFrom,i.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let i=c,s=0;s<2;s++,i+=Math.PI){const[s,d,u,h]=[Math.sin(c)*a,Math.cos(c)*a,Math.sin(i)*l,Math.cos(i)*l];if(ce(e,t+s,n+d,o+u,r+h))return{x1:t+s,y1:n+d,x2:o+u,y2:r+h,offset:0}}},ce=(e,t,n,o,r)=>!(t!==o&&n!==r||![a.Diagonal,a.Perpendicular].includes(e))||!(1!==Math.abs((r-n)/(o-t))||![a.Diagonal,a.RotatePerpendicular].includes(e)),de=(e,t)=>{if(!t.every((t=>e.hasEdge(t))))return;const n=t.map((t=>{var n,o,r;const[i,s]=e.extremities(t),c=e.getNodeAttributes(i),d=e.getNodeAttributes(s),{type:u,parallelIndex:h}=e.getEdgeAttributes(t),y=null!==(n=e.getEdgeAttribute(t,u))&&void 0!==n?n:l[u].defaultAttrs,p=le(u,c.x,c.y,d.x,d.y,y,h);if(p){const{x1:e,y1:t,x2:n,y2:o,offset:r}=p;return l[a.Simple].generatePath(e,n,t,o,{offset:r})}return null!==(o=null===(r=l[u])||void 0===r?void 0:r.generatePath(c.x,d.x,c.y,d.y,y))&&void 0!==o?o:`M ${c.x} ${c.y} L ${d.x} ${d.y}`}));let o=`${n[0]} `;for(let r=1;r<t.length;r+=1)o+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return o},ue=e=>[...e.nodeEntries()].map((e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes})),he=e=>{const t={},n=[],o={},r=[];for(const c of e.edgeEntries()){const[e,i,s,d]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y],u=le(c.attributes.type,e,i,s,d,c.attributes[c.attributes.type],c.attributes.parallelIndex);if(u);else if(c.attributes.parallelIndex>=0){n.push(c);continue}if(""===c.attributes.reconcileId)if(u){const e=c.edge,n=c.attributes,{x1:o,y1:r,x2:i,y2:s,offset:d}=u;t[e]={id:e,attr:n,path:l[a.Simple].generatePath(o,i,r,s,{offset:d})}}else r.push(c);else{const e=c.attributes.reconcileId;e in o?o[e].push(c):o[e]=[c]}}const i=new Set;for(;n.length;){const o=n.pop();if(i.has(o.edge))continue;const{normal:s,parallel:a}=c(e,o);if(!a.length)continue;a.forEach((e=>i.add(e.edge))),r.push(...s);const l=d(a);for(const e of a){const n=e.edge;t[n]={id:e.edge,attr:e.attributes,path:l[n]}}}const{allReconciledLines:s,danglingLines:u}=((e,t)=>{const n=[],o=[];return Object.values(t).forEach((t=>{if(1===t.length)return void o.push(...t.map((e=>e.edge)));const r=e.getEdgeAttribute(t.at(0),"type");if(!t.every((t=>e.getEdgeAttribute(t,"type")===r)))return void o.push(...t.map((e=>e.edge)));const i=e.getEdgeAttribute(t.at(0),"style");if(!t.every((t=>e.getEdgeAttribute(t,"style")===i)))return void o.push(...t.map((e=>e.edge)));const s={},a=new Set,l=new Set,c=Object.fromEntries(t.map((t=>{var n,o;const[r,i]=e.extremities(t);return s[r]=(null!==(n=s[r])&&void 0!==n?n:0)+1,s[i]=(null!==(o=s[i])&&void 0!==o?o:0)+1,a.add(r),l.add(i),[r,[t.edge,i]]}))),d=Array.from(a).filter((e=>1===s[e])),u=Array.from(l).filter((e=>1===s[e]));if(1!==d.length||1!==u.length)return void o.push(...t.map((e=>e.edge)));const h=d[0],y=u[0];if(h===y)return void o.push(...t.map((e=>e.edge)));const p=[c[h][0]];let f=c[h][1];for(let e=1;e<t.length;e+=1){var x;const e=null===(x=c[f])||void 0===x?void 0:x.at(1);if(!e)return void o.push(...t.map((e=>e.edge)));p.push(c[f][0]),f=e}f===y&&p.length===t.length?n.push(p):o.push(...t.map((e=>e.edge)))})),{allReconciledLines:n,danglingLines:o}})(e,o);for(const a of s){const n=de(e,a);if(!n)continue;const o=a[0];t[o]={id:o,attr:e.getEdgeAttributes(o),path:n}}for(const c of u){const n=e.getEdgeAttributes(c),[o,r]=e.extremities(c),i=e.getNodeAttributes(o),s=e.getNodeAttributes(r);t[c]={id:c,attr:n,path:l[a.Simple].generatePath(i.x,s.x,i.y,s.y,l[a.Simple].defaultAttrs)}}for(const a of r){const e=a.edge,n=a.attributes.type,o=a.attributes,[r,i,s,c]=[a.sourceAttributes.x,a.sourceAttributes.y,a.targetAttributes.x,a.targetAttributes.y];t[e]=n in l?{id:e,attr:o,path:l[n].generatePath(r,s,i,c,o[n])}:{id:e,attr:o,path:`M ${r} ${i} L ${s} ${c}`}}return Object.values(t).map((e=>({id:e.id,type:"line",line:e})))},ye=e=>{const{id:t,x:o,y:r,handlePointerDown:i,handlePointerMove:s,handlePointerUp:a}=e,l=Z.useCallback((e=>i(t,e)),[t,i]),c=Z.useCallback((e=>s(t,e)),[t,s]),d=Z.useCallback((e=>a(t,e)),[t,a]);return n.jsx("g",{id:t,transform:`translate(${o-6.4} ${r-6.4})scale(0.025)`,onPointerDown:l,onPointerMove:c,onPointerUp:d,style:{cursor:"move"},children:n.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},pe=e=>{const{id:t,path:o,handlePointerDown:r}=e,i=Z.useCallback((e=>r(t,e)),[t,r]);return n.jsx("path",{id:t,d:o,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},fe=Z.memo((e=>{const{elements:t,handlePointerDown:o,handlePointerMove:r,handlePointerUp:i,handleEdgePointerDown:s}=e,a=Object.fromEntries(Array.from({length:21},((e,t)=>[t-10,{pre:[],main:[],post:[]}])));for(const w of t)if("line"===w.type){var l,c,d,h;const e=w.line.attr.type,t=w.line.attr.style,o=w.line.attr[t],r=null===(l=u[t])||void 0===l?void 0:l.preComponent;r&&a[w.line.attr.zIndex].pre.push(n.jsx(r,{id:w.id,type:e,path:w.line.path,styleAttrs:o,newLine:!1,handlePointerDown:s},`${w.id}.pre`));const i=null!==(c=null===(d=u[t])||void 0===d?void 0:d.component)&&void 0!==c?c:pe;a[w.line.attr.zIndex].main.push(n.jsx(i,{id:w.id,type:e,path:w.line.path,styleAttrs:o,newLine:!1,handlePointerDown:s},w.id));const y=null===(h=u[t])||void 0===h?void 0:h.postComponent;y&&a[w.line.attr.zIndex].post.push(n.jsx(y,{id:w.id,type:e,path:w.line.path,styleAttrs:o,newLine:!1,handlePointerDown:s},`${w.id}.post`))}else if("station"===w.type){var y,p,f,x;const e=w.station,t=e.type,s=null===(y=B[t])||void 0===y?void 0:y.preComponent;s&&a[w.station.zIndex].pre.push(n.jsx(s,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},`${w.id}.pre`));const l=null!==(p=null===(f=B[t])||void 0===f?void 0:f.component)&&void 0!==p?p:ye;a[w.station.zIndex].main.push(n.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},w.id));const c=null===(x=B[t])||void 0===x?void 0:x.postComponent;c&&a[w.station.zIndex].post.push(n.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},`${w.id}.post`))}else if("misc-node"===w.type){var g,m,v,b;const e=w.miscNode,t=e.type,s=null===(g=oe[t])||void 0===g?void 0:g.preComponent;s&&a[w.miscNode.zIndex].pre.push(n.jsx(s,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},`${w.id}.pre`));const l=null!==(m=null===(v=oe[t])||void 0===v?void 0:v.component)&&void 0!==m?m:ye;a[w.miscNode.zIndex].main.push(n.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},w.id));const c=null===(b=oe[t])||void 0===b?void 0:b.postComponent;c&&a[w.miscNode.zIndex].post.push(n.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:o,handlePointerMove:r,handlePointerUp:i},`${w.id}.post`))}return Array.from({length:21},((e,t)=>(t-10).toString())).map((e=>[...a[e].pre,...a[e].main,...a[e].post])).flat()}),((e,t)=>e.elements===t.elements)),xe=[...Object.values(h),y.Virtual,y.Master,y.LondonArrow],ge=()=>{const e=p(),t=Z.useRef(window.graph),{telemetry:{project:o},preference:{autoParallel:r}}=f((e=>e.app)),{svgViewBoxZoom:i,svgViewBoxMin:s}=f((e=>e.param)),{selected:a,refresh:{nodes:c,edges:d},mode:u,active:h,keepLastPath:y,theme:_}=f((e=>e.runtime)),[$,T]=Z.useState({x:0,y:0}),[H,W]=Z.useState({x:0,y:0}),K=ee(((t,n)=>{n.stopPropagation(),"select"===u&&e(x("free"));const o=n.currentTarget,{x:r,y:i}=g(n);o.setPointerCapture(n.pointerId),T({x:r,y:i}),e(m(t)),n.shiftKey?a.has(t)?e(b(t)):e(w(t)):a.has(t)||e(v(new Set([t])))})),L=ee(((n,o)=>{const{x:r,y:s}=g(o);"free"===u&&h===n?(a.forEach((e=>{t.current.hasNode(e)&&t.current.updateNodeAttributes(e,(e=>({...e,x:A(e.x-($.x-r)*i/100,o.altKey?1:5),y:A(e.y-($.y-s)*i/100,o.altKey?1:5)})))})),e(P()),e(z())):u.startsWith("line")&&W({x:($.x-r)*i/100,y:($.y-s)*i/100})})),R=ee(((n,i)=>{if(u.startsWith("line")){y||e(x("free"));const n=t.current.hasNode(h)&&xe.includes(t.current.getNodeAttribute(h,"type"));["stn_core_","virtual_circle_"].forEach((e=>{var s;const a=null===(s=document.elementsFromPoint(i.clientX,i.clientY)[0].attributes)||void 0===s||null===(s=s.getNamedItem("id"))||void 0===s?void 0:s.value,c=null==a?void 0:a.startsWith(e);if(n&&c){const n=u.slice(5),i=`line_${N(10)}`,[s,c]=[h,a.slice(e.length)],d=r?k(t.current,n,s,c,"from"):-1;t.current.addDirectedEdgeWithKey(i,s,c,{visible:!0,zIndex:0,type:n,[n]:structuredClone(l[n].defaultAttrs),style:j.SingleColor,[j.SingleColor]:{color:_},reconcileId:"",parallelIndex:d}),o&&S.event(C.ADD_LINE,{type:n})}})),e(z()),e(D(t.current.export()))}else if("free"===u&&h){const{x:n,y:o}=g(i);$.x-n==0&&$.y-o==0||e(D(t.current.export()))}e(m(void 0))})),O=ee(((n,l)=>{if(l.stopPropagation(),l.shiftKey||e(E()),l.shiftKey&&a.has(n)?e(b(n)):e(w(n)),u.startsWith("station")||u.startsWith("misc-node-virtual")||u.startsWith("misc-node-master")){const a=l.clientX-document.getElementById("canvas").getBoundingClientRect().left,c=l.clientY-document.getElementById("canvas").getBoundingClientRect().top,d=u.startsWith("station"),h=N(10),y=d?`stn_${h}`:`misc_node_${h}`,p=d?u.slice(8):u.slice(10),{x:f,y:g}=I(a,c,i,s),m=d?structuredClone(B[p].defaultAttrs):structuredClone(oe[p].defaultAttrs);"color"in m&&(m.color=_),t.current.addNode(y,{visible:!0,zIndex:0,x:A(f,5),y:A(g,5),type:p,[p]:m});const b=t.current.getEdgeAttributes(n),{zIndex:w,type:k,style:j}=b,E=b[k],M=b[j],[$,T]=t.current.extremities(n),H=r?0:-1;t.current.addDirectedEdgeWithKey(`line_${N(10)}`,$,y,{visible:!0,zIndex:w,type:k,[k]:structuredClone(E),style:j,[j]:structuredClone(M),reconcileId:"",parallelIndex:H}),t.current.addDirectedEdgeWithKey(`line_${N(10)}`,y,T,{visible:!0,zIndex:w,type:k,[k]:structuredClone(E),style:j,[j]:structuredClone(M),reconcileId:"",parallelIndex:H}),t.current.dropEdge(n),e(P()),e(z()),e(D(t.current.export())),o&&(S.event(C.ADD_STATION,{type:p}),S.event(C.ADD_LINE,{type:k})),e(x("free")),e(v(new Set([y])))}})),U=Z.useMemo((()=>[...he(t.current),...ue(t.current)]),[d,c]),F=M.component;return n.jsxs(n.Fragment,{children:[n.jsx(fe,{elements:U,handlePointerDown:K,handlePointerMove:L,handlePointerUp:R,handleEdgePointerDown:O}),u.startsWith("line")&&h&&"background"!==h&&n.jsx(F,{id:"line_create_in_progress___no_use",type:u.slice(5),path:l[u.slice(5)].generatePath(t.current.getNodeAttribute(h,"x"),t.current.getNodeAttribute(h,"x")-H.x,t.current.getNodeAttribute(h,"y"),t.current.getNodeAttribute(h,"y")-H.y,l[u.slice(5)].defaultAttrs),styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}})]})};e("default",(()=>{const e=p(),t=Z.useRef(window.graph),r=()=>{e(P()),e(z()),e(D(t.current.export()))},{activeSubscriptions:i}=f((e=>e.account)),{telemetry:{project:s},preference:{randomStationsNames:a}}=f((e=>e.app)),{svgViewBoxZoom:l,svgViewBoxMin:c}=f((e=>e.param)),{mode:d,lastTool:u,active:h,selected:y,keepLastPath:b,theme:w,refresh:{nodes:k},masterNodesCount:j,parallelLinesCount:M}=f((e=>e.runtime)),J=F(),{height:G,width:ie}=_(J),se=!i.RMP_CLOUD&&j+1>$,le=!i.RMP_CLOUD&&M+1>T,ce=!i.RMP_CLOUD||"none"===a;Z.useEffect((()=>{const e=X(t.current);Object.entries(e).filter((([e,t])=>t&&e in Y)).forEach((([e])=>Q(e)))}),[k]);const{update:de}=Z.useContext(U);Z.useEffect((()=>{document.fonts.load("12px Arial","ABCDEFG123456").finally((()=>setTimeout(de,100)))}),[]);const[ue,he]=Z.useState({x:0,y:0}),[ye,pe]=Z.useState({x:0,y:0}),[fe,xe]=Z.useState({x:0,y:0}),[me,ve]=Z.useState({x:0,y:0}),be=ee((async n=>{const{x:i,y:a}=g(n);if(d.startsWith("station")){e(x("free"));const n=`stn_${N(10)}`,u=d.slice(8),h=structuredClone(B[u].defaultAttrs);if("color"in h&&(h.color=w),!ce){const t=await e(ae(o.Shmetro));if(ae.fulfilled.match(t)){const e=t.payload;h.names.length>e.length?e.push(...Array(h.names.length-e.length).fill(e.at(-1))):h.names.length<e.length&&e.splice(h.names.length,e.length-h.names.length),h.names=e}}const{x:y,y:p}=I(i,a,l,c);t.current.addNode(n,{visible:!0,zIndex:0,x:A(y,5),y:A(p,5),type:u,[u]:h}),r(),s&&S.event(C.ADD_STATION,{type:u}),e(v(new Set([n])))}else if(d.startsWith("misc-node")){e(x("free"));const n=`misc_node_${N(10)}`,o=d.slice(10),{x:u,y:h}=I(i,a,l,c);t.current.addNode(n,{visible:!0,zIndex:0,x:A(u,5),y:A(h,5),type:o,[o]:structuredClone(oe[o].defaultAttrs)}),r(),s&&S.event(C.ADD_STATION,{type:o}),e(v(new Set([n])))}else"free"===d||d.startsWith("line")?(d.startsWith("line")&&(e(x("free")),b&&e(H(!1))),xe({x:i,y:a}),ve(c),n.shiftKey||(e(m("background")),e(E()))):"select"===d&&(he(I(i,a,l,c)),pe(I(i,a,l,c)))})),we=ee((t=>{if("select"===d){if(0!=ue.x&&0!=ue.y){const{x:e,y:n}=g(t);pe(I(e,n,l,c))}}else if("background"===h){const{x:n,y:o}=g(t);e(W({x:me.x+(fe.x-n)*l/100,y:me.y+(fe.y-o)*l/100}))}})),Ae=ee((n=>{if("select"===d){const{x:o,y:r}=g(n),{x:i,y:s}=I(o,r,l,c),a=V(t.current,ue.x,ue.y,i,s),d=q(t.current,new Set(a));e(v(new Set([...n.shiftKey?y:[],...a,...d]))),e(x("free")),he({x:0,y:0}),pe({x:0,y:0})}"background"!==h||n.shiftKey||e(m(void 0))})),Pe=ee((t=>{let n=l;t.deltaY>0&&l+10<400?n=l+10:t.deltaY<0&&l-10>0&&(n=l-10),e(K(n));const{x:o,y:r}=g(t),i=t.currentTarget.getBoundingClientRect(),[s,a]=[o/i.width,r/i.height];e(W({x:c.x+o*l/100-ie*n/100*s,y:c.y+r*l/100-G*n/100*a}))})),ze=ee((async n=>{if(L?"Backspace"===n.key:"Delete"===n.key)y.size>0&&(y.forEach((e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)})),e(E()),r());else if(n.key.startsWith("Arrow")){const t=100,o=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,r=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;e(W(I(t*o,t*r,l,c)))}else if("i"===n.key||"j"===n.key||"k"===n.key||"l"===n.key){const e=10,o=("j"===n.key?-1:"l"===n.key?1:0)*e,i=("i"===n.key?-1:"k"===n.key?1:0)*e;y.size>0&&y.forEach((e=>{t.current.hasNode(e)&&(t.current.updateNodeAttribute(e,"x",(e=>(null!=e?e:0)+o)),t.current.updateNodeAttribute(e,"y",(e=>(null!=e?e:0)+i)),r())}))}else if("f"===n.key&&u)e(x(u));else if("z"===n.key&&(L?n.metaKey&&!n.shiftKey:n.ctrlKey))L&&n.preventDefault(),e(R()),e(P()),e(z());else if("s"===n.key)e(x("select"));else if("c"!==n.key&&"x"!==n.key||!(L?n.metaKey&&!n.shiftKey:n.ctrlKey))if("v"===n.key&&(L?n.metaKey&&!n.shiftKey:n.ctrlKey)){const n=await navigator.clipboard.readText(),{x:o,y:i}=I(ie/2,G/2,l,c),{nodes:s,edges:a}=ne(n,t.current,se,le,A(o,5),A(i,5));r();const d=structuredClone(s);a.forEach((e=>d.add(e))),e(v(d))}else(L&&"z"===n.key&&n.metaKey&&n.shiftKey||!L&&"y"===n.key&&n.ctrlKey)&&(e(O()),e(P()),e(z()));else{const o=te(t.current,y);navigator.clipboard.writeText(o),"x"===n.key&&(e(E()),y.forEach((e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)})),r())}})),[Ne,ke]=Z.useState(0),je=ee((t=>{if(2===t.touches.length){e(m(void 0));const[n,o]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];ke(n*n+o*o)}})),Se=ee((t=>{if(0!==Ne&&2===t.touches.length){const[n,o]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],r=n*n+o*o;let i=l;r-Ne<0&&l+10<=390?i=l+10:r-Ne>0&&l-10>=10&&(i=l-10),e(K(i)),ke(r);const s=t.currentTarget.getBoundingClientRect(),[a,d]=[(t.touches[0].clientX+t.touches[1].clientX)/2-s.left,(t.touches[0].clientY+t.touches[1].clientY)/2-s.top],[u,h]=[a/s.width,d/s.height];e(W({x:c.x+a*l/100-ie*i/100*u,y:c.y+d*l/100-G*i/100*h}))}})),Ce=ee((e=>{0!==Ne&&ke(0)})),[De,Ee]=Z.useState({sx:0,sy:0,ex:0,ey:0});return Z.useEffect((()=>{Ee({sx:ue.x<=ye.x?ue.x:ye.x,ex:ue.x>ye.x?ue.x:ye.x,sy:ue.y<=ye.y?ue.y:ye.y,ey:ue.y>ye.y?ue.y:ye.y})}),[ye.x,ye.y]),n.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:G,width:ie,viewBox:`${c.x} ${c.y} ${ie*l/100} ${G*l/100}`,onPointerDown:be,onPointerMove:we,onPointerUp:Ae,onTouchStart:je,onTouchMove:Se,onTouchEnd:Ce,onWheel:Pe,tabIndex:0,onKeyDown:ze,children:[n.jsx(re,{children:n.jsx(ge,{})}),"select"===d&&0!=ue.x&&0!=ue.y&&n.jsx("rect",{x:De.sx,y:De.sy,width:De.ex-De.sx,height:De.ey-De.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),n.jsx("defs",{children:n.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[n.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),n.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})}))}}}));
