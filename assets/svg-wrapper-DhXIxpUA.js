import{j as E}from"./chakra-xNcrfRXW.js";import{a3 as zt,ap as Et,aq as Wt,N as Tt,k as tt,l as O,ar as Kt,as as Rt,at as wt,S as Ot,au as Pt,c as It,d as st,av as Q,aw as J,ax as lt,T as it,ay as kt,az as Ct,aA as X,q as dt,t as ct,n as at,m as Ft,o as Nt,r as ut,E as ft,v as bt,y as St,U as V,aB as Ht,p as Xt,aC as Ut,a0 as Yt,a1 as Vt,A as xt,z as Mt,a9 as nt,am as Qt,an as Zt}from"./index-l4M2j_6g.js";import{f as $t,b as L}from"./react-D-_si4LB.js";import{u as W,e as Gt,i as qt}from"./clipboard-C3pyYGFw.js";import{s as ht,u as Jt,f as te,F as ee,l as ne,b as se,c as oe}from"./master-manager-Bm21rzpL.js";import{m as yt}from"./misc-nodes-Can-QSao.js";const re={[zt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}]},ie=t=>{const e=re[t];return e.at(Math.floor(Math.random()*e.length))},_t=$t("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:l,rejectWithValue:c})=>{const{token:o}=e().account;if(!o){l(Et({cityName:t,names:[]}));return}const d=await fetch("".concat(Wt,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!d.ok)return Tt.warn("Failed to fetch random station names",d.statusText),c(d.statusText);const r=await d.json();l(Et({cityName:t,names:r}))}),Dt=$t("runtime/getOneStationName",async(t,{getState:e,dispatch:l})=>{var u;const{stationNames:c}=e().runtime,o=c[t];if(((u=o==null?void 0:o.length)!=null?u:0)==0)return Tt.debug("No random station names in cache, using fallback"),l(_t({cityName:t})),Object.values(ie(t));const d=structuredClone(o),r=d.shift();return l(Et({cityName:t,names:d})),d.length<3&&l(_t({cityName:t})),Object.values(r)}),Bt=(t,e,l,c,o,d,r)=>{if(!("offsetFrom"in d)||!("offsetTo"in d)||Number.isNaN(d.offsetFrom)||Number.isNaN(d.offsetTo))return;if(d.offsetFrom===d.offsetTo)return Lt(t,e,l,c,o)?r<0?{x1:e,y1:l,x2:c,y2:o,offset:d.offsetFrom}:e===c?{x1:e+5*r,y1:l,x2:c+5*r,y2:o,offset:d.offsetFrom}:l===o?{x1:e,y1:l+5*r,x2:c,y2:o+5*r,offset:d.offsetFrom}:{x1:e+5*Math.SQRT1_2*r,y1:l+5*Math.SQRT1_2*r,x2:c+5*Math.SQRT1_2*r,y2:o+5*Math.SQRT1_2*r,offset:d.offsetFrom}:void 0;const[u,s]=[d.offsetFrom,d.offsetTo];for(let g=0;g<Math.PI;g+=Math.PI/8)for(let a=g,f=0;f<2;f++,a+=Math.PI){const[A,S,v,M]=[Math.sin(g)*u,Math.cos(g)*u,Math.sin(a)*s,Math.cos(a)*s];if(Lt(t,e+A,l+S,c+v,o+M))return{x1:e+A,y1:l+S,x2:c+v,y2:o+M,offset:0}}},Lt=(t,e,l,c,o)=>!!((e===c||l===o)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((o-l)/(c-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),ae=(t,e)=>{const l=[],c=[];return Object.values(e).forEach(o=>{var T;if(o.length===1){c.push(...o.map(h=>h.edge));return}const d=t.getEdgeAttribute(o.at(0),"type");if(!o.every(h=>t.getEdgeAttribute(h,"type")===d)){c.push(...o.map(h=>h.edge));return}const r=t.getEdgeAttribute(o.at(0),"style");if(!o.every(h=>t.getEdgeAttribute(h,"style")===r)){c.push(...o.map(h=>h.edge));return}const u={},s=new Set,g=new Set,a=Object.fromEntries(o.map(h=>{var m,C;const[k,i]=t.extremities(h);return u[k]=((m=u[k])!=null?m:0)+1,u[i]=((C=u[i])!=null?C:0)+1,s.add(k),g.add(i),[k,[h.edge,i]]})),f=Array.from(s).filter(h=>u[h]===1),A=Array.from(g).filter(h=>u[h]===1);if(f.length!==1||A.length!==1){c.push(...o.map(h=>h.edge));return}const S=f[0],v=A[0];if(S===v){c.push(...o.map(h=>h.edge));return}const M=[a[S][0]];let z=a[S][1];for(let h=1;h<o.length;h=h+1){const k=(T=a[z])==null?void 0:T.at(1);if(!k){c.push(...o.map(i=>i.edge));return}M.push(a[z][0]),z=k}if(z!==v||M.length!==o.length){c.push(...o.map(h=>h.edge));return}l.push(M)}),{allReconciledLines:l,danglingLines:c}},ce=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const l=e.map(o=>{var S,v,M;const[d,r]=t.extremities(o),u=t.getNodeAttributes(d),s=t.getNodeAttributes(r),{type:g,parallelIndex:a}=t.getEdgeAttributes(o),f=(S=t.getEdgeAttribute(o,g))!=null?S:O[g].defaultAttrs,A=Bt(g,u.x,u.y,s.x,s.y,f,a);if(A){const{x1:z,y1:T,x2:h,y2:k,offset:i}=A;return O[tt.Simple].generatePath(z,h,T,k,{offset:i})}return(M=(v=O[g])==null?void 0:v.generatePath(u.x,s.x,u.y,s.y,f))!=null?M:"M ".concat(u.x," ").concat(u.y," L ").concat(s.x," ").concat(s.y)});let c="".concat(l[0]," ");for(let o=1;o<e.length;o=o+1)c+=l[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},le=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),de=t=>{const e={},l=[],c={},o=[];for(const s of t.edgeEntries()){const[g,a,f,A]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],S=Bt(s.attributes.type,g,a,f,A,s.attributes[s.attributes.type],s.attributes.parallelIndex);if(!S){if(s.attributes.parallelIndex>=0){l.push(s);continue}}if(s.attributes.reconcileId!==""){const v=s.attributes.reconcileId;v in c?c[v].push(s):c[v]=[s];continue}if(S){const v=s.edge,M=s.attributes,{x1:z,y1:T,x2:h,y2:k,offset:i}=S;e[v]={id:v,attr:M,path:O[tt.Simple].generatePath(z,h,T,k,{offset:i})};continue}o.push(s)}const d=new Set;for(;l.length;){const s=l.pop();if(d.has(s.edge))continue;const{normal:g,parallel:a}=Kt(t,s);if(!a.length)continue;a.forEach(A=>d.add(A.edge)),o.push(...g);const f=Rt(a);for(const A of a){const S=A.edge;e[S]={id:A.edge,attr:A.attributes,path:f[S]}}}const{allReconciledLines:r,danglingLines:u}=ae(t,c);for(const s of r){const g=ce(t,s);if(!g)continue;const a=s[0];e[a]={id:a,attr:t.getEdgeAttributes(a),path:g}}for(const s of u){const g=t.getEdgeAttributes(s),[a,f]=t.extremities(s),A=t.getNodeAttributes(a),S=t.getNodeAttributes(f);e[s]={id:s,attr:g,path:O[tt.Simple].generatePath(A.x,S.x,A.y,S.y,O[tt.Simple].defaultAttrs)}}for(const s of o){const g=s.edge,a=s.attributes.type,f=s.attributes,[A,S,v,M]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(a in O)){e[g]={id:g,attr:f,path:"M ".concat(A," ").concat(S," L ").concat(v," ").concat(M)};continue}e[g]={id:g,attr:f,path:O[a].generatePath(A,v,S,M,f[a])}}return Object.values(e).map(s=>({id:s.id,type:"line",line:s}))},jt=t=>{const{id:e,x:l,y:c,handlePointerDown:o,handlePointerMove:d,handlePointerUp:r}=t,u=L.useCallback(a=>o(e,a),[e,o]),s=L.useCallback(a=>d(e,a),[e,d]),g=L.useCallback(a=>r(e,a),[e,r]);return E.jsx("g",{id:e,transform:"translate(".concat(l-6.4," ").concat(c-6.4,")scale(0.025)"),onPointerDown:u,onPointerMove:s,onPointerUp:g,style:{cursor:"move"},children:E.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ue=t=>{const{id:e,path:l,handlePointerDown:c}=t,o=L.useCallback(d=>c(e,d),[e,c]);return E.jsx("path",{id:e,d:l,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},fe=L.memo(t=>{var s,g,a,f,A,S,v,M,z,T,h,k;const{elements:e,handlePointerDown:l,handlePointerMove:c,handlePointerUp:o,handleEdgePointerDown:d}=t,r=Object.fromEntries(Array.from({length:21},(i,m)=>[m-10,{pre:[],main:[],post:[]}]));for(const i of e)if(i.type==="line"){const m=i.line.attr.type,C=i.line.attr.style,P=i.line.attr[C],b=(s=wt[C])==null?void 0:s.preComponent;b&&r[i.line.attr.zIndex].pre.push(E.jsx(b,{id:i.id,type:m,path:i.line.path,styleAttrs:P,newLine:!1,handlePointerDown:d},"".concat(i.id,".pre")));const y=(a=(g=wt[C])==null?void 0:g.component)!=null?a:ue;r[i.line.attr.zIndex].main.push(E.jsx(y,{id:i.id,type:m,path:i.line.path,styleAttrs:P,newLine:!1,handlePointerDown:d},i.id));const j=(f=wt[C])==null?void 0:f.postComponent;j&&r[i.line.attr.zIndex].post.push(E.jsx(j,{id:i.id,type:m,path:i.line.path,styleAttrs:P,newLine:!1,handlePointerDown:d},"".concat(i.id,".post")))}else if(i.type==="station"){const m=i.station,C=m.type,P=(A=ht[C])==null?void 0:A.preComponent;P&&r[i.station.zIndex].pre.push(E.jsx(P,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},"".concat(i.id,".pre")));const b=(v=(S=ht[C])==null?void 0:S.component)!=null?v:jt;r[i.station.zIndex].main.push(E.jsx(b,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},i.id));const y=(M=ht[C])==null?void 0:M.postComponent;y&&r[i.station.zIndex].post.push(E.jsx(y,{id:i.id,x:m.x,y:m.y,attrs:m,handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},"".concat(i.id,".post")))}else if(i.type==="misc-node"){const m=i.miscNode,C=m.type,P=(z=yt[C])==null?void 0:z.preComponent;P&&r[i.miscNode.zIndex].pre.push(E.jsx(P,{id:i.id,x:m.x,y:m.y,attrs:m[C],handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},"".concat(i.id,".pre")));const b=(h=(T=yt[C])==null?void 0:T.component)!=null?h:jt;r[i.miscNode.zIndex].main.push(E.jsx(b,{id:i.id,x:m.x,y:m.y,attrs:m[C],handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},i.id));const y=(k=yt[C])==null?void 0:k.postComponent;y&&r[i.miscNode.zIndex].post.push(E.jsx(y,{id:i.id,x:m.x,y:m.y,attrs:m[C],handlePointerDown:l,handlePointerMove:c,handlePointerUp:o},"".concat(i.id,".post")))}return Array.from({length:21},(i,m)=>(m-10).toString()).map(i=>[...r[i].pre,...r[i].main,...r[i].post]).flat()},(t,e)=>t.elements===e.elements),he=[...Object.values(Ot),Pt.Virtual,Pt.Master,Pt.LondonArrow],ye=()=>{const t=It(),e=L.useRef(window.graph),l=()=>{t(dt()),t(ct()),t(bt(e.current.export()))},{telemetry:{project:c},preference:{autoParallel:o}}=st(b=>b.app),{svgViewBoxZoom:d,svgViewBoxMin:r}=st(b=>b.param),{selected:u,refresh:{nodes:s,edges:g},mode:a,active:f,keepLastPath:A,theme:S}=st(b=>b.runtime),[v,M]=L.useState({x:0,y:0}),[z,T]=L.useState({x:0,y:0}),h=W((b,y)=>{y.stopPropagation(),a==="select"&&t(Q("free"));const j=y.currentTarget,{x:B,y:I}=J(y);j.setPointerCapture(y.pointerId),M({x:B,y:I}),t(lt(b)),y.shiftKey?u.has(b)?t(kt(b)):t(Ct(b)):u.has(b)||t(it(new Set([b])))}),k=W((b,y)=>{const{x:j,y:B}=J(y);a==="free"&&f===b?(u.forEach(I=>{e.current.hasNode(I)&&e.current.updateNodeAttributes(I,F=>({...F,x:X(F.x-(v.x-j)*d/100,y.altKey?1:5),y:X(F.y-(v.y-B)*d/100,y.altKey?1:5)}))}),t(dt()),t(ct())):a.startsWith("line")&&T({x:(v.x-j)*d/100,y:(v.y-B)*d/100})}),i=W((b,y)=>{if(a.startsWith("line")){A||t(Q("free"));const j=e.current.hasNode(f)&&he.includes(e.current.getNodeAttribute(f,"type"));["stn_core_","virtual_circle_"].forEach(I=>{var ot,rt;const K=(rt=(ot=document.elementsFromPoint(y.clientX,y.clientY)[0].attributes)==null?void 0:ot.getNamedItem("id"))==null?void 0:rt.value,U=K==null?void 0:K.startsWith(I);if(j&&U){const R=a.slice(5),et="line_".concat(at(10)),[H,$]=[f,K.slice(I.length)],Y=o?Ft(e.current,R,H,$,"from"):-1;e.current.addDirectedEdgeWithKey(et,H,$,{visible:!0,zIndex:0,type:R,[R]:structuredClone(O[R].defaultAttrs),style:Nt.SingleColor,[Nt.SingleColor]:{color:S},reconcileId:"",parallelIndex:Y}),c&&ut.event(ft.ADD_LINE,{type:R})}}),t(ct()),t(bt(e.current.export()))}else if(a==="free"&&f){const{x:j,y:B}=J(y);v.x-j===0&&v.y-B===0||t(bt(e.current.export()))}t(lt(void 0))}),m=W((b,y)=>{if(y.stopPropagation(),y.shiftKey||t(St()),y.shiftKey&&u.has(b)?t(kt(b)):t(Ct(b)),a.startsWith("station")||a.startsWith("misc-node-virtual")||a.startsWith("misc-node-master")){const j=y.clientX-document.getElementById("canvas").getBoundingClientRect().left,B=y.clientY-document.getElementById("canvas").getBoundingClientRect().top,I=a.startsWith("station"),F=at(10),K=I?"stn_".concat(F):"misc_node_".concat(F),U=I?a.slice(8):a.slice(10),{x:ot,y:rt}=V(j,B,d,r),R=I?structuredClone(ht[U].defaultAttrs):structuredClone(yt[U].defaultAttrs);"color"in R&&(R.color=S),e.current.addNode(K,{visible:!0,zIndex:0,x:X(ot,5),y:X(rt,5),type:U,[U]:R});const et=e.current.getEdgeAttributes(b),{zIndex:H,type:$,style:Y}=et,pt=et[$],gt=et[Y],[Z,vt]=e.current.extremities(b),n=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),Z,K,{visible:!0,zIndex:H,type:$,[$]:structuredClone(pt),style:Y,[Y]:structuredClone(gt),reconcileId:"",parallelIndex:n}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),K,vt,{visible:!0,zIndex:H,type:$,[$]:structuredClone(pt),style:Y,[Y]:structuredClone(gt),reconcileId:"",parallelIndex:n}),e.current.dropEdge(b),l(),c&&(ut.event(ft.ADD_STATION,{type:U}),ut.event(ft.ADD_LINE,{type:$})),t(Q("free")),t(it(new Set([K])))}}),C=L.useMemo(()=>[...de(e.current),...le(e.current)],[g,s]),P=Ht.component;return E.jsxs(E.Fragment,{children:[E.jsx(fe,{elements:C,handlePointerDown:h,handlePointerMove:k,handlePointerUp:i,handleEdgePointerDown:m}),a.startsWith("line")&&f&&f!=="background"&&E.jsx(P,{id:"line_create_in_progress___no_use",type:a.slice(5),path:O[a.slice(5)].generatePath(e.current.getNodeAttribute(f,"x"),e.current.getNodeAttribute(f,"x")-z.x,e.current.getNodeAttribute(f,"y"),e.current.getNodeAttribute(f,"y")-z.y,O[a.slice(5)].defaultAttrs),styleAttrs:{color:S},newLine:!0,handlePointerDown:()=>{}})]})},ve=()=>{const t=It(),e=L.useRef(window.graph),l=()=>{t(dt()),t(ct()),t(bt(e.current.export()))},{activeSubscriptions:c}=st(n=>n.account),{telemetry:{project:o},preference:{randomStationsNames:d}}=st(n=>n.app),{svgViewBoxZoom:r,svgViewBoxMin:u}=st(n=>n.param),{mode:s,lastTool:g,active:a,selected:f,keepLastPath:A,theme:S,refresh:{nodes:v},masterNodesCount:M,parallelLinesCount:z}=st(n=>n.runtime),T=Jt(),{height:h,width:k}=Xt(T),i=!c.RMP_CLOUD&&M+1>Ut,m=!c.RMP_CLOUD&&z+1>Yt,C=!c.RMP_CLOUD||d==="none";L.useEffect(()=>{const n=te(e.current);Object.entries(n).filter(([p,x])=>x&&p in ee).forEach(([p])=>ne(p))},[v]);const[P,b]=L.useState({x:0,y:0}),[y,j]=L.useState({x:0,y:0}),[B,I]=L.useState({x:0,y:0}),[F,K]=L.useState({x:0,y:0}),U=W(async n=>{const{x:p,y:x}=J(n);if(s.startsWith("station")){t(Q("free"));const D=at(10),N="stn_".concat(D),w=s.slice(8),_=structuredClone(ht[w].defaultAttrs);if("color"in _&&(_.color=S),!C){const mt=await t(Dt(zt.Shmetro));if(Dt.fulfilled.match(mt)){const q=mt.payload;_.names.length>q.length?q.push(...Array(_.names.length-q.length).fill(q.at(-1))):_.names.length<q.length&&q.splice(_.names.length,q.length-_.names.length),_.names=q}}const{x:G,y:At}=V(p,x,r,u);e.current.addNode(N,{visible:!0,zIndex:0,x:X(G,5),y:X(At,5),type:w,[w]:_}),l(),o&&ut.event(ft.ADD_STATION,{type:w}),t(it(new Set([N])))}else if(s.startsWith("misc-node")){t(Q("free"));const D=at(10),N="misc_node_".concat(D),w=s.slice(10),{x:_,y:G}=V(p,x,r,u);e.current.addNode(N,{visible:!0,zIndex:0,x:X(_,5),y:X(G,5),type:w,[w]:structuredClone(yt[w].defaultAttrs)}),l(),o&&ut.event(ft.ADD_STATION,{type:w}),t(it(new Set([N])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(Q("free")),A&&t(Vt(!1))),I({x:p,y:x}),K(u),n.shiftKey||(t(lt("background")),t(St()))):s==="select"&&(b(V(p,x,r,u)),j(V(p,x,r,u)))}),ot=W(n=>{if(s==="select"){if(P.x!=0&&P.y!=0){const{x:p,y:x}=J(n);j(V(p,x,r,u))}}else if(a==="background"){const{x:p,y:x}=J(n);t(xt({x:F.x+(B.x-p)*r/100,y:F.y+(B.y-x)*r/100}))}}),rt=W(n=>{if(s==="select"){const{x:p,y:x}=J(n),{x:D,y:N}=V(p,x,r,u),w=se(e.current,P.x,P.y,D,N),_=oe(e.current,new Set(w));t(it(new Set([...n.shiftKey?f:[],...w,..._]))),t(Q("free")),b({x:0,y:0}),j({x:0,y:0})}a==="background"&&!n.shiftKey&&t(lt(void 0))}),R=W(n=>{let p=r;n.deltaY>0&&r+10<400?p=r+10:n.deltaY<0&&r-10>0&&(p=r-10),t(Mt(p));const{x,y:D}=J(n),N=n.currentTarget.getBoundingClientRect(),[w,_]=[x/N.width,D/N.height];t(xt({x:u.x+x*r/100-k*p/100*w,y:u.y+D*r/100-h*p/100*_}))}),et=W(async n=>{if(nt?n.key==="Backspace":n.key==="Delete")f.size>0&&(f.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(St()),l());else if(n.key.startsWith("Arrow")){const x=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,D=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(xt(V(100*x,100*D,r,u)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const x=(n.key==="j"?-1:n.key==="l"?1:0)*10,D=(n.key==="i"?-1:n.key==="k"?1:0)*10;f.size>0&&f.forEach(N=>{e.current.hasNode(N)&&(e.current.updateNodeAttribute(N,"x",w=>(w!=null?w:0)+x),e.current.updateNodeAttribute(N,"y",w=>(w!=null?w:0)+D),l())})}else if(n.key==="f"&&g)t(Q(g));else if(n.key==="z"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey))nt&&n.preventDefault(),t(Qt()),t(dt()),t(ct());else if(n.key==="s")t(Q("select"));else if((n.key==="c"||n.key==="x")&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=Gt(e.current,f);navigator.clipboard.writeText(p),n.key==="x"&&(t(St()),f.forEach(x=>{e.current.hasNode(x)?e.current.dropNode(x):e.current.hasEdge(x)&&e.current.dropEdge(x)}),l())}else if(n.key==="v"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x,y:D}=V(k/2,h/2,r,u),{nodes:N,edges:w}=qt(p,e.current,i,m,X(x,5),X(D,5));l();const _=structuredClone(N);w.forEach(G=>_.add(G)),t(it(_))}else(nt&&n.key==="z"&&n.metaKey&&n.shiftKey||!nt&&n.key==="y"&&n.ctrlKey)&&(t(Zt()),t(dt()),t(ct()))}),[H,$]=L.useState(0),Y=W(n=>{if(n.touches.length===2){t(lt(void 0));const[p,x]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];$(p*p+x*x)}}),pt=W(n=>{if(H!==0&&n.touches.length===2){const[p,x]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],D=p*p+x*x;let N=r;D-H<0&&r+10<=390?N=r+10:D-H>0&&r-10>=10&&(N=r-10),t(Mt(N)),$(D);const w=n.currentTarget.getBoundingClientRect(),[_,G]=[(n.touches[0].clientX+n.touches[1].clientX)/2-w.left,(n.touches[0].clientY+n.touches[1].clientY)/2-w.top],[At,mt]=[_/w.width,G/w.height];t(xt({x:u.x+_*r/100-k*N/100*At,y:u.y+G*r/100-h*N/100*mt}))}}),gt=W(n=>{H!==0&&$(0)}),[Z,vt]=L.useState({sx:0,sy:0,ex:0,ey:0});return L.useEffect(()=>{vt({sx:P.x<=y.x?P.x:y.x,ex:P.x>y.x?P.x:y.x,sy:P.y<=y.y?P.y:y.y,ey:P.y>y.y?P.y:y.y})},[y.x,y.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:h,width:k,viewBox:"".concat(u.x," ").concat(u.y," ").concat(k*r/100," ").concat(h*r/100),onPointerDown:U,onPointerMove:ot,onPointerUp:rt,onTouchStart:Y,onTouchMove:pt,onTouchEnd:gt,onWheel:R,tabIndex:0,onKeyDown:et,children:[E.jsx(ye,{}),s==="select"&&P.x!=0&&P.y!=0&&E.jsx("rect",{x:Z.sx,y:Z.sy,width:Z.ex-Z.sx,height:Z.ey-Z.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),E.jsx("defs",{children:E.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[E.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),E.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{ve as default};
