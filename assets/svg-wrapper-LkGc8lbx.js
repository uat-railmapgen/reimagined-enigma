import{j as N}from"./chakra-sjIlidOs.js";import{m as W,ac as ct,l as Y,f as At,a as X,ad as B,ae as q,q as St,t as at,S as Ct,b as Pt,n as lt,o as J,r as dt,E as ut,v as ft,$ as G,af as yt,ag as ht,x as H,K as Mt,F as rt,D as xt,a4 as It,a6 as jt}from"./index-02VC-mzk.js";import{b}from"./react-hBmrxY6U.js";import{u as D,e as Lt,i as _t}from"./clipboard-XVlo4TgB.js";import{s as kt,u as Tt,F as Dt,b as Kt}from"./stations-8CDLjAU2.js";import{f as Wt,a as zt,b as $t}from"./graph-wOutfblb.js";import{a as F,r as O,g as Bt,p as $,i as V}from"./helpers--8-2mJFL.js";import{m as wt}from"./misc-nodes-kc6NCwOX.js";const gt=e=>e.filterNodes((t,o)=>t.startsWith("stn")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),pt=e=>e.filterDirectedEdges((t,o,r,n,a,l,d)=>t.startsWith("line")&&o.visible&&o.reconcileId==="").sort((t,o)=>e.getEdgeAttribute(t,"zIndex")-e.getEdgeAttribute(o,"zIndex")).map(t=>{const o=e.getEdgeAttribute(t,"type"),r=e.getEdgeAttribute(t,o),n=e.getEdgeAttribute(t,"style"),a=e.getEdgeAttribute(t,n),[l,d]=e.extremities(t),u=e.getNodeAttributes(l),h=e.getNodeAttributes(d);return{edge:t,x1:u.x,y1:u.y,x2:h.x,y2:h.y,type:o,attr:r,style:n,styleAttr:a}}),mt=e=>e.filterNodes((t,o)=>t.startsWith("misc_node")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,o])=>o.visible).sort((t,o)=>t[1].zIndex-o[1].zIndex).map(([t,o])=>({node:t,visible:o.visible,zIndex:o.zIndex,x:o.x,y:o.y,type:o.type,[o.type]:o[o.type]})),Ot=e=>{const t=e.filterDirectedEdges((r,n,a,l,d,u,h)=>r.startsWith("line")&&n.reconcileId!==""),o={};for(const r of t){const n=e.getEdgeAttribute(r,"reconcileId");n in o?o[n].push(r):o[n]=[r]}return o},Ft=e=>{const t=Ot(e),o=[],r=[];return Object.values(t).forEach(n=>{var z;if(n.length===1){r.push(...n);return}const a=e.getEdgeAttribute(n.at(0),"type");if(!n.every(x=>e.getEdgeAttribute(x,"type")===a)){r.push(...n);return}const l=e.getEdgeAttribute(n.at(0),"style");if(!n.every(x=>e.getEdgeAttribute(x,"style")===l)){r.push(...n);return}const d={},u=new Set,h=new Set,g=Object.fromEntries(n.map(x=>{var U,R;const[L,K]=e.extremities(x);return d[L]=((U=d[L])!=null?U:0)+1,d[K]=((R=d[K])!=null?R:0)+1,u.add(L),h.add(K),[L,[x,K]]})),S=Array.from(u).filter(x=>d[x]===1),M=Array.from(h).filter(x=>d[x]===1);if(S.length!==1||M.length!==1){r.push(...n);return}const I=S[0],j=M[0];if(I===j){r.push(...n);return}const P=[g[I][0]];let k=g[I][1];for(let x=1;x<n.length;x=x+1){const L=(z=g[k])==null?void 0:z.at(1);if(!L){r.push(...n);return}P.push(g[k][0]),k=L}if(k!==j||P.length!==n.length){r.push(...n);return}o.push(P)}),{allReconciledLines:o,danglingLines:r}},Rt=(e,t)=>{if(!t.every(n=>e.hasEdge(n)))return;const o=t.map(n=>{var S,M,I;const[a,l]=e.extremities(n),d=e.getNodeAttributes(a),u=e.getNodeAttributes(l),h=e.getEdgeAttribute(n,"type"),g=(S=e.getEdgeAttribute(n,h))!=null?S:W[h].defaultAttrs;return(I=(M=W[h])==null?void 0:M.generatePath(d.x,u.x,d.y,u.y,g))!=null?I:"M ".concat(d.x," ").concat(d.y," L ").concat(u.x," ").concat(u.y)});let r="".concat(o[0]," ");for(let n=1;n<t.length;n=n+1)r+=o[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},vt=e=>{const{id:t,x:o,y:r,handlePointerDown:n,handlePointerMove:a,handlePointerUp:l}=e,d=b.useCallback(g=>n(t,g),[t,n]),u=b.useCallback(g=>a(t,g),[t,a]),h=b.useCallback(g=>l(t,g),[t,l]);return N.jsx("g",{id:t,transform:"translate(".concat(o-6.4," ").concat(r-6.4,")scale(0.025)"),onPointerDown:d,onPointerMove:u,onPointerUp:h,style:{cursor:"move"},children:N.jsx("path",{id:"stn_core_".concat(t),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Et=e=>{const{id:t,path:o,handleClick:r}=e,n=b.useCallback(a=>r(t,a),[t,r]);return N.jsx("path",{id:t,d:o,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:n})},it=e=>{var j,P;const{id:t,type:o,attrs:r=W[o].defaultAttrs,styleType:n,styleAttrs:a=ct[n].defaultAttrs,newLine:l,handleClick:d}=e,{x1:u,y1:h,x2:g,y2:S}=e,M=b.useMemo(()=>Vt(t,o,u,h,g,S,r),[o,JSON.stringify(r),u,g,h,S]),I=(P=(j=ct[n])==null?void 0:j.component)!=null?P:Et;return N.jsx(I,{id:t,type:o,path:M,styleAttrs:a,newLine:l,handleClick:d})},Vt=(e,t,o,r,n,a,l)=>{if(!(t in W))return"M ".concat(o," ").concat(r," L ").concat(n," ").concat(a);const d=Yt(e,t,o,r,n,a,l);if(d){const{x1:u,y1:h,x2:g,y2:S,offset:M}=d;return W[Y.Simple].generatePath(u,g,h,S,{offset:M})}return W[t].generatePath(o,n,r,a,l)},Yt=(e,t,o,r,n,a,l)=>{if(!("offsetFrom"in l)||!("offsetTo"in l)||Number.isNaN(l.offsetFrom)||Number.isNaN(l.offsetTo))return;if(l.offsetFrom===l.offsetTo)return bt(t,o,r,n,a)?{x1:o,y1:r,x2:n,y2:a,offset:l.offsetFrom}:void 0;const[d,u]=[l.offsetFrom,l.offsetTo];for(let h=0;h<Math.PI;h+=Math.PI/8)for(let g=h,S=0;S<2;S++,g+=Math.PI){const[M,I,j,P]=[Math.sin(h)*d,Math.cos(h)*d,Math.sin(g)*u,Math.cos(g)*u];if(bt(t,o+M,r+I,n+j,a+P))return{x1:o+M,y1:r+I,x2:n+j,y2:a+P,offset:0}}},bt=(e,t,o,r,n)=>!!((t===r||o===n)&&[Y.Diagonal,Y.Perpendicular].includes(e)||Math.abs((n-o)/(r-t))===1&&[Y.Diagonal,Y.RotatePerpendicular].includes(e)),Ut=()=>{const e=At(),t=b.useRef(window.graph),{telemetry:{project:o}}=X(c=>c.app),{svgViewBoxZoom:r}=X(c=>c.param),{selected:n,refresh:{nodes:a,edges:l},mode:d,active:u,keepLastPath:h,theme:g}=X(c=>c.runtime),[S,M]=b.useState({x:0,y:0}),[I,j]=b.useState({x:0,y:0}),P=D((c,y)=>{y.stopPropagation(),d==="select"&&e(B("free"));const v=y.currentTarget,{x:w,y:A}=F(y);v.setPointerCapture(y.pointerId),M({x:w,y:A}),e(q(c))}),k=D((c,y)=>{const{x:v,y:w}=F(y);d==="free"&&u===c?([...n.has(u)?[void 0]:[u],...n].filter(A=>t.current.hasNode(A)).forEach(A=>{t.current.updateNodeAttributes(A,E=>({...E,x:O(E.x-(S.x-v)*r/100,y.altKey?1:5),y:O(E.y-(S.y-w)*r/100,y.altKey?1:5)}))}),e(St()),e(at())):d.startsWith("line")&&j({x:(S.x-v)*r/100,y:(S.y-w)*r/100})}),z=D((c,y)=>{if(d.startsWith("line")){h||e(B("free"));const v=[...Object.values(Ct),Pt.Virtual],w=t.current.hasNode(u)&&v.includes(t.current.getNodeAttribute(u,"type"));["stn_core_","virtual_circle_"].forEach(E=>{var f,C;const s=(C=(f=document.elementsFromPoint(y.clientX,y.clientY)[0].attributes)==null?void 0:f.getNamedItem("id"))==null?void 0:C.value,i=s==null?void 0:s.startsWith(E);if(w&&i){const m=d.slice(5),p="line_".concat(lt(10));t.current.addDirectedEdgeWithKey(p,u,s.slice(E.length),{visible:!0,zIndex:0,type:m,[m]:structuredClone(W[m].defaultAttrs),style:J.SingleColor,[J.SingleColor]:{color:g},reconcileId:""}),o&&dt.event(ut.ADD_LINE,{type:m})}}),e(at()),e(ft(t.current.export()))}else if(d==="free"&&u){const{x:v,y:w}=F(y);S.x-v===0&&S.y-w===0?y.shiftKey?n.has(c)?e(yt(c)):e(ht(c)):n.has(c)||e(G(new Set([c]))):e(ft(t.current.export()))}e(q(void 0))}),x=D((c,y)=>{y.shiftKey||e(H()),y.shiftKey&&n.has(c)?e(yt(c)):e(ht(c))}),[L,K]=b.useState(gt(t.current)),[U,R]=b.useState(mt(t.current)),[Q,tt]=b.useState(pt(t.current)),[et,st]=b.useState([]),[nt,ot]=b.useState([]);return b.useEffect(()=>{K(gt(t.current)),R(mt(t.current))},[a]),b.useEffect(()=>{tt(pt(t.current));const{allReconciledLines:c,danglingLines:y}=Ft(t.current);st(c),ot(y)},[l]),N.jsxs(N.Fragment,{children:[nt.map(c=>{const[y,v]=t.current.extremities(c),w=t.current.getNodeAttributes(y),A=t.current.getNodeAttributes(v);return N.jsx(it,{id:c,x1:w.x,y1:w.y,x2:A.x,y2:A.y,newLine:!1,type:Y.Simple,attrs:W[Y.Simple].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:x},c)}),et.map(c=>{var s,i;const y=Rt(t.current,c);if(!y)return N.jsx(N.Fragment,{});const v=c.at(0),w=t.current.getEdgeAttribute(v,"type"),A=t.current.getEdgeAttribute(v,"style"),E=t.current.getEdgeAttribute(v,A),_=(i=(s=ct[A])==null?void 0:s.component)!=null?i:Et;return N.jsx(_,{id:v,type:w,path:y,styleAttrs:E,newLine:!1,handleClick:x},v)}),Q.map(({edge:c,x1:y,y1:v,x2:w,y2:A,type:E,attr:_,style:s,styleAttr:i})=>N.jsx(it,{id:c,x1:y,y1:v,x2:w,y2:A,newLine:!1,type:E,attrs:_,styleType:s,styleAttrs:i,handleClick:x},c)),U.map(c=>{var _,s;const{node:y,x:v,y:w,type:A}=c,E=(s=(_=wt[A])==null?void 0:_.component)!=null?s:vt;return N.jsx(E,{id:y,x:v,y:w,attrs:c[A],handlePointerDown:P,handlePointerMove:k,handlePointerUp:z},y)}),L.map(c=>{var _,s;const{node:y,x:v,y:w,type:A}=c,E=(s=(_=kt[A])==null?void 0:_.component)!=null?s:vt;return N.jsx(E,{id:y,x:v,y:w,attrs:{[A]:c[A]},handlePointerDown:P,handlePointerMove:k,handlePointerUp:z},y)}),d.startsWith("line")&&u&&u!=="background"&&N.jsx(it,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(u,"x"),y1:t.current.getNodeAttribute(u,"y"),x2:t.current.getNodeAttribute(u,"x")-I.x,y2:t.current.getNodeAttribute(u,"y")-I.y,newLine:!0,type:d.slice(5),attrs:W[d.slice(5)].defaultAttrs,styleType:J.SingleColor,styleAttrs:{color:g}})]})},ee=()=>{const e=At(),t=b.useRef(window.graph),o=()=>{e(St()),e(at()),e(ft(t.current.export()))},{telemetry:{project:r}}=X(s=>s.app),{svgViewBoxZoom:n,svgViewBoxMin:a}=X(s=>s.param),{mode:l,lastTool:d,active:u,selected:h,keepLastPath:g,theme:S,refresh:{nodes:M}}=X(s=>s.runtime),I=Tt(),{height:j,width:P}=Bt(I);b.useEffect(()=>{const s=Wt(t.current);Object.entries(s).filter(([i,f])=>f&&i in Dt).forEach(([i])=>Kt(i))},[M]);const[k,z]=b.useState({x:0,y:0}),[x,L]=b.useState({x:0,y:0}),[K,U]=b.useState({x:0,y:0}),[R,Q]=b.useState({x:0,y:0}),tt=D(s=>{const{x:i,y:f}=F(s);if(l.startsWith("station")){e(B("free"));const C=lt(10),m="stn_".concat(C),p=l.slice(8),T=structuredClone(kt[p].defaultAttrs);"color"in T&&(T.color=S);const{x:Z,y:Nt}=$(i,f,n,a);t.current.addNode(m,{visible:!0,zIndex:0,x:O(Z,5),y:O(Nt,5),type:p,[p]:T}),o(),r&&dt.event(ut.ADD_STATION,{type:p}),e(G(new Set([m])))}else if(l.startsWith("misc-node")){e(B("free"));const C=lt(10),m="misc_node_".concat(C),p=l.slice(10),{x:T,y:Z}=$(i,f,n,a);t.current.addNode(m,{visible:!0,zIndex:0,x:O(T,5),y:O(Z,5),type:p,[p]:structuredClone(wt[p].defaultAttrs)}),o(),r&&dt.event(ut.ADD_STATION,{type:p}),e(G(new Set([m])))}else l==="free"||l.startsWith("line")?(l.startsWith("line")&&(e(B("free")),g&&e(Mt(!1))),U({x:i,y:f}),Q(a),s.shiftKey||(e(q("background")),e(H()))):l==="select"&&(z($(i,f,n,a)),L($(i,f,n,a)))}),et=D(s=>{if(l==="select"){if(k.x!=0&&k.y!=0){const{x:i,y:f}=F(s);L($(i,f,n,a))}}else if(u==="background"){const{x:i,y:f}=F(s);e(rt({x:R.x+(K.x-i)*n/100,y:R.y+(K.y-f)*n/100}))}}),st=D(s=>{if(l==="select"){const{x:i,y:f}=F(s),{x:C,y:m}=$(i,f,n,a),p=zt(t.current,k.x,k.y,C,m),T=$t(t.current,new Set(p));e(G(new Set([...s.shiftKey?h:[],...p,...T]))),e(B("free")),z({x:0,y:0}),L({x:0,y:0})}u==="background"&&!s.shiftKey&&e(q(void 0))}),nt=D(s=>{let i=n;s.deltaY>0&&n+10<400?i=n+10:s.deltaY<0&&n-10>0&&(i=n-10),e(xt(i));const{x:f,y:C}=F(s),m=s.currentTarget.getBoundingClientRect(),[p,T]=[f/m.width,C/m.height];e(rt({x:a.x+f*n/100-P*i/100*p,y:a.y+C*n/100-j*i/100*T}))}),ot=D(async s=>{if(V?s.key==="Backspace":s.key==="Delete")h.size>0&&(h.forEach(i=>{t.current.hasNode(i)?t.current.dropNode(i):t.current.hasEdge(i)&&t.current.dropEdge(i)}),e(H()),o());else if(s.key.startsWith("Arrow")){const f=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,C=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;e(rt($(100*f,100*C,n,a)))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const f=(s.key==="j"?-1:s.key==="l"?1:0)*10,C=(s.key==="i"?-1:s.key==="k"?1:0)*10;h.size>0&&h.forEach(m=>{t.current.hasNode(m)&&(t.current.updateNodeAttribute(m,"x",p=>(p!=null?p:0)+f),t.current.updateNodeAttribute(m,"y",p=>(p!=null?p:0)+C),o())})}else if(s.key==="f"&&d)e(B(d));else if(s.key==="z"&&(V?s.metaKey&&!s.shiftKey:s.ctrlKey))V&&s.preventDefault(),e(It());else if(s.key==="s")e(B("select"));else if((s.key==="c"||s.key==="x")&&(V?s.metaKey&&!s.shiftKey:s.ctrlKey)){const i=Lt(t.current,h);navigator.clipboard.writeText(i),s.key==="x"&&(e(H()),h.forEach(f=>{t.current.hasNode(f)?t.current.dropNode(f):t.current.hasEdge(f)&&t.current.dropEdge(f)}),o())}else if(s.key==="v"&&(V?s.metaKey&&!s.shiftKey:s.ctrlKey)){const i=await navigator.clipboard.readText(),{x:f,y:C}=$(P/2,j/2,n,a),{nodes:m,edges:p}=_t(i,t.current,O(f,5),O(C,5));o();const T=structuredClone(m);p.forEach(Z=>T.add(Z)),e(G(T))}else(V&&s.key==="z"&&s.metaKey&&s.shiftKey||!V&&s.key==="y"&&s.ctrlKey)&&e(jt())}),[c,y]=b.useState(0),v=D(s=>{if(s.touches.length===2){e(q(void 0));const[i,f]=[s.touches[0].clientX-s.touches[1].clientX,s.touches[0].clientY-s.touches[1].clientY];y(i*i+f*f)}}),w=D(s=>{if(c!==0&&s.touches.length===2){const[i,f]=[s.touches[0].clientX-s.touches[1].clientX,s.touches[0].clientY-s.touches[1].clientY],C=i*i+f*f;let m=n;C-c<0&&n+10<=390?m=n+10:C-c>0&&n-10>=10&&(m=n-10),e(xt(m))}}),A=D(s=>{c!==0&&y(0)}),[E,_]=b.useState({sx:0,sy:0,ex:0,ey:0});return b.useEffect(()=>{_({sx:k.x<=x.x?k.x:x.x,ex:k.x>x.x?k.x:x.x,sy:k.y<=x.y?k.y:x.y,ey:k.y>x.y?k.y:x.y})},[x.x,x.y]),N.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:j,width:P,viewBox:"".concat(a.x," ").concat(a.y," ").concat(P*n/100," ").concat(j*n/100),onPointerDown:tt,onPointerMove:et,onPointerUp:st,onTouchStart:v,onTouchMove:w,onTouchEnd:A,onWheel:nt,tabIndex:0,onKeyDown:ot,children:[N.jsx(Ut,{}),l==="select"&&k.x!=0&&k.y!=0&&N.jsx("rect",{x:E.sx,y:E.sy,width:E.ex-E.sx,height:E.ey-E.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),N.jsx("defs",{children:N.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[N.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),N.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{ee as default};
