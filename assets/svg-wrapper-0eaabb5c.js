import{j as E}from"./chakra-594c63ee.js";import{t as j,N as nt,q as z,j as pt,d as T,ag as H,D as R,ah as J,y as ht,z as rt,af as F,S as bt,e as vt,p as ot,v as Y,r as it,E as ct,A as at,Q as wt,K as tt,J as St,a4 as Et,ai as Nt,a6 as kt}from"./index-f832bde9.js";import{r as ut,b as A}from"./react-2c0b8364.js";import{u as P,e as Lt,i as It}from"./clipboard-19334262.js";import{b as O,r as M,F as q,a as C}from"./helpers-b99d4bad.js";import{f as Pt,a as _t}from"./graph-d9568952.js";import{s as xt}from"./stations-21bc710e.js";import{m as mt}from"./misc-nodes-226fdb35.js";const jt=()=>{const[e,t]=ut.useState({width:void 0,height:void 0});return ut.useEffect(()=>{function s(){t({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",s),s(),()=>window.removeEventListener("resize",s)},[]),e},et=e=>{const{id:t,type:s,attrs:d=j[s].defaultAttrs,styleType:n,styleAttrs:y=nt[n].defaultAttrs,newLine:x,handleClick:f}=e,{x1:u,y1:g,x2:b,y2:m}=e,[I,N]=A.useState("M 0,0 L 0,0");A.useEffect(()=>{let v="M 0,0 L 0,0";if(["offsetFrom","offsetTo"].every(w=>Object.keys(d).includes(w))&&!Number.isNaN(d.offsetFrom)&&!Number.isNaN(d.offsetTo)&&d.offsetFrom===d.offsetTo&&((u===b||g===m)&&[z.Diagonal,z.Perpendicular].includes(s)||Math.abs((m-g)/(b-u))===1&&[z.Diagonal,z.RotatePerpendicular].includes(s))){const w=d.offsetFrom;v=j[z.Simple].generatePath(u,b,g,m,{offset:w})}else v=j[s].generatePath(u,b,g,m,d);N(v)},[s,JSON.stringify(d),u,b,g,m]);const k=nt[n].component;return A.useMemo(()=>E.jsx(k,{id:t,type:s,path:I,styleAttrs:y,newLine:x,handleClick:f}),[t,s,I,n,JSON.stringify(y),x,f])},Wt=e=>{const t=e.filterDirectedEdges((d,n,y,x,f,u,g)=>d.startsWith("line")&&n.reconcileId!==""),s={};for(const d of t){const n=e.getEdgeAttribute(d,"reconcileId");n in s?s[n].push(d):s[n]=[d]}return s},ft=e=>{const t=Wt(e),s=[],d=[];return Object.values(t).forEach(n=>{var W;if(n.length===1){d.push(...n);return}const y=e.getEdgeAttribute(n.at(0),"type");if(!n.every(p=>e.getEdgeAttribute(p,"type")===y)){d.push(...n);return}const x=e.getEdgeAttribute(n.at(0),"style");if(!n.every(p=>e.getEdgeAttribute(p,"style")===x)){d.push(...n);return}const f={},u=new Set,g=new Set,b=Object.fromEntries(n.map(p=>{var D,K;const[L,_]=e.extremities(p);return f[L]=((D=f[L])!=null?D:0)+1,f[_]=((K=f[_])!=null?K:0)+1,u.add(L),g.add(_),[L,[p,_]]})),m=Array.from(u).filter(p=>f[p]===1),I=Array.from(g).filter(p=>f[p]===1);if(m.length!==1||I.length!==1){d.push(...n);return}const N=m[0],k=I[0];if(N===k){d.push(...n);return}const v=[b[N][0]];let w=b[N][1];for(let p=1;p<n.length;p=p+1){const L=(W=b[w])==null?void 0:W.at(1);if(!L){d.push(...n);return}v.push(b[w][0]),w=L}if(w!==k||v.length!==n.length){d.push(...n);return}s.push(v)}),{allReconciledLines:s,danglingLines:d}},Ct=(e,t)=>{if(!t.every(n=>e.hasEdge(n)))return;const s=t.map(n=>{var m;const[y,x]=e.extremities(n),f=e.getNodeAttributes(y),u=e.getNodeAttributes(x),g=e.getEdgeAttribute(n,"type"),b=(m=e.getEdgeAttribute(n,g))!=null?m:j[g].defaultAttrs;return j[g].generatePath(f.x,u.x,f.y,u.y,b)});let d=`${s[0]} `;for(let n=1;n<t.length;n=n+1)d+=s[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},yt=e=>e.filterNodes((t,s)=>t.startsWith("stn")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,s])=>s.visible).sort((t,s)=>t[1].zIndex-s[1].zIndex).map(([t,s])=>({node:t,visible:s.visible,zIndex:s.zIndex,x:s.x,y:s.y,type:s.type,[s.type]:s[s.type]})),st=e=>e.filterDirectedEdges((t,s,d,n,y,x,f)=>t.startsWith("line")&&s.visible&&s.reconcileId==="").sort((t,s)=>e.getEdgeAttribute(t,"zIndex")-e.getEdgeAttribute(s,"zIndex")).map(t=>{const s=e.getEdgeAttribute(t,"type"),d=e.getEdgeAttribute(t,s),n=e.getEdgeAttribute(t,"style"),y=e.getEdgeAttribute(t,n),[x,f]=e.extremities(t),u=e.getNodeAttributes(x),g=e.getNodeAttributes(f);return{edge:t,x1:u.x,y1:u.y,x2:g.x,y2:g.y,type:s,attr:d,style:n,styleAttr:y}}),gt=e=>e.filterNodes((t,s)=>t.startsWith("misc_node")).map(t=>[t,e.getNodeAttributes(t)]).filter(([t,s])=>s.visible).sort((t,s)=>t[1].zIndex-s[1].zIndex).map(([t,s])=>({node:t,visible:s.visible,zIndex:s.zIndex,x:s.x,y:s.y,type:s.type,[s.type]:s[s.type]})),zt=()=>{const e=pt(),t=A.useRef(window.graph),{telemetry:{project:s}}=T(r=>r.app),{svgViewBoxZoom:d}=T(r=>r.param),{selected:n,refresh:{nodes:y,edges:x},mode:f,active:u,keepLastPath:g,theme:b}=T(r=>r.runtime),[m,I]=A.useState({x:0,y:0}),[N,k]=A.useState({x:0,y:0}),v=P((r,i)=>{i.stopPropagation();const a=i.currentTarget,{x:l,y:h}=O(i);a.setPointerCapture(i.pointerId),I({x:l,y:h}),e(H(r)),!i.shiftKey&&n.length<=1&&e(R()),e(J(r))}),w=P((r,i)=>{i.stopPropagation();const{x:a,y:l}=O(i);f==="free"&&u===r?(n.forEach(h=>{t.current.updateNodeAttributes(h,S=>({...S,x:M(S.x-(m.x-a)*d/100,i.altKey?1:5),y:M(S.y-(m.y-l)*d/100,i.altKey?1:5)}))}),e(ht()),e(rt())):f.startsWith("line")&&k({x:(m.x-a)*d/100,y:(m.y-l)*d/100})}),W=P((r,i)=>{if(i.stopPropagation(),f.startsWith("line")){g||e(F("free"));const a=[...Object.values(bt),vt.Virtual],l=t.current.hasNode(u)&&a.includes(t.current.getNodeAttribute(u,"type"));["stn_core_","virtual_circle_"].forEach(S=>{var dt,lt;const B=(lt=(dt=document.elementsFromPoint(i.clientX,i.clientY)[0].attributes)==null?void 0:dt.getNamedItem("id"))==null?void 0:lt.value,X=B==null?void 0:B.startsWith(S);if(l&&X){const G=f.slice(5),At=`line_${ot(10)}`;t.current.addDirectedEdgeWithKey(At,u,B.slice(S.length),{visible:!0,zIndex:0,type:G,[G]:structuredClone(j[G].defaultAttrs),style:Y.SingleColor,[Y.SingleColor]:{color:b},reconcileId:""}),s&&it.event(ct.ADD_LINE,{type:G})}}),e(rt()),e(at(t.current.export()))}else if(f==="free")if(u){const{x:a,y:l}=O(i);m.x-a===0&&m.y-l===0?e(J(r)):e(at(t.current.export()))}else e(J(r));e(H(void 0))}),p=P((r,i)=>{e(R()),e(J(r))}),[L,_]=A.useState(yt(t.current)),[D,K]=A.useState(gt(t.current)),[Q,V]=A.useState(st(t.current)),[U,$]=A.useState([]),[o,c]=A.useState([]);return A.useEffect(()=>{_(yt(t.current)),K(gt(t.current))},[y]),A.useEffect(()=>{V(st(t.current));const{allReconciledLines:r,danglingLines:i}=ft(t.current);$(r),c(i)},[]),A.useEffect(()=>{V(st(t.current));const{allReconciledLines:r,danglingLines:i}=ft(t.current);$(r),c(i)},[x]),E.jsxs(E.Fragment,{children:[o.map(r=>{const[i,a]=t.current.extremities(r),l=t.current.getNodeAttributes(i),h=t.current.getNodeAttributes(a);return E.jsx(et,{id:r,x1:l.x,y1:l.y,x2:h.x,y2:h.y,newLine:!1,type:z.Simple,attrs:j[z.Simple].defaultAttrs,styleType:Y.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:p},r)}),U.map(r=>{const i=Ct(t.current,r);if(!i)return E.jsx(E.Fragment,{});const a=r.at(0),l=t.current.getEdgeAttribute(a,"type"),h=t.current.getEdgeAttribute(a,"style"),S=t.current.getEdgeAttribute(a,h),Z=nt[h].component;return E.jsx(Z,{id:a,type:l,path:i,styleAttrs:S,newLine:!1,handleClick:p},a)}),Q.map(({edge:r,x1:i,y1:a,x2:l,y2:h,type:S,attr:Z,style:B,styleAttr:X})=>E.jsx(et,{id:r,x1:i,y1:a,x2:l,y2:h,newLine:!1,type:S,attrs:Z,styleType:B,styleAttrs:X,handleClick:p},r)),D.map(r=>{const{node:i,x:a,y:l,type:h}=r,S=mt[h].component;return E.jsx(S,{id:i,x:a,y:l,attrs:r[h],handlePointerDown:v,handlePointerMove:w,handlePointerUp:W},i)}),L.map(r=>{const{node:i,x:a,y:l,type:h}=r,S=xt[h].component;return E.jsx(S,{id:i,x:a,y:l,attrs:{[h]:r[h]},handlePointerDown:v,handlePointerMove:w,handlePointerUp:W},i)}),f.startsWith("line")&&u&&E.jsx(et,{id:"create_in_progress___no_use",x1:t.current.getNodeAttribute(u,"x"),y1:t.current.getNodeAttribute(u,"y"),x2:t.current.getNodeAttribute(u,"x")-N.x,y2:t.current.getNodeAttribute(u,"y")-N.y,newLine:!0,type:f.slice(5),attrs:j[f.slice(5)].defaultAttrs,styleType:Y.SingleColor,styleAttrs:{color:b}})]})},Rt=()=>{var U,$;const e=pt(),t=A.useRef(window.graph),s=()=>{e(ht()),e(rt()),e(at(t.current.export()))},{telemetry:{project:d}}=T(o=>o.app),{svgViewBoxZoom:n,svgViewBoxMin:y}=T(o=>o.param),{mode:x,lastTool:f,active:u,selected:g,keepLastPath:b,theme:m,refresh:{nodes:I}}=T(o=>o.runtime),N=jt(),k=((U=N.height)!=null?U:1280)-40,v=(($=N.width)!=null?$:720)-40;A.useEffect(()=>{const o=Pt(t.current);Object.entries(o).filter(([c,r])=>r&&c in q).map(([c,r])=>c).filter(c=>q[c]&&document.getElementById(q[c].cssName)===null).map(c=>q[c].cssName).filter((c,r,i)=>r===i.findIndex(a=>a===c)).forEach(c=>{const r=document.createElement("link");r.rel="stylesheet",r.id=c,r.href=`/rmp/styles/${c}.css`,document.head.append(r)})},[I]);const[w,W]=A.useState({x:0,y:0}),[p,L]=A.useState({x:0,y:0}),_=P(o=>{const{x:c,y:r}=O(o);if(x.startsWith("station")){e(F("free"));const i=ot(10),a=x.slice(8),l=structuredClone(xt[a].defaultAttrs);"color"in l&&(l.color=m),t.current.addNode(`stn_${i}`,{visible:!0,zIndex:0,x:M(c*n/100+y.x,10),y:M(r*n/100+y.y,10),type:a,[a]:l}),s(),d&&it.event(ct.ADD_STATION,{type:a})}else if(x.startsWith("misc-node")){e(F("free"));const i=ot(10),a=x.slice(10);t.current.addNode(`misc_node_${i}`,{visible:!0,zIndex:0,x:M(c*n/100+y.x,10),y:M(r*n/100+y.y,10),type:a,[a]:structuredClone(mt[a].defaultAttrs)}),s(),d&&it.event(ct.ADD_STATION,{type:a})}else(x==="free"||x.startsWith("line"))&&(x.startsWith("line")&&(e(F("free")),b&&e(wt(!1))),W({x:c,y:r}),L(y),o.shiftKey||(e(H("background")),e(R())))}),D=P(o=>{if(u==="background"){const{x:c,y:r}=O(o);e(tt({x:p.x+(w.x-c)*n/100,y:p.y+(w.y-r)*n/100}))}}),K=P(o=>{u==="background"&&!o.shiftKey&&e(H(void 0))}),Q=P(o=>{let c=n;o.deltaY>0&&n+10<400?c=n+10:o.deltaY<0&&n-10>0&&(c=n-10),e(St(c));const{x:r,y:i}=O(o),a=o.currentTarget.getBoundingClientRect(),[l,h]=[r/a.width,i/a.height];e(tt({x:y.x+r*n/100-v*c/100*l,y:y.y+i*n/100-k*c/100*h}))}),V=P(async o=>{if(C?o.key==="Backspace":o.key==="Delete")g.length>0&&g.filter(c=>t.current.hasNode(c)||t.current.hasEdge(c)).forEach(c=>{e(R()),t.current.hasNode(c)?t.current.dropNode(c):t.current.dropEdge(c),s()});else if(o.key.startsWith("Arrow")){const r=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,i=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(tt({x:y.x+100*n/100*r,y:y.y+100*n/100*i}))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const r=(o.key==="j"?-1:o.key==="l"?1:0)*10,i=(o.key==="i"?-1:o.key==="k"?1:0)*10;g.length>0&&g.filter(a=>t.current.hasNode(a)).forEach(a=>{t.current.updateNodeAttribute(a,"x",l=>(l!=null?l:0)+r),t.current.updateNodeAttribute(a,"y",l=>(l!=null?l:0)+i),s()})}else if(o.key==="f"&&f)e(F(f));else if(o.key==="z"&&(C?o.metaKey&&!o.shiftKey:o.ctrlKey))C&&o.preventDefault(),e(Et());else if(o.key==="c"&&(C?o.metaKey&&!o.shiftKey:o.ctrlKey)){const c=new Set(g),r=_t(t.current,c),i=Lt(t.current,c,new Set(r));navigator.clipboard.writeText(i)}else if(o.key==="v"&&(C?o.metaKey&&!o.shiftKey:o.ctrlKey)){const c=await navigator.clipboard.readText(),{nodes:r}=It(c,t.current,v*n/200+y.x,k*n/200+y.y);s(),e(R()),e(Nt(r))}else(C&&o.key==="z"&&o.metaKey&&o.shiftKey||!C&&o.key==="y"&&o.ctrlKey)&&e(kt())});return E.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:k,width:v,viewBox:`${y.x} ${y.y} ${v*n/100} ${k*n/100}`,onPointerDown:_,onPointerMove:D,onPointerUp:K,onWheel:Q,tabIndex:0,onKeyDown:V,children:E.jsx(zt,{})})};export{Rt as default};
