import{j as k}from"./chakra-594c63ee.js";import{t as D,N as ie,q as B,i as pe,j as $,ae as T,af as Q,D as F,ag as Y,y as he,z as ce,S as ve,d as Se,p as ae,v as q,r as de,E as le,A as ue,Q as we,K as se,ah as ne,J as Ee,a4 as Ne,a6 as ke}from"./index-107406f9.js";import{r as ye,b as v}from"./react-2c0b8364.js";import{u as P,e as Le,i as Ie}from"./clipboard-d8465acc.js";import{b as z,r as R,F as H,a as M}from"./helpers-5617d6b1.js";import{f as _e,a as je,b as Ce}from"./graph-9d479233.js";import{s as me}from"./stations-bc83e5f8.js";import{m as Ae}from"./misc-nodes-a6d3f271.js";const Pe=()=>{const[t,e]=ye.useState({width:void 0,height:void 0});return ye.useEffect(()=>{function r(){e({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",r),r(),()=>window.removeEventListener("resize",r)},[]),t},re=t=>{const{id:e,type:r,attrs:c=D[r].defaultAttrs,styleType:n,styleAttrs:d=ie[n].defaultAttrs,newLine:h,handleClick:u}=t,{x1:y,y1:g,x2:w,y2:S}=t,[j,I]=v.useState("M 0,0 L 0,0");v.useEffect(()=>{let N="M 0,0 L 0,0";if(["offsetFrom","offsetTo"].every(x=>Object.keys(c).includes(x))&&!Number.isNaN(c.offsetFrom)&&!Number.isNaN(c.offsetTo)&&c.offsetFrom===c.offsetTo&&((y===w||g===S)&&[B.Diagonal,B.Perpendicular].includes(r)||Math.abs((S-g)/(w-y))===1&&[B.Diagonal,B.RotatePerpendicular].includes(r))){const x=c.offsetFrom;N=D[B.Simple].generatePath(y,w,g,S,{offset:x})}else N=D[r].generatePath(y,w,g,S,c);I(N)},[r,JSON.stringify(c),y,w,g,S]);const _=ie[n].component;return v.useMemo(()=>k.jsx(_,{id:e,type:r,path:j,styleAttrs:d,newLine:h,handleClick:u}),[e,r,j,n,JSON.stringify(d),h,u])},We=t=>{const e=t.filterDirectedEdges((c,n,d,h,u,y,g)=>c.startsWith("line")&&n.reconcileId!==""),r={};for(const c of e){const n=t.getEdgeAttribute(c,"reconcileId");n in r?r[n].push(c):r[n]=[c]}return r},fe=t=>{const e=We(t),r=[],c=[];return Object.values(e).forEach(n=>{var W;if(n.length===1){c.push(...n);return}const d=t.getEdgeAttribute(n.at(0),"type");if(!n.every(f=>t.getEdgeAttribute(f,"type")===d)){c.push(...n);return}const h=t.getEdgeAttribute(n.at(0),"style");if(!n.every(f=>t.getEdgeAttribute(f,"style")===h)){c.push(...n);return}const u={},y=new Set,g=new Set,w=Object.fromEntries(n.map(f=>{var O,K;const[L,C]=t.extremities(f);return u[L]=((O=u[L])!=null?O:0)+1,u[C]=((K=u[C])!=null?K:0)+1,y.add(L),g.add(C),[L,[f,C]]})),S=Array.from(y).filter(f=>u[f]===1),j=Array.from(g).filter(f=>u[f]===1);if(S.length!==1||j.length!==1){c.push(...n);return}const I=S[0],_=j[0];if(I===_){c.push(...n);return}const N=[w[I][0]];let x=w[I][1];for(let f=1;f<n.length;f=f+1){const L=(W=w[x])==null?void 0:W.at(1);if(!L){c.push(...n);return}N.push(w[x][0]),x=L}if(x!==_||N.length!==n.length){c.push(...n);return}r.push(N)}),{allReconciledLines:r,danglingLines:c}},ze=(t,e)=>{if(!e.every(n=>t.hasEdge(n)))return;const r=e.map(n=>{var S;const[d,h]=t.extremities(n),u=t.getNodeAttributes(d),y=t.getNodeAttributes(h),g=t.getEdgeAttribute(n,"type"),w=(S=t.getEdgeAttribute(n,g))!=null?S:D[g].defaultAttrs;return D[g].generatePath(u.x,y.x,u.y,y.y,w)});let c=`${r[0]} `;for(let n=1;n<e.length;n=n+1)c+=r[n].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return c},xe=t=>t.filterNodes((e,r)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),oe=t=>t.filterDirectedEdges((e,r,c,n,d,h,u)=>e.startsWith("line")&&r.visible&&r.reconcileId==="").sort((e,r)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(r,"zIndex")).map(e=>{const r=t.getEdgeAttribute(e,"type"),c=t.getEdgeAttribute(e,r),n=t.getEdgeAttribute(e,"style"),d=t.getEdgeAttribute(e,n),[h,u]=t.extremities(e),y=t.getNodeAttributes(h),g=t.getNodeAttributes(u);return{edge:e,x1:y.x,y1:y.y,x2:g.x,y2:g.y,type:r,attr:c,style:n,styleAttr:d}}),ge=t=>t.filterNodes((e,r)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,r])=>r.visible).sort((e,r)=>e[1].zIndex-r[1].zIndex).map(([e,r])=>({node:e,visible:r.visible,zIndex:r.zIndex,x:r.x,y:r.y,type:r.type,[r.type]:r[r.type]})),De=()=>{const t=pe(),e=v.useRef(window.graph),{telemetry:{project:r}}=$(i=>i.app),{svgViewBoxZoom:c}=$(i=>i.param),{selected:n,refresh:{nodes:d,edges:h},mode:u,active:y,keepLastPath:g,theme:w}=$(i=>i.runtime),[S,j]=v.useState({x:0,y:0}),[I,_]=v.useState({x:0,y:0}),N=P((i,l)=>{l.stopPropagation(),u==="select"&&t(T("free"));const p=l.currentTarget,{x:b,y:s}=z(l);p.setPointerCapture(l.pointerId),j({x:b,y:s}),t(Q(i)),!l.shiftKey&&n.length<=1&&t(F()),t(Y(i))}),x=P((i,l)=>{const{x:p,y:b}=z(l);u==="free"&&y===i?(n.forEach(s=>{e.current.updateNodeAttributes(s,o=>({...o,x:R(o.x-(S.x-p)*c/100,l.altKey?1:5),y:R(o.y-(S.y-b)*c/100,l.altKey?1:5)}))}),t(he()),t(ce())):u.startsWith("line")&&_({x:(S.x-p)*c/100,y:(S.y-b)*c/100})}),W=P((i,l)=>{if(u.startsWith("line")){g||t(T("free"));const p=[...Object.values(ve),Se.Virtual],b=e.current.hasNode(y)&&p.includes(e.current.getNodeAttribute(y,"type"));["stn_core_","virtual_circle_"].forEach(o=>{var E,G;const m=(G=(E=document.elementsFromPoint(l.clientX,l.clientY)[0].attributes)==null?void 0:E.getNamedItem("id"))==null?void 0:G.value,A=m==null?void 0:m.startsWith(o);if(b&&A){const J=u.slice(5),be=`line_${ae(10)}`;e.current.addDirectedEdgeWithKey(be,y,m.slice(o.length),{visible:!0,zIndex:0,type:J,[J]:structuredClone(D[J].defaultAttrs),style:q.SingleColor,[q.SingleColor]:{color:w},reconcileId:""}),r&&de.event(le.ADD_LINE,{type:J})}}),t(ce()),t(ue(e.current.export()))}else if(u==="free")if(y){const{x:p,y:b}=z(l);S.x-p===0&&S.y-b===0?t(Y(i)):t(ue(e.current.export()))}else t(Y(i));t(Q(void 0))}),f=P((i,l)=>{t(F()),t(Y(i))}),[L,C]=v.useState(xe(e.current)),[O,K]=v.useState(ge(e.current)),[X,V]=v.useState(oe(e.current)),[ee,U]=v.useState([]),[te,Z]=v.useState([]);return v.useEffect(()=>{C(xe(e.current)),K(ge(e.current))},[d]),v.useEffect(()=>{V(oe(e.current));const{allReconciledLines:i,danglingLines:l}=fe(e.current);U(i),Z(l)},[]),v.useEffect(()=>{V(oe(e.current));const{allReconciledLines:i,danglingLines:l}=fe(e.current);U(i),Z(l)},[h]),k.jsxs(k.Fragment,{children:[te.map(i=>{const[l,p]=e.current.extremities(i),b=e.current.getNodeAttributes(l),s=e.current.getNodeAttributes(p);return k.jsx(re,{id:i,x1:b.x,y1:b.y,x2:s.x,y2:s.y,newLine:!1,type:B.Simple,attrs:D[B.Simple].defaultAttrs,styleType:q.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:f},i)}),ee.map(i=>{const l=ze(e.current,i);if(!l)return k.jsx(k.Fragment,{});const p=i.at(0),b=e.current.getEdgeAttribute(p,"type"),s=e.current.getEdgeAttribute(p,"style"),o=e.current.getEdgeAttribute(p,s),a=ie[s].component;return k.jsx(a,{id:p,type:b,path:l,styleAttrs:o,newLine:!1,handleClick:f},p)}),X.map(({edge:i,x1:l,y1:p,x2:b,y2:s,type:o,attr:a,style:m,styleAttr:A})=>k.jsx(re,{id:i,x1:l,y1:p,x2:b,y2:s,newLine:!1,type:o,attrs:a,styleType:m,styleAttrs:A,handleClick:f},i)),O.map(i=>{const{node:l,x:p,y:b,type:s}=i,o=Ae[s].component;return k.jsx(o,{id:l,x:p,y:b,attrs:i[s],handlePointerDown:N,handlePointerMove:x,handlePointerUp:W},l)}),L.map(i=>{const{node:l,x:p,y:b,type:s}=i,o=me[s].component;return k.jsx(o,{id:l,x:p,y:b,attrs:{[s]:i[s]},handlePointerDown:N,handlePointerMove:x,handlePointerUp:W},l)}),u.startsWith("line")&&y&&k.jsx(re,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(y,"x"),y1:e.current.getNodeAttribute(y,"y"),x2:e.current.getNodeAttribute(y,"x")-I.x,y2:e.current.getNodeAttribute(y,"y")-I.y,newLine:!0,type:u.slice(5),attrs:D[u.slice(5)].defaultAttrs,styleType:q.SingleColor,styleAttrs:{color:w}})]})},Ve=()=>{var p,b;const t=pe(),e=v.useRef(window.graph),r=()=>{t(he()),t(ce()),t(ue(e.current.export()))},{telemetry:{project:c}}=$(s=>s.app),{svgViewBoxZoom:n,svgViewBoxMin:d}=$(s=>s.param),{mode:h,lastTool:u,active:y,selected:g,keepLastPath:w,theme:S,refresh:{nodes:j}}=$(s=>s.runtime),I=Pe(),_=((p=I.height)!=null?p:1280)-40,N=((b=I.width)!=null?b:720)-40;v.useEffect(()=>{const s=_e(e.current);Object.entries(s).filter(([o,a])=>a&&o in H).map(([o,a])=>o).filter(o=>H[o]&&document.getElementById(H[o].cssName)===null).map(o=>H[o].cssName).filter((o,a,m)=>a===m.findIndex(A=>A===o)).forEach(o=>{const a=document.createElement("link");a.rel="stylesheet",a.id=o,a.href=`/rmp/styles/${o}.css`,document.head.append(a)})},[j]);const[x,W]=v.useState({x:0,y:0}),[f,L]=v.useState({x:0,y:0}),[C,O]=v.useState({x:0,y:0}),[K,X]=v.useState({x:0,y:0}),V=P(s=>{const{x:o,y:a}=z(s);if(h.startsWith("station")){t(T("free"));const m=ae(10),A=h.slice(8),E=structuredClone(me[A].defaultAttrs);"color"in E&&(E.color=S),e.current.addNode(`stn_${m}`,{visible:!0,zIndex:0,x:R(o*n/100+d.x,10),y:R(a*n/100+d.y,10),type:A,[A]:E}),r(),c&&de.event(le.ADD_STATION,{type:A})}else if(h.startsWith("misc-node")){t(T("free"));const m=ae(10),A=h.slice(10);e.current.addNode(`misc_node_${m}`,{visible:!0,zIndex:0,x:R(o*n/100+d.x,10),y:R(a*n/100+d.y,10),type:A,[A]:structuredClone(Ae[A].defaultAttrs)}),r(),c&&de.event(le.ADD_STATION,{type:A})}else h==="free"||h.startsWith("line")?(h.startsWith("line")&&(t(T("free")),w&&t(we(!1))),O({x:o,y:a}),X(d),s.shiftKey||(t(Q("background")),t(F()))):h==="select"&&(W({x:o*n/100+d.x,y:a*n/100+d.y}),L({x:o*n/100+d.x,y:a*n/100+d.y}))}),ee=P(s=>{if(h==="select"){if(x.x!=0&&x.y!=0){const{x:o,y:a}=z(s);L({x:o*n/100+d.x,y:a*n/100+d.y})}}else if(y==="background"){const{x:o,y:a}=z(s);t(se({x:K.x+(C.x-o)*n/100,y:K.y+(C.y-a)*n/100}))}}),U=P(s=>{if(h==="select"){const{x:o,y:a}=z(s),m=je(e.current,x.x,x.y,o*n/100+d.x,a*n/100+d.y);s.shiftKey?t(ne([...new Set([...g,...m])])):t(ne(m)),t(T("free")),W({x:0,y:0}),L({x:0,y:0})}y==="background"&&!s.shiftKey&&t(Q(void 0))}),te=P(s=>{let o=n;s.deltaY>0&&n+10<400?o=n+10:s.deltaY<0&&n-10>0&&(o=n-10),t(Ee(o));const{x:a,y:m}=z(s),A=s.currentTarget.getBoundingClientRect(),[E,G]=[a/A.width,m/A.height];t(se({x:d.x+a*n/100-N*o/100*E,y:d.y+m*n/100-_*o/100*G}))}),Z=P(async s=>{if(M?s.key==="Backspace":s.key==="Delete")g.length>0&&g.filter(o=>e.current.hasNode(o)||e.current.hasEdge(o)).forEach(o=>{t(F()),e.current.hasNode(o)?e.current.dropNode(o):e.current.dropEdge(o),r()});else if(s.key.startsWith("Arrow")){const a=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,m=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;t(se({x:d.x+100*n/100*a,y:d.y+100*n/100*m}))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const a=(s.key==="j"?-1:s.key==="l"?1:0)*10,m=(s.key==="i"?-1:s.key==="k"?1:0)*10;g.length>0&&g.filter(A=>e.current.hasNode(A)).forEach(A=>{e.current.updateNodeAttribute(A,"x",E=>(E!=null?E:0)+a),e.current.updateNodeAttribute(A,"y",E=>(E!=null?E:0)+m),r()})}else if(s.key==="f"&&u)t(T(u));else if(s.key==="z"&&(M?s.metaKey&&!s.shiftKey:s.ctrlKey))M&&s.preventDefault(),t(Ne());else if(s.key==="c"&&(M?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=new Set(g),a=Ce(e.current,o),m=Le(e.current,o,new Set(a));navigator.clipboard.writeText(m)}else if(s.key==="v"&&(M?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=await navigator.clipboard.readText(),{nodes:a}=Ie(o,e.current,N*n/200+d.x,_*n/200+d.y);r(),t(F()),t(ne(a))}else(M&&s.key==="z"&&s.metaKey&&s.shiftKey||!M&&s.key==="y"&&s.ctrlKey)&&t(ke())}),[i,l]=v.useState({sx:0,sy:0,ex:0,ey:0});return v.useEffect(()=>{l({sx:x.x<=f.x?x.x:f.x,ex:x.x>f.x?x.x:f.x,sy:x.y<=f.y?x.y:f.y,ey:x.y>f.y?x.y:f.y})},[f.x,f.y]),k.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:_,width:N,viewBox:`${d.x} ${d.y} ${N*n/100} ${_*n/100}`,onPointerDown:V,onPointerMove:ee,onPointerUp:U,onWheel:te,tabIndex:0,onKeyDown:Z,children:[k.jsx(De,{}),h==="select"&&x.x!=0&&x.y!=0&&k.jsx("rect",{x:i.sx,y:i.sy,width:i.ex-i.sx,height:i.ey-i.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"})]})};export{Ve as default};
